<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" type="text/css" href="style.css?v=1.10" />
    <script defer src="tm.js?v=1.10"></script>
    <title>Consulta del Médico</title>
    <style>
        body {
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            overflow: hidden;
            font-family: 'Courier New', Courier, monospace; /* El color de fondo ahora lo gestiona el canvas */
            user-select: none;
            -webkit-user-select: none;
        }

        #consulta-container {
            width: 95%;
            max-width: 700px;
            background: white;
            border: 2px solid #888;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            text-align: center;
        }

        h1 {
            color: #333;
            border-bottom: 2px dashed #ccc;
            padding-bottom: 10px;
        }

        #escena {
            display: flex;
            justify-content: space-around;
            align-items: flex-end;
            margin: 20px 0;
            min-height: 150px;
        }

        .personaje {
            font-size: 1.5rem;
            white-space: pre;
            line-height: 1.2;
        }

        #dialogo-box {
            border: 2px solid #333;
            background-color: #fdfdfd;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            min-height: 100px;
            text-align: left;
            font-size: 1.1rem;
            color: #444;
            position: relative;
        }

        #dialogo-texto::after {
            content: '▋';
            animation: blink 1s step-end infinite;
        }

        @keyframes blink {
            50% { opacity: 0; }
        }

        /* --- MODIFICADO: Estilo para el mensaje de continuar --- */
        #continue-prompt {
            margin-top: 20px;
            padding: 12px 25px;
            font-family: 'Courier New', Courier, monospace;
            font-weight: bold;
            font-size: 1.1rem;
            color: #555;
            display: none; /* Oculto hasta que termine el diálogo */
            background: none;
            border: none;
            animation: pulse-text 2s infinite;
        }

        /* --- ¡NUEVO! Animación para el texto de continuar --- */
        @keyframes pulse-text {
            0% {
                transform: scale(1);
                opacity: 0.8;
            }
            50% {
                transform: scale(1.05);
                opacity: 1;
            }
            100% {
                transform: scale(1);
                opacity: 0.8;
            }
        }

        /* --- ¡NUEVO! Media Query para adaptar a móviles --- */
        @media (max-width: 600px) {
            #consulta-container {
                padding: 15px;
                height: auto;
                max-height: 95vh;
                overflow-y: auto;
            }
            h1 {
                font-size: 1.5rem;
            }
            #escena {
                flex-direction: column; /* Apila los personajes verticalmente */
                align-items: center;  /* Los centra */
                gap: 20px; /* Añade espacio entre ellos */
            }
            .personaje {
                font-size: 1.3rem; /* Reduce un poco el tamaño de los personajes */
            }
        }
    </style>
</head>
<body>

    <!-- ¡NUEVO! Lienzo para el fondo dinámico -->
    <canvas id="background-canvas"></canvas>

    <div id="consulta-container">
        <h1>Consulta del Dr. Huesos</h1>
        <div id="escena">
            <div id="doctor" class="personaje">
<pre>
   /´)
  /  /
 /  |
´-´-|
   / \
  /   \
 |     |
 |     |
</pre>
            </div>
            <div id="paciente" class="personaje">
                <!-- El tamagotchi se cargará aquí -->
            </div>
        </div>
        <div id="dialogo-box">
            <p id="dialogo-texto"></p>
        </div>
        <p id="continue-prompt">Pulsa para continuar</p>
    </div>

    <script>
        // --- ¡NUEVO! LÓGICA DEL FONDO DINÁMICO ---
        let canvas, ctx, stars, clouds, fireflies, shootingStars;
        let sunMoonPos = { x: 0, y: 0 };
        let animationFrameId;

        function drawPixelatedCircle(x, y, radius, color) {
            for (let i = -radius; i <= radius; i++) {
                for (let j = -radius; j <= radius; j++) {
                    if (i * i + j * j <= radius * radius) {
                        ctx.fillStyle = color;
                        ctx.fillRect(Math.floor(x + i), Math.floor(y + j), 1, 1);
                    }
                }
            }
        }

        function drawMoon(x, y, radius, color) {
            drawPixelatedCircle(x, y, radius, color);
            const craterColor = 'rgba(200, 200, 200, 0.7)';
            drawPixelatedCircle(x - radius * 0.4, y - radius * 0.3, radius * 0.2, craterColor);
            drawPixelatedCircle(x + radius * 0.5, y + radius * 0.1, radius * 0.3, craterColor);
            drawPixelatedCircle(x + radius * 0.1, y + radius * 0.5, radius * 0.15, craterColor);
        }

        function drawCloud(cloud) {
            const cloudColor = 'rgba(255, 255, 255, 0.8)';
            const baseRadius = cloud.width / 4;
            drawPixelatedCircle(cloud.x * canvas.width, cloud.y * canvas.height, baseRadius, cloudColor);
            drawPixelatedCircle(cloud.x * canvas.width + baseRadius, cloud.y * canvas.height + baseRadius / 2, baseRadius * 0.8, cloudColor);
            drawPixelatedCircle(cloud.x * canvas.width - baseRadius, cloud.y * canvas.height + baseRadius / 3, baseRadius * 0.9, cloudColor);
            drawPixelatedCircle(cloud.x * canvas.width, cloud.y * canvas.height + baseRadius / 2, baseRadius * 0.7, cloudColor);
        }

        function drawSun(x, y, radius, color) {
            const glowColor = 'rgba(255, 255, 224, 0.15)';
            const rayColor = 'rgba(255, 255, 200, 0.4)';
            drawPixelatedCircle(x, y, radius * 1.8, glowColor);
            ctx.strokeStyle = rayColor;
            ctx.lineWidth = 2;
            for (let i = 0; i < 8; i++) {
                const angle = (i / 8) * (2 * Math.PI);
                const startX = x + Math.cos(angle) * (radius * 1.2);
                const startY = y + Math.sin(angle) * (radius * 1.2);
                const endX = x + Math.cos(angle) * (radius * 2.2);
                const endY = y + Math.sin(angle) * (radius * 2.2);
                ctx.beginPath(); ctx.moveTo(startX, startY); ctx.lineTo(endX, endY); ctx.stroke();
            }
            drawPixelatedCircle(x, y, radius, color);
        }

        function drawLandscape(width, height, groundColor, hillColor1, hillColor2) {
            ctx.fillStyle = hillColor1;
            ctx.beginPath(); ctx.moveTo(0, height * 0.8); ctx.bezierCurveTo(width * 0.2, height * 0.7, width * 0.3, height * 0.75, width * 0.5, height * 0.8); ctx.bezierCurveTo(width * 0.7, height * 0.85, width * 0.8, height * 0.7, width, height * 0.75); ctx.lineTo(width, height); ctx.lineTo(0, height); ctx.closePath(); ctx.fill();
            ctx.fillStyle = hillColor2;
            ctx.beginPath(); ctx.moveTo(0, height * 0.85); ctx.bezierCurveTo(width * 0.3, height * 0.8, width * 0.4, height * 0.9, width * 0.7, height * 0.85); ctx.bezierCurveTo(width * 0.9, height * 0.8, width, height * 0.9, width, height * 0.9); ctx.lineTo(width, height); ctx.lineTo(0, height); ctx.closePath(); ctx.fill();
        }

        function actualizarFondoDinamico() {
            if (!ctx) return;
            const dpr = window.devicePixelRatio || 1;
            const rect = canvas.getBoundingClientRect();
            if (canvas.width !== rect.width * dpr || canvas.height !== rect.height * dpr) {
                canvas.width = rect.width * dpr; canvas.height = rect.height * dpr; ctx.scale(dpr, dpr);
            }
            const width = canvas.clientWidth; const height = canvas.clientHeight;
            const hora = new Date().getHours();
            let skyGradient, sunColor, isNight, groundColor, hillColor1, hillColor2;

            if (hora >= 5 && hora < 7) { skyGradient = ctx.createLinearGradient(0, 0, 0, height); skyGradient.addColorStop(0, '#2c3e50'); skyGradient.addColorStop(0.6, '#e74c3c'); skyGradient.addColorStop(1, '#f1c40f'); sunColor = '#ffd700'; isNight = false; groundColor = '#38302b'; hillColor1 = '#4a3f37'; hillColor2 = '#5c4e44'; }
            else if (hora >= 7 && hora < 12) { skyGradient = ctx.createLinearGradient(0, 0, 0, height); skyGradient.addColorStop(0, '#87CEEB'); skyGradient.addColorStop(1, '#a9dff3'); sunColor = '#FFDE00'; isNight = false; groundColor = '#5d7a3c'; hillColor1 = '#4b6330'; hillColor2 = '#526e33'; }
            else if (hora >= 12 && hora < 17) { skyGradient = ctx.createLinearGradient(0, 0, 0, height); skyGradient.addColorStop(0, '#63a4ff'); skyGradient.addColorStop(1, '#89bfff'); sunColor = '#FFEE88'; isNight = false; groundColor = '#6b8c43'; hillColor1 = '#546e35'; hillColor2 = '#5b7a39'; }
            else if (hora >= 17 && hora < 21) { skyGradient = ctx.createLinearGradient(0, 0, 0, height); skyGradient.addColorStop(0, '#34495e'); skyGradient.addColorStop(0.5, '#e67e22'); skyGradient.addColorStop(1, '#d35400'); sunColor = '#ff6347'; isNight = false; groundColor = '#4a403a'; hillColor1 = '#3b332e'; hillColor2 = '#453a34'; }
            else { skyGradient = ctx.createLinearGradient(0, 0, 0, height); skyGradient.addColorStop(0, '#0c0a18'); skyGradient.addColorStop(1, '#2c3e50'); sunColor = '#f4f4f4'; isNight = true; groundColor = '#2b2f31'; hillColor1 = '#1c1e22'; hillColor2 = '#222629'; }

            if (isNight) { document.body.classList.add('night-mode'); } else { document.body.classList.remove('night-mode'); }
            ctx.fillStyle = skyGradient; ctx.fillRect(0, 0, width, height);
            const cyclePercent = ((hora - 5 + 24) % 24) / 18;
            sunMoonPos.x = width * cyclePercent;
            sunMoonPos.y = height * 0.7 - Math.sin(cyclePercent * Math.PI) * height * 0.6;

            if (isNight) {
                stars.forEach(star => { ctx.fillStyle = `rgba(255, 255, 255, ${star.alpha * (Math.sin(Date.now() * 0.001 + star.x) * 0.2 + 0.8)})`; ctx.fillRect(star.x * width, star.y * height, star.radius, star.radius); });
            }
            drawLandscape(width, height, groundColor, hillColor1, hillColor2);
            if (isNight) {
                drawMoon(sunMoonPos.x, sunMoonPos.y, 25, sunColor);
                fireflies.forEach(fly => { fly.alpha += fly.alphaSpeed; if (fly.alpha > 1 || fly.alpha < 0) fly.alphaSpeed *= -1; fly.x += fly.vx; fly.y += fly.vy; if (fly.x > 1 || fly.x < 0) fly.vx *= -1; if (fly.y > 0.95 || fly.y < 0.75) fly.vy *= -1; ctx.fillStyle = `rgba(255, 255, 100, ${Math.max(0, fly.alpha)})`; ctx.fillRect(fly.x * width, fly.y * height, fly.radius, fly.radius); });
                if (Math.random() < 0.002 && shootingStars.length < 2) { shootingStars.push({ x: Math.random() * width, y: Math.random() * height * 0.3, len: Math.random() * 80 + 50, speed: Math.random() * 2 + 3, life: 1 }); }
                shootingStars.forEach((star, index) => { star.x -= star.speed; star.y += star.speed / 3; star.life -= 0.015; if (star.life <= 0) shootingStars.splice(index, 1); ctx.strokeStyle = `rgba(255, 255, 255, ${star.life})`; ctx.lineWidth = 2; ctx.beginPath(); ctx.moveTo(star.x, star.y); ctx.lineTo(star.x + star.len, star.y - star.len / 3); ctx.stroke(); });
            } else {
                drawSun(sunMoonPos.x, sunMoonPos.y, 25, sunColor);
            }
            clouds.forEach(cloud => { cloud.x += cloud.speed; if (cloud.x * width > width + cloud.width) { cloud.x = -cloud.width / width; } drawCloud(cloud); });
            document.body.style.backgroundImage = 'none';
        }

        function animateBackground() {
            if (!ctx) { animationFrameId = requestAnimationFrame(animateBackground); return; }
            actualizarFondoDinamico();
            animationFrameId = requestAnimationFrame(animateBackground);
        }

        function initBackgroundCanvas() {
            canvas = document.getElementById('background-canvas');
            if (!canvas) return;
            ctx = canvas.getContext('2d');
            ctx.imageSmoothingEnabled = false;
            stars = []; for (let i = 0; i < 250; i++) { stars.push({ x: Math.random(), y: Math.random(), radius: Math.random() * 1.5, alpha: Math.random() * 0.5 + 0.5 }); }
            fireflies = []; for (let i = 0; i < 20; i++) { fireflies.push({ x: Math.random(), y: Math.random() * 0.2 + 0.75, radius: Math.random() * 1.5 + 0.5, alpha: 0, alphaSpeed: Math.random() * 0.02 + 0.01, vx: (Math.random() - 0.5) * 0.0001, vy: (Math.random() - 0.5) * 0.0001 }); }
            shootingStars = [];
            clouds = []; for (let i = 0; i < 10; i++) { clouds.push({ x: Math.random(), y: Math.random() * 0.4 + 0.1, speed: Math.random() * 0.0001 + 0.00005, width: Math.random() * 100 + 50 }); }
            if (animationFrameId) cancelAnimationFrame(animationFrameId);
            animateBackground();
        }
        // --- FIN DE LA LÓGICA DEL FONDO ---

        document.addEventListener("DOMContentLoaded", () => {
            initBackgroundCanvas(); // Inicia el fondo dinámico

            const pacienteDisplay = document.getElementById("paciente");
            const dialogoTexto = document.getElementById("dialogo-texto");
            const continuePrompt = document.getElementById("continue-prompt");

            const tamagotchiData = JSON.parse(localStorage.getItem('tamagotchiData'));

            if (!tamagotchiData) {
                dialogoTexto.textContent = "Error: No se encontraron datos del paciente. Vuelva al juego principal.";
                continuePrompt.style.display = 'block';
                return;
            }

            // Función para obtener el peso ideal (simplificada de tm.js)
            function getIdealWeight(age) {
                if (age <= 10) return 5 + (age * 3);
                if (age <= 20) return 35 + ((age - 10) * 3);
                if (age <= 60) return 65 + ((age - 20) * 0.25);
                return 75 - ((age - 60) * 0.2);
            }

            // Mostrar el tamagotchi
            pacienteDisplay.innerHTML = `<pre>(\\_/)\n( o_o )\n(>   <)</pre>`;

            // Lógica de diagnóstico
            let diagnostico = `Dr. Huesos: "Veamos, ${tamagotchiData.nombre}... `;
            const idealWeight = getIdealWeight(tamagotchiData.edad);
            const weightDifference = tamagotchiData.peso - idealWeight;
            let problemasEncontrados = false;

            // --- LÓGICA DE DIAGNÓSTICO MEJORADA ---
            // 1. Se revisa el peso como una de las primeras causas.
            if (weightDifference > 15) {
                diagnostico += `Tu peso es considerablemente alto para tu edad (${tamagotchiData.peso.toFixed(1)}kg). El sobrepeso está afectando tu salud. Te recomiendo más ejercicio y una dieta equilibrada. `;
                problemasEncontrados = true;
            } else if (weightDifference < -10) {
                diagnostico += `Estás muy por debajo de tu peso ideal (${tamagotchiData.peso.toFixed(1)}kg). La desnutrición te está haciendo enfermar. Necesitas alimentarte mejor. `;
                problemasEncontrados = true;
            } else if (tamagotchiData.hambre > 8) {
                diagnostico += `Tu principal problema es la falta de alimento. Estás muy débil. ¡Necesitas comer algo urgentemente! `;
                problemasEncontrados = true;
            }

            if (tamagotchiData.enfermo && !problemasEncontrados) {
                diagnostico += `Parece que no te encuentras bien. `;
                if (tamagotchiData.edad > 70 && Math.random() < 0.5) {
                    diagnostico += `Son los achaques de la edad. A partir de cierta edad, es normal sentirse mal de vez en cuando. Descansa mucho.`;
                } else if (tamagotchiData.vecesEnfermoPorComidaRapida > 0) {
                    diagnostico += `Tu historial médico indica un consumo excesivo de comida rápida. Esa podría ser la causa de tu malestar actual.`;
                } else {
                    diagnostico += `No encuentro una causa clara, podría ser un malestar pasajero. Procura descansar y cuidar tus necesidades básicas.`;
                }
            } else if (!tamagotchiData.enfermo && !problemasEncontrados) {
                diagnostico += `¡Estás en perfecta forma! Sigue así. No veo ningún problema de salud."`;
            }

            // Animación de escritura
            let i = 0;
            function escribirTexto() {
                if (i < diagnostico.length) {
                    dialogoTexto.innerHTML += diagnostico.charAt(i);
                    i++;
                    setTimeout(escribirTexto, 40); // Velocidad de escritura
                } else {
                    // --- ¡CORRECCIÓN! El pseudo-elemento ::after pertenece a dialogoTexto, no a su padre. ---
                    // Al eliminar la clase o el estilo que lo crea, el cursor desaparece.
                    dialogoTexto.style.animation = 'none'; // Detiene la animación de parpadeo
                    dialogoTexto.style.borderRight = 'none'; // Oculta el cursor estático si lo hubiera
                    continuePrompt.style.display = 'block';

                    // --- MODIFICADO: Añadir listener a todo el body para continuar ---
                    document.body.style.cursor = "pointer";
                    document.body.addEventListener("click", () => {
                        window.location.href = "index.html";
                    }, { once: true }); // { once: true } para que el evento solo se dispare una vez
                }
            }

            escribirTexto();
        });
    </script>

</body>
</html>