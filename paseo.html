<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Paseo con Tamagotchi</title>
    <style>
        body {
            margin: 0;
            display: grid;
            grid-template-rows: auto auto 1fr;
            /* T√≠tulo, Panel de Texto, Escena */
            justify-content: center;
            align-items: center;
            height: 100vh;
            overflow: hidden;
            font-family: 'Courier New', Courier, monospace;
            user-select: none;
            -webkit-user-select: none;
            padding: 20px;
            box-sizing: border-box;
        }

        /* --- MODIFICADO: El contenedor principal se elimina, los estilos se aplican a los elementos directamente --- */
        #walk-container {
            display: contents;
            /* Este elemento ya no act√∫a como contenedor visual */
        }

        /* --- MODIFICADO: El panel ahora est√° en la parte superior --- */
        #top-panel {
            grid-row: 2;
            /* El panel de texto va en la segunda fila */
            width: 95%;
            max-width: 600px;
            margin: 0 auto;
            /* Centrar el panel inferior */
            background: rgba(0, 0, 0, 0.3);
            /* FONDO SEMITRANSPARENTE */
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            padding: 15px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.5);
            text-align: center;
            display: flex;
            flex-direction: column;
            margin-bottom: 20px;
            /* Espacio entre el panel y la escena */
        }

        h1 {
            grid-row: 1;
            /* El t√≠tulo va en la primera fila del grid del body */
            color: #fff;
            /* TEXTO BLANCO */
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.7);
            /* SOMBRA PARA LEGIBILIDAD */
            border-bottom: 1px solid rgba(255, 255, 255, 0.3);
            padding-bottom: 10px;
            margin-top: 0;
            margin-bottom: 20px;
            text-align: center;
        }

        #scene-container {
            grid-row: 3;
            /* La escena ahora ocupa la tercera fila (inferior) */
            position: relative;
            width: 100%;
            background-color: transparent;
            /* SIN FONDO DE COLOR */
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: flex-end;
            /* ALINEA EL PERSONAJE ABAJO */
        }

        /* --- MODIFICADO: Se elimina la animaci√≥n de nubes redundante --- */


        @keyframes scroll-background {
            from {
                background-position: 0 0;
            }

            to {
                background-position: -800px 0;
            }

            /* Coincide con el ancho del SVG */
        }

        /* Animaci√≥n de caminata para el personaje */
        #character-display.walking {
            animation: walk-bob 0.8s ease-in-out infinite;
        }

        #character-display {
            font-size: 2.5rem;
            white-space: pre;
            line-height: 1.2;
            z-index: 10;
            padding-bottom: 20px;
            /* Un poco de espacio desde el borde inferior */
            transition: transform 0.5s ease;
            color: rgba(255, 255, 255, 0.85);
            /* Personaje siempre blanco */
            text-shadow: 1px 1px 4px rgba(0, 0, 0, 0.7);
            /* Sombra para mejorar legibilidad */
        }

        #dialog-box {
            width: 100%;
            /* Ocupa todo el ancho del panel inferior */
            border: 1px solid rgba(255, 255, 255, 0.2);
            background-color: rgba(0, 0, 0, 0.4);
            /* FONDO SEMITRANSPARENTE */
            border-radius: 8px;
            padding: 15px;
            min-height: 120px;
            font-size: 1.1rem;
            margin-bottom: 20px;
        }

        #event-description {
            font-style: italic;
            color: #ccc;
            /* TEXTO M√ÅS CLARO */
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
        }

        #character-dialog {
            font-weight: bold;
            color: #fff;
            /* TEXTO BLANCO */
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.8);
        }

        #choices-container {
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 10px;
            min-height: 50px;
            /* Espacio reservado para botones */
        }

        .choice-btn {
            padding: 12px 20px;
            font-family: 'Courier New', Courier, monospace;
            font-weight: bold;
            font-size: 1rem;
            color: white;
            background-color: #007bff;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .choice-btn:hover {
            background-color: #0056b3;
        }

        .choice-btn.secondary {
            background-color: #6c757d;
        }

        .choice-btn.secondary:hover {
            background-color: #5a6268;
        }

        .hidden {
            display: none;
        }

        /* --- ¬°NUEVO! Estilos para los indicadores de stats --- */
        #stat-changes-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            /* Para que no interfiera con los clics */
            overflow: hidden;
            z-index: 20;
        }

        .stat-change {
            position: absolute;
            font-size: 1.3rem;
            font-weight: bold;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.6);
            animation: float-up 2.5s ease-out forwards;
        }

        .stat-change.positive {
            color: #4CAF50;
        }

        /* Verde para mejoras */
        .stat-change.negative {
            color: #F44336;
        }

        /* Rojo para empeoramientos */
        .stat-change.neutral {
            color: #2196F3;
        }

        /* Azul para cambios neutrales como monedas */

        @keyframes float-up {
            0% {
                opacity: 1;
                transform: translateY(0);
            }

            100% {
                opacity: 0;
                transform: translateY(-60px);
            }
        }

        /* --- Fin de nuevos estilos --- */

        /* --- ¬°NUEVO! Animaci√≥n de balanceo al caminar --- */
        @keyframes walk-bob {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-8px);
            }
        }

        /* --- ¬°NUEVO! Estilos para la alerta de estado cr√≠tico --- */
        #critical-warning-container {
            background-color: #F44336;
            /* Rojo */
            color: white;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            font-weight: bold;
            text-align: center;
            animation: pulse-bg 1.5s infinite;
            display: none;
            /* Oculto por defecto */
        }

        @keyframes pulse-bg {
            0% {
                background-color: #F44336;
            }

            50% {
                background-color: #c62828;
            }

            100% {
                background-color: #F44336;
            }
        }

        /* --- Fin de nuevos estilos --- */



        @media (max-width: 600px) {
            #character-display {
                font-size: 2rem;
            }

            h1 {
                font-size: 1.5rem;
            }

            #dialog-box {
                font-size: 1rem;
            }
        }
    </style>
    <!-- ¬°NUEVO! Estructura para la escena de abandono -->
    <style>
        #abandonment-scene {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #111;
            color: white;
            display: none;
            /* Oculto por defecto */
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            z-index: 1000;
            padding: 20px;
            font-family: 'Courier New', Courier, monospace;
        }

        #abandonment-character {
            font-size: 3rem;
            white-space: pre;
            margin-bottom: 20px;
        }

        #abandonment-dialog {
            font-size: 1.5rem;
            min-height: 100px;
            max-width: 80%;
        }

        #abandonment-dialog::after {
            content: '‚ñã';
            animation: blink 1s step-end infinite;
        }

        @keyframes blink {
            50% {
                opacity: 0;
            }
        }
    </style>
</head>

<body>

    <!-- ¬°NUEVO! Lienzo para el fondo din√°mico -->
    <canvas id="background-canvas"></canvas>

    <!-- ¬°NUEVO! Contenedor para la escena de abandono -->
    <div id="abandonment-scene">
        <div id="abandonment-character">
            <!-- El personaje de la escena se cargar√° aqu√≠ -->
        </div>
        <div id="abandonment-dialog">
            <!-- El di√°logo de la escena se cargar√° aqu√≠ -->
        </div>
    </div>

    <!-- T√≠tulo principal -->
    <h1>De Paseo</h1>

    <!-- Escena principal (personaje) -->
    <div id="scene-container">
        <div id="stat-changes-container"></div>
        <div id="walk-coin-display" class="hidden"
            style="position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.5); color: white; padding: 5px 10px; border-radius: 5px; font-size: 0.9rem;">
            Paseo: 0 ü™ô</div>
        <div id="character-display">
            <!-- El personaje se cargar√° aqu√≠ -->
        </div>
    </div>

    <!-- Panel inferior con di√°logos y botones -->
    <div id="top-panel">
        <div id="critical-warning-container"></div>
        <div id="dialog-box">
            <p id="event-description">El d√≠a es perfecto para un paseo.</p>
            <p id="character-dialog">"¬°Qu√© bien se est√° aqu√≠ fuera!"</p>
        </div>
        <div id="choices-container">
            <!-- Los botones de eventos aparecer√°n aqu√≠ -->
        </div>
        <div id="action-buttons" style="margin-top: 10px; display: flex; flex-direction: column; gap: 10px;">
            <button id="start-walk-btn" class="choice-btn">Empezar Paseo</button>
            <button id="exit-btn" class="choice-btn secondary hidden">Terminar Paseo y Volver</button>
        </div>
    </div>

    <link rel="stylesheet" type="text/css" href="style.css?v=1.2" />
    <script defer src="background.js?v=1.2"></script>
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            initBackgroundCanvas('character-display'); // Inicia el fondo con el ID del personaje del paseo

            // --- L√ìGICA DE ABANDONO ---
            // Si el usuario recarga la p√°gina mientras el paseo est√° activo, se considera abandono.
            if (localStorage.getItem('walkInProgress') === 'true') {
                showAbandonmentScene();
                return; // Detenemos la ejecuci√≥n normal del paseo.
            }

            function typeWriter(element, text, onComplete) {
                let i = 0;
                element.innerHTML = ''; // Limpiar el contenido anterior
                function type() {
                    if (i < text.length) {
                        element.innerHTML += text.charAt(i);
                        i++;
                        setTimeout(type, 80); // Velocidad de escritura
                    } else {
                        if (onComplete) onComplete();
                    }
                }
                type();
            }

            function showAbandonmentScene() {
                // --- CORRECCI√ìN: Ocultar los elementos de la interfaz principal en lugar del contenedor que ya no existe ---
                document.querySelector('h1').style.display = 'none';
                document.getElementById('scene-container').style.display = 'none';
                document.getElementById('top-panel').style.display = 'none';

                const scene = document.getElementById('abandonment-scene');
                const charDisplay = document.getElementById('abandonment-character');
                const dialogDisplay = document.getElementById('abandonment-dialog');
                scene.style.display = 'flex';

                charDisplay.innerHTML = `<pre>(\\_/)\n( T_T )\n(>   <)</pre>`; // Cara triste
                const tamagotchiDialog = "¬øMe has abandonado?... Amo tonto...";

                typeWriter(dialogDisplay, tamagotchiDialog, () => {
                    // Pausa de 2.5 segundos despu√©s del di√°logo
                    setTimeout(() => {
                        // 60% de probabilidad de ser atracado
                        if (Math.random() < 0.60) {
                            showMuggingScene();
                        } else {
                            // 40% de volver a salvo
                            localStorage.setItem('walkGameResult', 'abandoned_safe');
                            localStorage.removeItem('walkInProgress');
                            window.location.href = 'index.html';
                        }
                    }, 2500);
                });
            }

            function showMuggingScene() {
                const charDisplay = document.getElementById('abandonment-character');
                const dialogDisplay = document.getElementById('abandonment-dialog');

                charDisplay.innerHTML = `<pre> >:( </pre>`; // Cara de atracador
                const muggerDialog = "¬°Quieto ah√≠! Dame todo lo que has conseguido en el paseo...";

                typeWriter(dialogDisplay, muggerDialog, () => {
                    // Pausa de 3 segundos para leer el mensaje del atracador
                    setTimeout(() => {
                        localStorage.setItem('walkGameResult', 'abandoned_mugged');
                        // No se guardan monedas ni objetos, se pierden.
                        localStorage.removeItem('walkInProgress');
                        window.location.href = 'index.html';
                    }, 3000);
                });
            }

            // --- ELEMENTOS DEL DOM ---
            const characterDisplay = document.getElementById("character-display");
            const eventDescription = document.getElementById("event-description");
            const characterDialog = document.getElementById("character-dialog");
            const choicesContainer = document.getElementById("choices-container");
            const startWalkBtn = document.getElementById("start-walk-btn");
            const statChangesContainer = document.getElementById("stat-changes-container");
            const exitBtn = document.getElementById("exit-btn");
            const sceneContainer = document.getElementById("scene-container");
            const walkCoinDisplay = document.getElementById("walk-coin-display");

            // --- DATOS DEL JUEGO ---
            let tamagotchiData = null;
            let walkInProgress = false;
            let eventTimeout = null; // Para controlar el temporizador de eventos
            let currentEvent = null; // Para guardar el evento activo
            let feriaHubInterval = null; // <-- ¬°NUEVO! Temporizador para refrescar el hub de la feria
            let walkCoins = 0;
            let mercadoHubInterval = null; // <-- ¬°NUEVO! Temporizador para el mercado.
            // --- ¬°NUEVO! Estado para el modo feria ---
            let inFeria = false; // ¬øEst√° el jugador dentro de la feria?
            let hasBoughtTombolaTicket = false; // ¬øHa comprado un boleto de t√≥mbola?
            let feriaAlreadyVisited = false; // ¬øYa ha entrado a la feria en este paseo?
            let oneTimeEventsVisited = []; // IDs de eventos de un solo uso visitados en esta feria.
            let walkMercadilloInventory = []; // <-- ¬°NUEVO! Inventario temporal para el paseo

            // --- ¬°NUEVO! Estado para el Mercado de Agricultores ---
            let inMercado = false;
            let mercadoAlreadyVisited = false;
            let mercadoOneTimeEventsVisited = [];
            let pumpkinHint = null; // <-- ¬°NUEVO! Para guardar la pista de la calabaza.

            const mercadilloObjects = {
                common: [
                    { id: 'reloj_casio', name: 'Reloj Casio', value: [50, 100] },
                    { id: 'taza_cafe', name: 'Taza de caf√©', value: [50, 100] },
                    { id: 'libro_viejo', name: 'Libro viejo', value: [50, 100] },
                    { id: 'poster_pelicula', name: 'P√≥ster de pel√≠cula', value: [50, 100] },
                    { id: 'planta_plastico', name: 'Planta de pl√°stico', value: [50, 100] },
                    { id: 'figura_accion', name: 'Figura de acci√≥n', value: [50, 100] },
                    { id: 'gorra', name: 'Gorra', value: [50, 100] },
                    { id: 'gafas_sol', name: 'Gafas de sol', value: [50, 100] },
                    { id: 'llavero', name: 'Llavero', value: [50, 100] },
                    { id: 'comic', name: 'C√≥mic', value: [50, 100] }
                ],
                uncommon: [
                    { id: 'vinilo_antiguo', name: 'Vinilo antiguo', value: [200, 400] },
                    { id: 'camara_fotos', name: 'C√°mara de fotos', value: [200, 400] },
                    { id: 'walkman', name: 'Walkman', value: [200, 400] },
                    { id: 'consola_retro', name: 'Consola retro', value: [200, 400] },
                    { id: 'maquina_escribir', name: 'M√°quina de escribir', value: [200, 400] },
                    { id: 'telefono_antiguo', name: 'Tel√©fono antiguo', value: [200, 400] },
                    { id: 'mapa_antiguo', name: 'Mapa antiguo', value: [200, 400] },
                    { id: 'joya_plata', name: 'Joya de plata', value: [200, 400] }
                ],
                rare: [
                    { id: 'pepita_oro', name: 'Pepita de oro', value: [4000, 6000] },
                    { id: 'diamante', name: 'Diamante', value: [4000, 6000] }
                ]
            };

            // --- ¬°NUEVO! Eventos exclusivos de la Feria ---
            const feriaEvents = [
                // --- EVENTOS DE ATRACCIONES DE LA FERIA ---
                {
                    id: "feria_mystery_box",
                    description: "Ves un puesto con cajas misteriosas de diferentes tama√±os. El cartel dice: '¬°Una sorpresa en cada caja!'",
                    characterDialog: "¬°Ooh, me pregunto qu√© habr√° dentro! ¬øProbamos suerte?",
                    choices: [
                        { text: "Comprar caja peque√±a (75 monedas)", action: "buy_small" },
                        { text: "Comprar caja grande (300 monedas)", action: "buy_large" },
                        { text: "No, gracias", action: "leave" }
                    ],
                    consequences: {
                        buy_small: (data) => {
                            if (data.coins >= 75) {
                                data.coins -= 75;
                                updateWalkCoins(-75);
                                const item = buyMercadilloObject(75);
                                oneTimeEventsVisited.push('feria_mystery_box'); // Marcar como visitado
                                return { description: `Abres la caja peque√±a y... ¬°dentro hay un ${item.name}!`, characterDialog: "¬°Qu√© guay! A ver si vale algo." };
                            }
                            return { description: "No tienes 75 monedas para la caja peque√±a.", characterDialog: "L√°stima, me quedar√© con la intriga." };
                        },
                        buy_large: (data) => {
                            if (data.coins >= 300) {
                                data.coins -= 300;
                                updateWalkCoins(-300);
                                const item = buyMercadilloObject(300);
                                oneTimeEventsVisited.push('feria_mystery_box'); // Marcar como visitado
                                return { description: `Con mucho cuidado, abres la caja grande. ¬°Has conseguido un ${item.name}!`, characterDialog: "¬°Wow! ¬°Esto parece valioso!" };
                            }
                            return { description: "La caja grande es demasiado cara, no tienes 300 monedas.", characterDialog: "Uf, 300 monedas es mucho... mejor no arriesgar." };
                        },
                        leave: (data) => {
                            oneTimeEventsVisited.push('feria_mystery_box'); // Marcar como visitado
                            return { description: "Decides guardar tu dinero para otras atracciones de la feria.", characterDialog: "Mejor no gastar en algo que no s√© lo que es." };
                        }
                    }
                },
                {
                    id: "feria_algodon",
                    description: "Un puesto de algod√≥n de az√∫car desprende un olor dulz√≥n que te atrae.",
                    characterDialog: "¬°Algod√≥n de az√∫car! ¬°Es mi favorito! ¬øPodemos comprar uno?",
                    choices: [
                        { text: "Comprar uno (25 monedas)", action: "buy" },
                        { text: "No, demasiado az√∫car", action: "refuse" }
                    ],
                    consequences: {
                        buy: (data) => {
                            if (data.coins >= 25) {
                                data.coins -= 25;
                                updateWalkCoins(-25);
                                data.aburrimiento = Math.max(0, data.aburrimiento - 1);
                                data.hambre = Math.max(0, data.hambre - 0.5);
                                return { description: "Compr√°is un algod√≥n de az√∫car gigante y pegajoso. Est√° delicioso.", characterDialog: "¬°√ëam! ¬°Sabe a nube!" };
                            }
                            return { description: "No tienes suficiente dinero para el algod√≥n de az√∫car.", characterDialog: "Oh... bueno, solo con olerlo casi me alimento." };
                        },
                        refuse: (data) => {
                            data.hambre = Math.min(10, data.hambre + 0.5); // Aumenta el hambre al rechazar la comida
                            return { description: "Decides que es mejor no tomar m√°s az√∫car y segu√≠s explorando la feria, pero el olor te ha abierto el apetito.", characterDialog: "Jo, con las ganas que ten√≠a... y ahora tengo m√°s hambre." };
                        }
                    }
                },
                {
                    id: "feria_tiro_blanco",
                    description: "Lleg√°is a una caseta de tiro al blanco. El premio gordo es un peluche enorme.",
                    characterDialog: "¬°Yo quiero ese peluche! ¬°D√©jame probar, porfa!",
                    choices: [
                        { text: "Jugar una partida (40 monedas)", action: "play" },
                        { text: "Es una estafa, v√°monos", action: "leave" }
                    ],
                    consequences: {
                        play: (data) => {
                            if (data.coins < 40) {
                                return { description: "No tienes 40 monedas para jugar la partida.", characterDialog: "No puedo jugar... ¬°qu√© rabia!" };
                            }
                            data.coins -= 40;
                            updateWalkCoins(-40);
                            oneTimeEventsVisited.push('feria_tiro_blanco'); // Marcar como visitado

                            // La probabilidad de ganar depende del karma
                            const winChance = 0.3 + (data.karma * 0.05); // 30% base + 5% por cada punto de karma
                            if (Math.random() < winChance) {
                                data.coins += 75;
                                updateWalkCoins(75);
                                data.aburrimiento = Math.max(0, data.aburrimiento - 3);
                                return { description: "¬°Incre√≠ble! ¬°Has acertado todos los blancos y ganas 75 monedas!", characterDialog: "¬°TOMA! ¬°Soy el mejor! ¬°Hemos ganado dinero!" };
                            } else {
                                data.aburrimiento = Math.min(10, data.aburrimiento + 0.5);
                                return { description: "Fallaste por poco. El feriante te da un peque√±o llavero como premio de consolaci√≥n.", characterDialog: "Uf, casi... Bueno, algo es algo." };
                            }
                        },
                        leave: (data) => {
                            oneTimeEventsVisited.push('feria_tiro_blanco'); // Marcar como visitado
                            return { description: "Decid√≠s no gastar el dinero en lo que parece un timo.", characterDialog: "Seguro que la mira de la escopeta estaba torcida." };
                        }
                    }
                },
                {
                    id: "feria_casa_terror",
                    description: "Una casa del terror con ruidos espeluznantes os invita a entrar.",
                    characterDialog: "Uuuh... da un poco de miedo... pero tambi√©n parece divertido. ¬øEntramos?",
                    choices: [
                        { text: "Entrar (50 monedas)", action: "enter" },
                        { text: "¬°Ni hablar! Me da p√°nico", action: "flee" }
                    ],
                    consequences: {
                        enter: (data) => {
                            if (data.coins < 50) {
                                return { description: "No tienes 50 monedas para entrar.", characterDialog: "Mejor, as√≠ no paso miedo..." };
                            }
                            data.coins -= 50;
                            updateWalkCoins(-50);
                            data.aburrimiento = Math.max(0, data.aburrimiento - 2.5);
                            return { description: "Pas√°is un rato de sustos y risas. Al final no era para tanto.", characterDialog: "¬°Buah, qu√© pasada! ¬°Casi me muero del susto, pero me ha encantado!" };
                        },
                        flee: (data) => {
                            data.aburrimiento = Math.min(10, data.aburrimiento + 0.3);
                            return { description: "Decides que es mejor evitar los sustos y rode√°is la atracci√≥n.", characterDialog: "Uf, solo con los gritos que se oyen ya tengo bastante. ¬°Qu√© miedica soy!" };
                        }
                    }
                },
                // Evento final de la feria
                {
                    id: "feria_tombola",
                    description: "En el centro de la feria hay una gran t√≥mbola. El sorteo se anunciar√° al cierre.",
                    characterDialog: "¬°La t√≥mbola! ¬°Aqu√≠ se ganan los mejores premios! ¬øCompramos un boleto?",
                    choices: [
                        { text: "Comprar boleto (100 monedas)", action: "buy_ticket" }
                    ],
                    consequences: {
                        buy_ticket: (data) => {
                            if (data.coins < 100) {
                                return { description: "No tienes 100 monedas para el boleto.", characterDialog: "No me llega... Otra vez ser√°." };
                            }
                            data.coins -= 100;
                            updateWalkCoins(-100);
                            hasBoughtTombolaTicket = true;
                            oneTimeEventsVisited.push('feria_tombola'); // Marcar como visitado

                            // El resultado se revelar√° al salir de la feria o del paseo.
                            return { description: "Compras un boleto para la gran t√≥mbola. ¬°Cruza los dedos!", characterDialog: "¬°Ya ver√°s como nos toca algo bueno! ¬°Lo presiento!" };
                        }
                    }
                },
                // --- ¬°NUEVO! Evento de la Noria ---
                {
                    id: "feria_noria",
                    description: "Una noria gigante se alza sobre la feria, ofreciendo vistas espectaculares.",
                    characterDialog: "¬°Wow, qu√© alto! ¬øSubimos? ¬°Veremos toda la ciudad desde ah√≠ arriba!",
                    choices: [
                        { text: "Subir a la noria (35 monedas)", action: "ride" },
                        { text: "Mejor no, me dan miedo las alturas", action: "skip" }
                    ],
                    consequences: {
                        ride: (data) => {
                            if (data.coins >= 35) {
                                data.coins -= 35;
                                updateWalkCoins(-35);
                                data.aburrimiento = Math.max(0, data.aburrimiento - 2);
                                return { description: "Sub√≠s a la noria. La vista desde la cima es impresionante y el aire fresco os relaja.", characterDialog: "¬°Se ve nuestra casa desde aqu√≠! ¬°Qu√© pasada!" };
                            }
                            return { description: "No tienes suficiente dinero para subir a la noria.", characterDialog: "Oh... bueno, la ver√© desde abajo." };
                        },
                        skip: (data) => {
                            data.aburrimiento = Math.min(10, data.aburrimiento + 0.2);
                            return { description: "Decides mantener los pies en la tierra y segu√≠s explorando.", characterDialog: "Uf, solo de pensarlo me mareo. Demasiado alto para m√≠." };
                        }
                    }
                },
                // --- ¬°NUEVO! Evento del Adivino ---
                {
                    id: "feria_adivino",
                    description: "En una tienda con cortinas de terciopelo, un misterioso adivino te ofrece leerte el futuro.",
                    characterDialog: "¬øCrees que dir√° la verdad? Me da curiosidad... y un poco de miedo.",
                    choices: [
                        { text: "Consultar al adivino (60 monedas)", action: "consult" },
                        { text: "No creo en estas cosas", action: "dismiss" }
                    ],
                    consequences: {
                        consult: (data) => {
                            if (data.coins >= 60) {
                                data.coins -= 60;
                                updateWalkCoins(-60);
                                let future_reading = "";
                                if (data.karma > 5) {
                                    future_reading = "El adivino ve un futuro brillante y pr√≥spero. 'Tus buenas acciones te ser√°n recompensadas', susurra.";
                                } else if (data.karma < -5) {
                                    future_reading = "El adivino frunce el ce√±o. 'Veo sombras en tu camino... ten cuidado con tus decisiones', advierte.";
                                } else {
                                    future_reading = "El adivino te mira fijamente. 'Tu futuro es incierto, como una moneda en el aire. Solo tus actos decidir√°n la cara que saldr√°'.";
                                }
                                return { description: future_reading, characterDialog: "¬°Qu√© intenso! Me ha dejado pensando..." };
                            }
                            return { description: "No tienes 60 monedas para que te lean el futuro.", characterDialog: "Supongo que mi futuro tendr√° que esperar." };
                        },
                        dismiss: (data) => {
                            return { description: "Prefieres no gastar dinero en supersticiones y continu√°is.", characterDialog: "Seguro que se lo inventa todo." };
                        }
                    }
                },
                // --- ¬°NUEVO! Evento del Easter Egg de la Fuente ---
                {
                    id: "feria_fuente_secreta",
                    description: "En el centro de la feria hay una fuente de piedra, bastante normalita.",
                    characterDialog: "Es solo una fuente. No parece muy interesante.",
                    choices: [
                        { text: "Lanzar una moneda y pedir un deseo", action: "wish" }
                    ],
                    consequences: {
                        wish: (data) => {
                            // Esta es la acci√≥n final del Easter Egg.
                            // Comprueba si se han completado los 3 pasos anteriores.
                            if (data.feriaEasterEggStep === 4) { // CORREGIDO: Se comprueba si el paso 4 est√° completado
                                console.log("Fuente OK - Recompensa activada.");
                                // ¬°Recompensa del Easter Egg!
                                data.coins += 1800; // MODIFICADO: Recompensa de 1800 monedas
                                updateWalkCoins(1000);
                                data.karma = Math.min(10, (data.karma || 0) + 2);
                                ['hambre', 'aburrimiento', 'sueno', 'higiene'].forEach(s => data[s] = Math.max(0, data[s] - 5));
                                data.feriaEasterEggStep = 0; // Resetea el contador
                                oneTimeEventsVisited.push('feria_fuente_secreta'); // Marcar como visitado tras completarlo
                                return { description: "Al lanzar la moneda, escuchas un 'clic'. Un compartimento secreto se abre en la base de la fuente. ¬°Has encontrado un tesoro! Ganas 1800 monedas, +2 de Karma y tus necesidades bajan dr√°sticamente.", characterDialog: "¬°¬°¬°JACKPOT!!! ¬°Mi deseo se ha cumplido!" };
                            }
                            // Si no es el paso final, es una acci√≥n normal.
                            return { description: "Lanzas una moneda al agua y pides un deseo en silencio.", characterDialog: "Espero que se cumpla..." };
                        }
                    }
                },
                // --- ¬°NUEVO! Evento del Globo Perdido ---
                {
                    id: "feria_globo_perdido",
                    description: "Un peque√±o Tamagotchi llora desconsoladamente. Se le ha escapado su globo y se ha quedado enganchado en un poste alto.",
                    characterDialog: "¬°Oh, no! ¬°Pobrecito! ¬øPodemos ayudarle a recuperar su globo?",
                    choices: [
                        { text: "Intentar bajar el globo", action: "help" },
                        { text: "Decirle que se compre otro", action: "ignore" }
                    ],
                    consequences: {
                        help: (data) => {
                            data.karma = Math.min(10, (data.karma || 0) + 3);
                            data.aburrimiento = Math.max(0, data.aburrimiento - 1);
                            return { description: "Con un poco de ingenio, consigues bajar el globo y d√°rselo al peque√±o, que te lo agradece con una gran sonrisa.", characterDialog: "¬°Me siento como un superh√©roe! ¬°Qu√© bien sienta ayudar!" };
                        },
                        ignore: (data) => {
                            data.karma = Math.max(-10, (data.karma || 0) - 3);
                            return { description: "Pasas de largo. 'Son cosas de ni√±os', piensas.", characterDialog: "Que llore, ya se le pasar√° la tonter√≠a." };
                        }
                    }
                },
                // --- ¬°NUEVO! Evento del Carrusel ---
                {
                    id: "feria_carrusel",
                    description: "Un carrusel cl√°sico con caballos de madera y m√∫sica nost√°lgica gira lentamente.",
                    characterDialog: "¬°Qu√© bonito! Es como de cuento. ¬øDamos una vuelta?",
                    choices: [
                        { text: "Subir al carrusel (20 monedas)", action: "ride" },
                        { text: "No, es para ni√±os peque√±os", action: "skip" }
                    ],
                    consequences: {
                        ride: (data) => {
                            if (data.coins >= 20) {
                                data.coins -= 20;
                                updateWalkCoins(-20);
                                data.aburrimiento = Math.max(0, data.aburrimiento - 1.5);
                                data.karma = Math.min(10, (data.karma || 0) + 1); // Peque√±o bonus de karma por disfrutar de algo simple
                                return { description: "Das una vuelta tranquila en el carrusel. La m√∫sica y el movimiento suave son muy relajantes.", characterDialog: "¬°Qu√© paz! Me ha gustado mucho." };
                            }
                            return { description: "No tienes 20 monedas para el carrusel.", characterDialog: "Bueno, lo veo desde aqu√≠, que tambi√©n es bonito." };
                        },
                        skip: (data) => {
                            return { description: "Decides que el carrusel es demasiado lento para ti y buscas algo m√°s emocionante.", characterDialog: "Busquemos algo con m√°s adrenalina." };
                        }
                    }
                },
                // --- ¬°NUEVO! Evento del Puesto de Comida ---
                {
                    id: "feria_puesto_comida",
                    description: "Un puesto de comida ofrece una variedad de delicias de feria: churros, perritos calientes y manzanas de caramelo.",
                    characterDialog: "¬°Huele de maravilla! ¬°Tengo que comer algo!",
                    choices: [
                        { text: "Comprar Churros (30 monedas)", action: "buy_churros" },
                        { text: "Comprar Perrito Caliente (60 monedas)", action: "buy_hotdog" },
                        { text: "No comer nada", action: "skip" }
                    ],
                    consequences: {
                        buy_churros: (data) => {
                            if (data.coins >= 30) {
                                data.coins -= 30;
                                updateWalkCoins(-30);
                                data.hambre = Math.max(0, data.hambre - 1.5);
                                data.peso = Math.min(100, data.peso + 0.5);
                                return { description: "Compr√°is una raci√≥n de churros calientes y crujientes. ¬°Deliciosos!", characterDialog: "¬°Mmm, az√∫car!" };
                            }
                            return { description: "No tienes 30 monedas para los churros.", characterDialog: "Me quedo con las ganas..." };
                        },
                        buy_hotdog: (data) => {
                            if (data.coins >= 60) {
                                data.coins -= 60;
                                updateWalkCoins(-60);
                                data.hambre = Math.max(0, data.hambre - 3);
                                data.peso = Math.min(100, data.peso + 1.0);
                                return { description: "Te comes un perrito caliente con todas las salsas. ¬°Estaba incre√≠ble!", characterDialog: "¬°Esto s√≠ que es una cena de campeones!" };
                            }
                            return { description: "No tienes 60 monedas para el perrito caliente.", characterDialog: "Demasiado caro para mi bolsillo." };
                        },
                        skip: (data) => {
                            data.hambre = Math.min(10, data.hambre + 1); // Aumenta el hambre al resistir la tentaci√≥n
                            return { description: "Decides resistir la tentaci√≥n y guardar tu apetito (y tu dinero), pero el olor te ha dejado con m√°s hambre.", characterDialog: "Mejor no, que luego no duermo bien... pero ahora tengo un hambre atroz." };
                        }
                    }
                },
                // --- ¬°NUEVO! Evento del Mago Callejero ---
                {
                    id: "feria_mago",
                    description: "Un mago con un sombrero de copa est√° haciendo trucos de cartas a un peque√±o grupo de gente.",
                    characterDialog: "¬°Magia! ¬°Vamos a ver qu√© hace!",
                    choices: [
                        { text: "Ver el truco y aplaudir", action: "watch" },
                        { text: "Acusarle de hacer trampas", action: "accuse" }
                    ],
                    consequences: {
                        watch: (data) => {
                            data.aburrimiento = Math.max(0, data.aburrimiento - 1);
                            data.karma = Math.min(10, (data.karma || 0) + 1);
                            return { description: "Os qued√°is a ver el truco. El mago saca la carta que hab√≠as pensado. ¬°Incre√≠ble! Le dais un aplauso.", characterDialog: "¬øC√≥mo lo ha hecho? ¬°Es magia de verdad!" };
                        },
                        accuse: (data) => {
                            data.karma = Math.max(-10, (data.karma || 0) - 2);
                            return { description: "Gritas que es un farsante. El mago te ignora y el p√∫blico te mira mal. Qu√© momento m√°s inc√≥modo.", characterDialog: "Bah, seguro que era un truco barato." };
                        }
                    }
                },
            ];

            // --- ¬°NUEVO! Eventos exclusivos del Mercado de Agricultores ---
            const mercadoEvents = [
                {
                    id: "mercado_caja_sorpresa",
                    description: "Un granjero con un sombrero de paja te ofrece 'Cajas de la Cosecha'. Dice que contienen los mejores productos de la temporada, ¬°algunos muy raros!",
                    characterDialog: "¬°Cajas sorpresa! ¬°Me encantan las sorpresas! ¬øCompramos una?",
                    choices: [
                        { text: "Comprar Cesta Peque√±a (75 monedas)", action: "buy_small" },
                        { text: "Comprar Caja Grande (300 monedas)", action: "buy_large" },
                        { text: "No, gracias", action: "leave" }
                    ],
                    consequences: {
                        buy_small: (data) => {
                            if (data.coins < 75) return { description: "No tienes 75 monedas para la cesta peque√±a.", characterDialog: "L√°stima, me quedar√© con la intriga." };
                            data.coins -= 75;
                            updateWalkCoins(-75);
                            const item = buyMercadilloObject(75);
                            mercadoOneTimeEventsVisited.push('mercado_caja_sorpresa'); // Marcar como visitado
                            return { description: `Abres la cesta y... ¬°dentro hay un ${item.name}!`, characterDialog: "¬°Qu√© guay! A ver si vale algo." };
                        },
                        buy_large: (data) => {
                            if (data.coins < 300) return { description: "La caja grande es demasiado cara, no tienes 300 monedas.", characterDialog: "Uf, 300 monedas es mucho... mejor no arriesgar." };
                            data.coins -= 300;
                            updateWalkCoins(-300);
                            const item = buyMercadilloObject(300);
                            mercadoOneTimeEventsVisited.push('mercado_caja_sorpresa'); // Marcar como visitado
                            return { description: `Con mucho cuidado, abres la caja grande. ¬°Has conseguido un ${item.name}!`, characterDialog: "¬°Wow! ¬°Esto parece valioso!" };
                        },
                        leave: (data) => ({ description: "Decides guardar tu dinero para otras cosas del mercado.", characterDialog: "Mejor no gastar en algo que no s√© lo que es." })
                    }
                },
                {
                    id: "mercado_frutas",
                    description: "Un puesto lleno de frutas frescas y coloridas llama tu atenci√≥n. Manzanas, pl√°tanos, naranjas...",
                    characterDialog: "¬°Qu√© buena pinta tiene todo! Una pieza de fruta me sentar√≠a genial.",
                    choices: [
                        { text: "Comprar Manzana (15 monedas)", action: "buy_apple" },
                        { text: "Comprar Pl√°tano (20 monedas)", action: "buy_banana" },
                        { text: "No, gracias", action: "leave" }
                    ],
                    consequences: {
                        buy_apple: (data) => {
                            if (data.coins < 15) return { description: "No tienes 15 monedas para la manzana.", characterDialog: "No me llega..." };
                            data.coins -= 15; updateWalkCoins(-15);
                            data.hambre = Math.max(0, data.hambre - 1.5);
                            data.peso = Math.min(100, data.peso + 0.2);
                            return { description: "Compras una manzana roja y crujiente. Est√° deliciosa.", characterDialog: "¬°Qu√© rica y sana!" };
                        },
                        buy_banana: (data) => {
                            if (data.coins < 20) return { description: "No tienes 20 monedas para el pl√°tano.", characterDialog: "L√°stima, me apetec√≠a mucho." };
                            data.coins -= 20; updateWalkCoins(-20);
                            data.hambre = Math.max(0, data.hambre - 2);
                            data.peso = Math.min(100, data.peso + 0.3);
                            return { description: "Compras un pl√°tano maduro. Te da mucha energ√≠a.", characterDialog: "¬°Justo lo que necesitaba!" };
                        },
                        leave: (data) => ({ description: "Decides seguir mirando otros puestos del mercado.", characterDialog: "A ver qu√© m√°s encuentro por aqu√≠." })
                    }
                },
                {
                    id: "mercado_cafe",
                    description: "El aroma a caf√© reci√©n molido te gu√≠a a un peque√±o puesto de caf√© artesanal.",
                    characterDialog: "Uhm... ese olor me est√° despertando. ¬øProbamos un caf√©?",
                    choices: [{ text: "Tomar un caf√© (25 monedas)", action: "drink" }, { text: "No, demasiado nervioso", action: "skip" }],
                    consequences: {
                        drink: (data) => {
                            if (data.coins < 25) return { description: "No tienes 25 monedas para el caf√©.", characterDialog: "Bueno, solo con olerlo ya casi he despertado." };
                            data.coins -= 25; updateWalkCoins(-25);
                            data.sueno = Math.max(0, data.sueno - 2.5);
                            data.hambre = Math.min(10, data.hambre + 0.5);
                            return { description: "Tomas un sorbo del caf√© caliente. Su sabor es intenso y te despeja por completo.", characterDialog: "¬°Wow! ¬°Ahora estoy a tope de energ√≠a!" };
                        },
                        skip: (data) => ({ description: "Prefieres evitar la cafe√≠na y contin√∫as tu paseo por el mercado.", characterDialog: "Mejor no, que luego no duermo la siesta." })
                    }
                },
                {
                    id: "mercado_ayuda_granjero",
                    description: "Un viejo granjero lucha por cargar unas cajas pesadas de verduras en su camioneta.",
                    characterDialog: "Parece que necesita ayuda. ¬øLe echamos una mano?",
                    choices: [{ text: "Ayudar al granjero", action: "help" }, { text: "No es nuestro problema", action: "ignore" }],
                    consequences: {
                        help: (data) => {
                            data.karma = Math.min(10, (data.karma || 0) + 2);
                            data.aburrimiento = Math.max(0, data.aburrimiento - 1);
                            mercadoOneTimeEventsVisited.push('mercado_ayuda_granjero');
                            // --- MODIFICADO: Ahora da una pista espec√≠fica ---
                            pumpkinHint = ['a', 'b'][Math.floor(Math.random() * 2)]; // Decide el ganador y lo guarda
                            const hintText = `Gracias, joven. Como agradecimiento, te dar√© un soplo para el concurso... Apuesta por la calabaza '${pumpkinHint.toUpperCase()}'. No se lo digas a nadie.`;
                            return { description: `Le ayudas a cargar las cajas. El granjero, muy agradecido, te regala una cesta de verduras y te susurra al o√≠do: "${hintText}"`, characterDialog: "¬°Qu√© amable! Me ha dado un consejo muy espec√≠fico..." };
                        },
                        ignore: (data) => {
                            data.karma = Math.max(-10, (data.karma || 0) - 1);
                            mercadoOneTimeEventsVisited.push('mercado_ayuda_granjero');
                            return { description: "Decides no intervenir y sigues tu camino.", characterDialog: "Seguro que puede solo. No quiero romperme la espalda." };
                        }
                    }
                },
                {
                    id: "mercado_musica",
                    description: "Un m√∫sico con una guitarra ac√∫stica toca una melod√≠a folk muy alegre. Varios visitantes aplauden.",
                    characterDialog: "¬°Qu√© m√∫sica tan bonita! Me dan ganas de bailar.",
                    consequences: {
                        proceed: (data) => {
                            data.aburrimiento = Math.max(0, data.aburrimiento - 1.5);
                            return { description: "Os qued√°is un rato escuchando la m√∫sica, disfrutando del ambiente animado del mercado.", characterDialog: "¬°Esto s√≠ que es empezar bien el d√≠a!" };
                        }
                    }
                }
                ,
                {
                    id: "mercado_fuente_pueblo",
                    description: "En el centro del mercado hay una vieja fuente de piedra con agua fresca y clara.",
                    characterDialog: "Dicen que si lanzas una moneda, trae buena suerte en la cosecha. ¬øProbamos?",
                    choices: [
                        { text: "Lanzar una moneda (1 moneda)", action: "wish" }
                    ],
                    consequences: {
                        wish: (data) => {
                            if (data.coins < 1) return { description: "No tienes ni una moneda para lanzar.", characterDialog: "Vaya, ni para un deseo tengo." };
                            data.coins -= 1;
                            updateWalkCoins(-1);

                            if (data.mercadoEasterEggStep === 4) { // ¬°Paso final del Easter Egg!
                                data.coins += 2000;
                                updateWalkCoins(2000);
                                data.karma = Math.min(10, (data.karma || 0) + 3);
                                data.mercadoEasterEggStep = 0; // Resetea el contador
                                return { description: "Al lanzar la moneda, escuchas un 'clic'. Un compartimento secreto se abre en la base de la fuente. ¬°Has descubierto el tesoro del fundador! Ganas 2000 monedas y buen karma.", characterDialog: "¬°¬°ALUCINANTE!! ¬°La leyenda era cierta!" };
                            }
                            return { description: "Lanzas una moneda al agua y pides un deseo en silencio.", characterDialog: "Espero que se cumpla..." };
                        }
                    }
                }
                ,
                {
                    id: "mercado_concurso_calabaza",
                    description: "Hay un concurso para ver qu√© calabaza es la m√°s grande. Un granjero est√° tomando apuestas.",
                    characterDialog: "¬°Apuestas! ¬°Si elegimos la calabaza correcta, podr√≠amos ganar dinero!",
                    choices: [
                        { text: "Apostar por la Calabaza A (20 monedas)", action: "bet_a" },
                        { text: "Apostar por la Calabaza B (20 monedas)", action: "bet_b" },
                        { text: "No apostar", action: "skip" }
                    ],
                    consequences: {
                        bet_a: (data) => handleBet(data, 'a'),
                        bet_b: (data) => handleBet(data, 'b'),
                        skip: (data) => {
                            mercadoOneTimeEventsVisited.push('mercado_concurso_calabaza');
                            return { description: "Decides no apostar y guardas tu dinero.", characterDialog: "Mejor no arriesgar, que luego me arrepiento." };
                        }
                    }
                },
                {
                    id: "mercado_tomate_caido",
                    description: "Un comprador tropieza y su bolsa de tomates caros se desparrama por el suelo.",
                    characterDialog: "¬°Oh, no! ¬°Pobrecillo! ¬øQu√© hacemos?",
                    choices: [
                        { text: "Ayudar a recoger los tomates", action: "help" },
                        { text: "Coger un tomate y huir corriendo", action: "steal" },
                        { text: "Ignorarlo, no es nuestro problema", action: "ignore" }
                    ],
                    consequences: {
                        help: (data) => {
                            data.karma = Math.min(10, (data.karma || 0) + 3);
                            data.coins += 25;
                            updateWalkCoins(25);
                            mercadoOneTimeEventsVisited.push('mercado_tomate_caido');
                            return { description: "R√°pidamente le ayudas a recoger todos los tomates. El comprador, muy agradecido, te da 25 monedas por tu amabilidad.", characterDialog: "¬°Hacer lo correcto tiene recompensa!" };
                        },
                        steal: (data) => {
                            data.karma = Math.max(-10, (data.karma || 0) - 4);
                            data.hambre = Math.max(0, data.hambre - 1);
                            mercadoOneTimeEventsVisited.push('mercado_tomate_caido');
                            return { description: "Aprovechando la confusi√≥n, coges uno de los tomates m√°s rojos y te lo comes mientras te alejas disimuladamente.", characterDialog: "Jeje, gratis y delicioso. Nadie se ha dado cuenta." };
                        },
                        ignore: (data) => {
                            data.karma = Math.max(-10, (data.karma || 0) - 2);
                            mercadoOneTimeEventsVisited.push('mercado_tomate_caido');
                            return { description: "Decides que no es asunto tuyo y contin√∫as tu paseo, rodeando el desastre.", characterDialog: "Uf, qu√© l√≠o. Mejor no meterse." };
                        }
                    }
                }
            ];

            // --- DEFINICI√ìN DE EVENTOS ---
            // --- ¬°NUEVO! Eventos clasificados por momento del d√≠a ---
            const timeBasedEvents = {
                // Eventos que pueden ocurrir en cualquier momento
                anytime: [
                    {
                        id: "rain_event",
                        description: "De repente, el cielo se nubla y empieza a llover.",
                        condition: (data) => !data.hasUmbrella, // Solo si NO tienes paraguas
                        characterDialog: "¬°Oh no, lluvia! ¬°Odio mojarme! Cerca hay una tienda...",
                        sceneChange: { backgroundColor: '#708090' },
                        choices: [
                            { text: "Comprar paraguas (50 monedas)", action: "buy_umbrella" },
                            { text: "No importa, seguir andando", action: "ignore_rain" }
                        ],
                        consequences: {
                            buy_umbrella: (data) => {
                                if (data.coins >= 50) {
                                    data.hasUmbrella = true; // Marcamos que ya lo tiene
                                    data.coins -= 50;
                                    data.karma = Math.min(10, (data.karma || 0) + 1); // Peque√±a buena acci√≥n (previsi√≥n)
                                    updateWalkCoins(-50);
                                    data.aburrimiento = Math.max(0, data.aburrimiento - 1.5);
                                    return { description: "Con el paraguas nuevo, la lluvia ya no es un problema.", characterDialog: "¬°Menos mal! Ahora puedo seguir disfrutando." };
                                } else {
                                    data.higiene = Math.min(10, data.higiene + 1.5);
                                    data.aburrimiento = Math.min(10, data.aburrimiento + 1);
                                    return { description: "No tienes suficiente dinero. Te est√°s empapando.", characterDialog: "¬°Buah, qu√© mala suerte! Estoy calado hasta los huesos." };
                                }
                            },
                            ignore_rain: (data) => {
                                data.higiene = Math.min(10, data.higiene + 2);
                                data.aburrimiento = Math.min(10, data.aburrimiento + 0.5);
                                return { description: "Decides ignorar la lluvia y seguir tu camino.", characterDialog: "Brrr, ¬°qu√© fr√≠o! Y qu√© sucio me estoy poniendo." };
                            }
                        }
                    },
                    {
                        id: "find_coin",
                        description: "¬°Brilla algo en el suelo! Es una moneda.",
                        characterDialog: "¬°Ooh, dinero gratis!",
                        consequences: {
                            proceed: (data) => {
                                data.coins += 5;
                                updateWalkCoins(5);
                                return { description: "La recoges y la guardas en tu bolsillo. No es mucho, pero todo suma.", characterDialog: "¬°D√≠a de suerte!" };
                            }
                        }
                    }
                ],
                morning: [ // De 06:00 a 11:59
                    {
                        id: "mercado_entrance",
                        description: "A lo lejos, ves los puestos y el bullicio de un mercado de agricultores.",
                        condition: (data) => !mercadoAlreadyVisited,
                        characterDialog: "¬°Un mercado! ¬°Seguro que hay cosas frescas y ricas! ¬øVamos a echar un vistazo?",
                        choices: [
                            { text: "Entrar al mercado", action: "enter_mercado" },
                            { text: "No, prefiero un paseo tranquilo", action: "ignore_mercado" }
                        ],
                        consequences: {
                            enter_mercado: (data) => {
                                mercadoAlreadyVisited = true;
                                mercadoOneTimeEventsVisited = [];
                                return showMercadoHub(data);
                            },
                            ignore_mercado: (data) => {
                                return { description: "Decides que hoy no te apetece el ajetreo del mercado y sigues tu camino.", characterDialog: "Quiz√°s otro d√≠a. Hoy busco paz y tranquilidad." };
                            }
                        }
                    },
                    {
                        id: "rain_with_umbrella_event",
                        description: "Empieza a llover, pero por suerte llevas tu paraguas.",
                        condition: (data) => data.hasUmbrella, // Solo si S√ç tienes paraguas
                        characterDialog: "¬°Menos mal que fui previsor! Ahora puedo disfrutar del sonido de la lluvia.",
                        sceneChange: { backgroundColor: '#708090' },
                        consequences: {
                            proceed: (data) => {
                                data.aburrimiento = Math.max(0, data.aburrimiento - 1.5); // Baja el aburrimiento
                                return { description: "Abres tu paraguas y sigues el paseo tranquilamente, escuchando las gotas caer.", characterDialog: "¬°Me encanta este sonido! Es muy relajante." };
                            }
                        }
                    },
                    {
                        id: "smell_bakery",
                        description: "Pas√°is por delante de una panader√≠a y un delicioso olor a pan reci√©n hecho inunda el aire.",
                        characterDialog: "Mmmm, ¬°qu√© bien huele! De repente me ha entrado un poco de hambre.",
                        consequences: {
                            proceed: (data) => {
                                data.hambre = Math.min(10, data.hambre + 0.5);
                                return { description: "El olor es tentador, pero decid√≠s seguir con vuestro paseo.", characterDialog: "Me comeria una barra entera ahora mismo." };
                            }
                        }
                    },
                    {
                        id: "kids_playing",
                        description: "Veis a un grupo de ni√±os jugando alegremente en un parque.",
                        characterDialog: "¬°Mira c√≥mo se divierten! Me recuerdan a cuando yo era peque√±o.",
                        consequences: {
                            proceed: (data) => {
                                data.aburrimiento = Math.max(0, data.aburrimiento - 0.5);
                                return { description: "La risa de los ni√±os es contagiosa y os saca una sonrisa.", characterDialog: "La vida es para jugar y ser feliz." };
                            }
                        }
                    },
                    {
                        id: "flower_garden",
                        description: "Pas√°is junto a un jard√≠n lleno de flores de todos los colores. El aroma es embriagador.",
                        characterDialog: "¬°Cu√°ntas flores! ¬°Y qu√© bien huelen!",
                        consequences: {
                            proceed: (data) => {
                                data.aburrimiento = Math.max(0, data.aburrimiento - 0.5);
                                return { description: "Os deten√©is un momento para admirar la belleza y el perfume de las flores.", characterDialog: "La naturaleza es incre√≠ble." };
                            }
                        }
                    },
                    {
                        id: "charity_donation",
                        description: "Un puesto de caridad pide donaciones para el refugio de Tamagotchis.",
                        characterDialog: "Parece una buena causa. ¬øDeber√≠amos ayudar?",
                        choices: [
                            { text: "Donar generosamente (100)", action: "donate_generous" },
                            { text: "Donar un poco (20)", action: "donate_small" },
                            { text: "Decir que no tienes dinero", action: "no_donate" }
                        ],
                        consequences: {
                            donate_generous: (data) => {
                                if (data.coins >= 100) {
                                    data.coins -= 100;
                                    updateWalkCoins(-100);
                                    data.karma = Math.min(10, (data.karma || 0) + 4);
                                    return { description: "Donas 100 monedas. El voluntario te lo agradece enormemente.", characterDialog: "¬°Me siento genial por haber ayudado tanto!" };
                                }
                                return { description: "Quieres donar, pero no tienes 100 monedas.", characterDialog: "¬°Oh! Quer√≠a ser m√°s generoso..." };
                            },
                            donate_small: (data) => {
                                if (data.coins >= 20) {
                                    data.coins -= 20;
                                    updateWalkCoins(-20);
                                    data.karma = Math.min(10, (data.karma || 0) + 2);
                                    return { description: "Donas 20 monedas. Todo ayuda.", characterDialog: "¬°Espero que sirva de algo!" };
                                }
                                return { description: "Ni siquiera tienes 20 monedas para donar.", characterDialog: "Qu√© verg√ºenza... no tengo nada." };
                            },
                            no_donate: (data) => {
                                return { description: "Pasas de largo del puesto de caridad.", characterDialog: "Hoy no me siento generoso." };
                            }
                        }
                    }
                ],
                afternoon: [ // De 12:00 a 18:59
                    {
                        id: "ice_cream_truck",
                        description: "¬°Un cami√≥n de helados! La m√∫sica suena alegremente y huele a dulce.",
                        characterDialog: "¬°Helado! ¬°Quiero uno, porfa, porfa, porfa! ¬øMe compras uno?",
                        choices: [
                            { text: "Claro, elige uno (30 monedas)", action: "buy_ice_cream" },
                            { text: "No, es demasiado az√∫car", action: "refuse_ice_cream" }
                        ],
                        consequences: {
                            buy_ice_cream: (data) => {
                                if (data.coins >= 30) {
                                    data.coins -= 30;
                                    // Comprar un helado no tiene un gran impacto k√°rmico, es neutral.
                                    updateWalkCoins(-30);
                                    data.aburrimiento = Math.max(0, data.aburrimiento - 2);
                                    data.hambre = Math.max(0, data.hambre - 0.5);
                                    return { description: "Disfrut√°is de un delicioso helado bajo el sol.", characterDialog: "¬°Yummy! ¬°El mejor paseo de la historia!" };
                                } else {
                                    data.aburrimiento = Math.min(10, data.aburrimiento + 0.5);
                                    data.hambre = Math.min(10, data.hambre + 0.5); // Aumenta el hambre al no poder comprar
                                    return { description: "Miras tu cartera... no hay suficiente dinero. El antojo te ha dejado con m√°s hambre.", characterDialog: "Oh... bueno, no pasa nada. Otro d√≠a ser√°... y ahora tengo m√°s hambre." };
                                }
                            },
                            refuse_ice_cream: (data) => {
                                data.aburrimiento = Math.min(10, data.aburrimiento + 0.5);
                                return { description: "Le explicas que no es bueno tomar tanto dulce y segu√≠s andando.", characterDialog: "Jo... pero es que apetec√≠a mucho..." };
                            }
                        }
                    },
                    {
                        id: "lost_puppy",
                        description: "Ves un peque√±o cachorro perdido, lloriqueando en una esquina.",
                        characterDialog: "¬°Oh, pobrecito! Parece asustado. ¬øQu√© hacemos?",
                        choices: [
                            { text: "Intentar calmarlo y buscar a su due√±o", action: "help_puppy" },
                            { text: "Ignorarlo y seguir andando", action: "ignore_puppy" }
                        ],
                        consequences: {
                            help_puppy: (data) => {
                                data.coins += 20;
                                data.karma = Math.min(10, (data.karma || 0) + 2); // Buena acci√≥n
                                updateWalkCoins(20);
                                data.aburrimiento = Math.max(0, data.aburrimiento - 1.5);
                                return { description: "Tras un rato buscando, encuentras a su due√±a, que te da una peque√±a recompensa. ¬°Qu√© buena acci√≥n!", characterDialog: "¬°Me alegro de haber ayudado! Y adem√°s, ¬°monedas!" };
                            },
                            ignore_puppy: (data) => {
                                data.karma = Math.max(-10, (data.karma || 0) - 1); // Peque√±a mala acci√≥n
                                data.aburrimiento = Math.min(10, data.aburrimiento + 1);
                                return { description: "Decides seguir tu camino, dejando al cachorro atr√°s.", characterDialog: "Espero que alguien lo ayude... Me siento un poco mal." };
                            }
                        }
                    },
                    {
                        id: "lost_wallet",
                        description: "En el suelo, ves una cartera de cuero bastante abultada.",
                        characterDialog: "¬°Mira! ¬°Alguien ha perdido su cartera! ¬øLa cogemos?",
                        choices: [
                            { text: "Cogerla y llevarla a la polic√≠a", action: "return_wallet" },
                            { text: "Coger el dinero y dejar la cartera", action: "steal_money" },
                            { text: "Dejarla donde est√°", action: "ignore_wallet" }
                        ],
                        consequences: {
                            return_wallet: (data) => {
                                data.coins += 50;
                                data.karma = Math.min(10, (data.karma || 0) + 3); // Gran buena acci√≥n
                                updateWalkCoins(50);
                                data.aburrimiento = Math.max(0, data.aburrimiento - 0.5);
                                return { description: "Llev√°is la cartera a la comisar√≠a. El due√±o aparece y os da una recompensa por vuestra honestidad.", characterDialog: "¬°Hacer lo correcto tiene premio!" };
                            },
                            steal_money: (data) => {
                                data.coins += 200;
                                data.karma = Math.max(-10, (data.karma || 0) - 4); // Gran mala acci√≥n
                                updateWalkCoins(200);
                                data.aburrimiento = Math.min(10, data.aburrimiento + 1.5);
                                return { description: "Miras a ambos lados, coges el dinero y dejas la cartera. No hab√≠a nadie.", characterDialog: "¬°Cu√°ntas monedas! Pero... no me siento del todo bien." };
                            },
                            ignore_wallet: (data) => {
                                // Ignorar no es bueno ni malo en este caso.
                                return { description: "Decides que no es asunto tuyo y sigues caminando.", characterDialog: "Mejor no buscarse problemas. Sigamos." };
                            }
                        }
                    },
                    {
                        id: "street_performer",
                        description: "Un m√∫sico callejero toca una melod√≠a preciosa con su guitarra.",
                        characterDialog: "¬°Qu√© bien suena! ¬øNos quedamos un rato a escuchar?",
                        choices: [
                            { text: "S√≠, y darle una propina (10 monedas)", action: "tip_musician" },
                            { text: "Escuchar un poco y seguir", action: "listen_briefly" },
                            { text: "No tenemos tiempo para esto", action: "ignore_musician" }
                        ],
                        consequences: {
                            tip_musician: (data) => {
                                if (data.coins >= 10) {
                                    data.coins -= 10;
                                    data.karma = Math.min(10, (data.karma || 0) + 1); // Peque√±a buena acci√≥n
                                    updateWalkCoins(-10);
                                    data.aburrimiento = Math.max(0, data.aburrimiento - 2.5);
                                    return { description: "Disfrut√°is de la m√∫sica y le dejas una propina. El m√∫sico os sonr√≠e agradecido.", characterDialog: "¬°Ha sido m√°gico! ¬°Me siento superrelajado!" };
                                } else {
                                    data.aburrimiento = Math.max(0, data.aburrimiento - 1.5);
                                    return { description: "Te gustar√≠a darle propina, pero no tienes monedas. Aun as√≠, disfrut√°is de la canci√≥n.", characterDialog: "¬°Qu√© bonito! L√°stima no tener dinero para darle." };
                                }
                            },
                            listen_briefly: (data) => {
                                data.aburrimiento = Math.max(0, data.aburrimiento - 1.5);
                                return { description: "Os par√°is un momento a disfrutar de la melod√≠a antes de continuar vuestro paseo.", characterDialog: "Me ha gustado mucho. ¬°Continuemos!" };
                            },
                            ignore_musician: (data) => {
                                data.karma = Math.max(-10, (data.karma || 0) - 1); // Peque√±a mala acci√≥n (ser un poco borde)
                                data.aburrimiento = Math.min(10, data.aburrimiento + 0.5);
                                return { description: "Decides que no es momento para conciertos y sigues de largo.", characterDialog: "Vaya... bueno, a lo nuestro." };
                            }
                        }
                    },
                    {
                        id: "puddle_splash",
                        description: "Un coche pasa a toda velocidad y os salpica con un charco.",
                        characterDialog: "¬°Agggh! ¬°Estoy todo sucio y mojado! ¬°Qu√© asco!",
                        choices: [
                            { text: "Volver a casa a limpiarse", action: "go_home" },
                            { text: "Secarse un poco y continuar", action: "continue_dirty" }
                        ],
                        consequences: {
                            go_home: (data, endWalkFn) => {
                                data.higiene = Math.min(10, data.higiene + 2.5);
                                endWalkFn(true);
                                return { description: "Decid√≠s que es mejor volver a casa para una buena ducha.", characterDialog: "¬°Se acab√≥ el paseo por hoy! Necesito un ba√±o." };
                            },
                            continue_dirty: (data) => {
                                data.higiene = Math.min(10, data.higiene + 1.5);
                                data.aburrimiento = Math.min(10, data.aburrimiento + 0.5);
                                return { description: "Usas un pa√±uelo para secarlo un poco, pero sigue bastante sucio.", characterDialog: "Ugh, me siento pegajoso. Ya no disfruto tanto del paseo." };
                            }
                        }
                    },
                    {
                        id: "beautiful_sunset",
                        description: "El sol comienza a ponerse, ti√±endo el cielo de colores naranjas y rosas.",
                        characterDialog: "¬°Wow, mira qu√© atardecer! Es precioso...",
                        sceneChange: { backgroundColor: '#FFB6C1' }, /* Rosa claro */
                        consequences: {
                            proceed: (data) => {
                                data.aburrimiento = Math.max(0, data.aburrimiento - 1);
                                return { description: "Os par√°is un momento en silencio, simplemente admirando la vista.", characterDialog: "Momentos as√≠ hacen que todo valga la pena." };
                            }
                        }
                    },
                    {
                        id: "bully_event",
                        description: "Ves a un Tamagotchi grande molestando a uno m√°s peque√±o.",
                        characterDialog: "¬°D√©jale en paz! O... ¬øquiz√°s deber√≠a unirme a √©l?",
                        choices: [
                            { text: "Intervenir y defender", action: "intervene" },
                            { text: "Unirte al mat√≥n", action: "join_bully" },
                            { text: "Ignorar la situaci√≥n", action: "ignore_bully" }
                        ],
                        consequences: {
                            intervene: (data) => {
                                data.karma = Math.min(10, (data.karma || 0) + 3);
                                if (Math.random() < 0.25) { // 25% de probabilidad de perder dinero
                                    const lostCoins = Math.min(data.coins, 50);
                                    data.coins -= lostCoins;
                                    updateWalkCoins(-lostCoins);
                                    return { description: "Intervienes y el mat√≥n se enfada. Tras un forcejeo, se va, pero te ha quitado algo de dinero.", characterDialog: "¬°Al menos el peque√±o est√° bien! Aunque mi cartera no tanto..." };
                                }
                                return { description: "Te enfrentas al mat√≥n y, sorprendentemente, se disculpa y se va. El peque√±o te lo agradece.", characterDialog: "¬°Nadie se mete con los d√©biles cuando yo estoy cerca!" };
                            },
                            join_bully: (data) => {
                                data.karma = Math.max(-10, (data.karma || 0) - 5);
                                data.coins += 30;
                                updateWalkCoins(30);
                                return { description: "Te unes al mat√≥n para re√≠rte del peque√±o. El mat√≥n te da unas monedas por tu 'lealtad'.", characterDialog: "Jeje... bueno, unas monedas son unas monedas." };
                            },
                            ignore_bully: (data) => {
                                data.karma = Math.max(-10, (data.karma || 0) - 2);
                                return { description: "Miras para otro lado y aceleras el paso. No es tu problema.", characterDialog: "Mejor no meterse en l√≠os. Espero que no le pase nada grave." };
                            }
                        }
                    },
                    {
                        id: "street_market",
                        description: "Os top√°is con un mercadillo lleno de puestos con antig√ºedades y curiosidades.",
                        characterDialog: "¬°Cu√°ntas cosas! Hay de todo... ¬øcompramos algo de recuerdo?",
                        choices: [
                            { text: "Comprar objeto misterioso (75)", action: "buy_common" },
                            { text: "Comprar objeto raro (300)", action: "buy_uncommon" },
                            { text: "Solo mirar y seguir", action: "just_look" },
                            { text: "Volver a la plaza", action: "back_to_hub" } // Opci√≥n para volver
                        ],
                        consequences: {
                            buy_common: (data) => {
                                if (data.coins >= 75) {
                                    data.coins -= 75;
                                    updateWalkCoins(-75);
                                    const item = buyMercadilloObject(75);
                                    oneTimeEventsVisited.push('street_market'); // Marcar como visitado
                                    return { description: `Compras un ${item.name} por 75 monedas.`, characterDialog: "¬°Qu√© chulo! Lo guardar√© en mi inventario." };
                                }
                                return { description: "Te encanta el objeto, pero no tienes 75 monedas.", characterDialog: "L√°stima, era muy bonito..." };
                            },
                            buy_uncommon: (data) => {
                                if (data.coins >= 300) {
                                    data.coins -= 300;
                                    updateWalkCoins(-300);
                                    const item = buyMercadilloObject(300);
                                    oneTimeEventsVisited.push('street_market'); // Marcar como visitado
                                    return { description: `Pagas 300 monedas por un ${item.name}.`, characterDialog: "¬°Espero que sea aut√©ntico!" };
                                }
                                return { description: "El objeto es demasiado caro. No puedes permit√≠rtelo.", characterDialog: "300 monedas... ¬°se han pasado un poco!" };
                            },
                            just_look: (data) => {
                                data.aburrimiento = Math.max(0, data.aburrimiento - 0.5);
                                oneTimeEventsVisited.push('street_market'); // Marcar como visitado aunque solo mire
                                return { description: "Dais una vuelta por el mercadillo sin comprar nada y continu√°is el paseo.", characterDialog: "Hab√≠a cosas interesantes, pero mejor ahorrar." };
                            },
                            back_to_hub: (data) => {
                                return showFeriaHub(data); // Vuelve al hub sin hacer nada
                            }
                        }
                    }
                ],
                night: [ // De 19:00 a 05:59
                    {
                        id: "feria_entrance",
                        description: "A lo lejos, ves las luces y oyes la m√∫sica de una feria ambulante.",
                        condition: (data) => !feriaAlreadyVisited, // Solo si no se ha visitado la feria en este paseo
                        characterDialog: "¬°Una feria! ¬°Por favor, vamos! ¬°Tiene que ser super divertido!",
                        choices: [
                            { text: "Entrar a la feria (cuesta 10 monedas)", action: "enter_feria" },
                            { text: "Mejor no, parece cara", action: "ignore_feria" }
                        ],
                        consequences: {
                            enter_feria: (data) => {
                                if (data.coins >= 10) {
                                    oneTimeEventsVisited = []; // Resetea los eventos de un solo uso al entrar
                                    feriaAlreadyVisited = true; // Marca que ya hemos estado aqu√≠
                                    data.feriaEasterEggStep = 0; // Inicializa el contador del easter egg
                                    data.coins -= 10;
                                    updateWalkCoins(-10);
                                    // En lugar de iniciar un modo, mostramos el "hub" de la feria
                                    return showFeriaHub(data);
                                }
                                return { description: "No tienes ni 10 monedas para la entrada. Pas√°is de largo con pena.", characterDialog: "Jo... con las ganas que ten√≠a de ir." };
                            },
                            ignore_feria: (data) => {
                                inFeria = false; // Asegurarse de que no estamos en la feria
                                data.aburrimiento = Math.min(10, data.aburrimiento + 0.5);
                                return { description: "Decides seguir con el paseo y no entrar en la feria.", characterDialog: "Seguro que era aburrida de todas formas..." };
                            }
                        }
                    },
                    {
                        id: "friendly_cat",
                        description: "Un gato amigable se acerca y se frota contra tus piernas, ronroneando.",
                        characterDialog: "¬°Hola, gatito! ¬°Qu√© suave eres!",
                        consequences: {
                            proceed: (data) => {
                                data.aburrimiento = Math.max(0, data.aburrimiento - 1.5);
                                return { description: "Le das unas caricias al gato antes de que siga su camino.", characterDialog: "¬°Me encantan los animales! Me ha alegrado el d√≠a." };
                            }
                        }
                    },
                    {
                        id: "nice_breeze",
                        description: "Una suave y fresca brisa sopla, aliviando el calor del d√≠a.",
                        characterDialog: "Ahhh, qu√© maravilla de brisa. Se est√° genial.",
                        consequences: {
                            proceed: (data) => {
                                data.aburrimiento = Math.max(0, data.aburrimiento - 0.5);
                                return { description: "Cierras los ojos un instante para disfrutar del momento.", characterDialog: "¬°Esto es vida!" };
                            }
                        }
                    },
                    {
                        id: "airplane_sky",
                        description: "Un avi√≥n surca el cielo, dejando una estela blanca a su paso.",
                        characterDialog: "¬øA d√≥nde ir√°? Me pregunto qu√© se sentir√° al volar tan alto.",
                        consequences: {
                            proceed: (data) => {
                                return { description: "Segu√≠s al avi√≥n con la mirada hasta que desaparece en la distancia.", characterDialog: "Alg√∫n d√≠a me gustar√≠a viajar por todo el mundo." };
                            }
                        }
                    },
                    {
                        id: "sudden_trip",
                        description: "¬°Cuidado! Tropiezas con una baldosa suelta, pero consigues mantener el equilibrio.",
                        characterDialog: "¬°Uf, por los pelos! Casi me caigo de bruces.",
                        consequences: {
                            proceed: (data) => {
                                data.higiene = Math.min(10, data.higiene + 0.5);
                                return { description: "Te sacudes el polvo de las manos y sigues con m√°s cuidado.", characterDialog: "Hay que mirar por d√≥nde se pisa." };
                            }
                        }
                    },
                    {
                        id: "restaurant_dinner",
                        description: "Pas√°is por delante de un restaurante elegante con un men√∫ atractivo.",
                        condition: (data) => {
                            const currentHour = new Date().getHours();
                            return currentHour >= 22 && currentHour < 23; // Solo entre las 22:00 y las 23:00
                        },
                        characterDialog: "¬°Qu√© hambre me ha entrado! ¬øCenamos aqu√≠? ¬°Mira qu√© pinta tienen los platos!",
                        choices: [
                            { text: "Men√∫ del Chef (150 monedas)", action: "menu_chef" },
                            { text: "Men√∫ Marinero (200 monedas)", action: "menu_marinero" },
                            { text: "Men√∫ Vegetariano (120 monedas)", action: "menu_vegetariano" },
                            { text: "Men√∫ R√°pido (80 monedas)", action: "menu_rapido" },
                            { text: "No, mejor seguimos", action: "skip_dinner" }
                        ],
                        consequences: {
                            menu_chef: (data) => {
                                if (data.coins >= 150) {
                                    data.coins -= 150;
                                    updateWalkCoins(-150);
                                    data.hambre = Math.max(0, data.hambre - 4); // Buena reducci√≥n de hambre
                                    data.peso = Math.min(100, data.peso + 0.8); // Ligero aumento de peso
                                    return { description: "Disfrut√°is de un exquisito men√∫ del chef: Sopa de calabaza y Solomillo con patatas. ¬°Delicioso!", characterDialog: "¬°Qu√© cena tan rica! ¬°Estoy lleno y feliz!" };
                                }
                                return { description: "No tienes 150 monedas para el Men√∫ del Chef.", characterDialog: "Qu√© pena, ten√≠a muy buena pinta..." };
                            },
                            menu_marinero: (data) => {
                                if (data.coins >= 200) {
                                    data.coins -= 200;
                                    updateWalkCoins(-200);
                                    data.hambre = Math.max(0, data.hambre - 5); // Mejor reducci√≥n de hambre
                                    data.peso = Math.min(100, data.peso + 0.5); // Menor aumento de peso, m√°s saludable
                                    return { description: "Opt√°is por el Men√∫ Marinero: C√≥ctel de gambas y Salm√≥n a la plancha. ¬°Una delicia del mar!", characterDialog: "¬°El marisco y el pescado son mis favoritos! ¬°Qu√© fest√≠n!" };
                                }
                                return { description: "No tienes 200 monedas para el Men√∫ Marinero.", characterDialog: "Uf, es un poco caro para mi bolsillo." };
                            },
                            menu_vegetariano: (data) => {
                                if (data.coins >= 120) {
                                    data.coins -= 120;
                                    updateWalkCoins(-120);
                                    data.hambre = Math.max(0, data.hambre - 3); // Reducci√≥n de hambre moderada
                                    data.peso = Math.min(100, data.peso + 0.3); // M√≠nimo aumento de peso
                                    return { description: "Eleg√≠s el Men√∫ Vegetariano: Ensalada de quinoa y Lasa√±a de verduras. ¬°Ligero y sabroso!", characterDialog: "¬°Me siento ligero y con energ√≠a! ¬°Qu√© buena elecci√≥n!" };
                                }
                                return { description: "No tienes 120 monedas para el Men√∫ Vegetariano.", characterDialog: "Bueno, la verdura es sana, pero no me apetece tanto." };
                            },
                            menu_rapido: (data) => {
                                if (data.coins >= 80) {
                                    data.coins -= 80;
                                    updateWalkCoins(-80);
                                    data.hambre = Math.max(0, data.hambre - 2); // Menor reducci√≥n de hambre
                                    data.peso = Math.min(100, data.peso + 1.2); // Mayor aumento de peso, comida r√°pida
                                    return { description: "Ped√≠s el Men√∫ R√°pido: Patatas fritas y Hamburguesa con queso. ¬°R√°pido y contundente!", characterDialog: "¬°Esto es lo que necesitaba! ¬°Aunque no es lo m√°s sano!" };
                                }
                                return { description: "No tienes 80 monedas para el Men√∫ R√°pido.", characterDialog: "Ni para un men√∫ r√°pido... ¬°qu√© desastre!" };
                            },
                            skip_dinner: (data) => {
                                data.hambre = Math.min(10, data.hambre + 1); // El hambre aumenta ligeramente por saltarse la cena
                                return { description: "Decides que es demasiado caro o no te apetece y sigues el paseo con el est√≥mago vac√≠o.", characterDialog: "Mejor me espero a llegar a casa. Pero tengo un poco m√°s de hambre." };
                            }
                        }
                    },
                    {
                        id: "dark_alley",
                        description: "Ves un callej√≥n oscuro que parece un atajo.",
                        characterDialog: "Podr√≠amos ahorrar tiempo por ah√≠... pero da un poco de miedo.",
                        choices: [
                            { text: "Tomar el atajo", action: "take_shortcut" },
                            { text: "Seguir por el camino principal", action: "main_road" }
                        ],
                        consequences: {
                            take_shortcut: (data) => {
                                if (Math.random() < 0.5) {
                                    data.coins += 50;
                                    updateWalkCoins(50);
                                    return { description: "¬°Qu√© suerte! Encuentras 50 monedas en el suelo del callej√≥n.", characterDialog: "¬°Quien no arriesga, no gana!" };
                                }
                                data.aburrimiento = Math.min(10, data.aburrimiento + 1);
                                return { description: "Un ruido fuerte te asusta y sales corriendo del callej√≥n. No has ahorrado tiempo.", characterDialog: "¬°Ay, qu√© susto! ¬°Nunca m√°s!" };
                            },
                            main_road: (data) => {
                                return { description: "Decides que es mejor ir por lo seguro y sigues el camino iluminado.", characterDialog: "M√°s vale prevenir que curar." };
                            }
                        }
                    },
                    {
                        id: "verbal_fight",
                        description: "Alguien te empuja sin querer y te grita como si fuera tu culpa.",
                        characterDialog: "¬°Pero bueno! ¬°Qu√© modales! ¬øLe digo algo?",
                        choices: [
                            { text: "Disculparse para evitar problemas", action: "apologize" },
                            { text: "Responderle enfadado", action: "argue" },
                            { text: "Ignorarlo y seguir", action: "ignore_fight" }
                        ],
                        consequences: {
                            apologize: (data) => {
                                data.karma = Math.min(10, (data.karma || 0) + 1);
                                return { description: "Aunque no ha sido tu culpa, te disculpas. El otro Tamagotchi se calma y sigue su camino.", characterDialog: "No vale la pena discutir por estas cosas." };
                            },
                            argue: (data) => {
                                data.karma = Math.max(-10, (data.karma || 0) - 1);
                                data.aburrimiento = Math.min(10, data.aburrimiento + 1);
                                return { description: "Le respondes enfadado y empez√°is una discusi√≥n a gritos que no lleva a ninguna parte.", characterDialog: "¬°Qu√© rabia! ¬°Me ha fastidiado el paseo!" };
                            },
                            ignore_fight: (data) => {
                                return { description: "Respiras hondo, lo ignoras y sigues tu camino.", characterDialog: "No voy a dejar que un maleducado me arruine el d√≠a." };
                            }
                        }
                    },
                    {
                        id: "surprise_parade",
                        description: "De repente, un desfile lleno de m√∫sica y color aparece en la calle.",
                        characterDialog: "¬°Qu√© divertido! ¬°Me encanta la m√∫sica!",
                        consequences: {
                            proceed: (data) => {
                                data.aburrimiento = Math.max(0, data.aburrimiento - 2);
                                return { description: "Os qued√°is un rato viendo el desfile. ¬°Qu√© sorpresa tan agradable!", characterDialog: "¬°Esto s√≠ que es un buen paseo!" };
                            }
                        }
                    },
                    {
                        id: "bakery_smell",
                        description: "El delicioso olor de una pasteler√≠a cercana inunda el aire.",
                        characterDialog: "Mmmm... ¬°qu√© bien huele! Me ha entrado hambre.",
                        consequences: {
                            proceed: (data) => {
                                data.hambre = Math.min(10, data.hambre + 1);
                                return { description: "El olor es tan intenso que te ruge el est√≥mago.", characterDialog: "¬°Necesito comer algo, ya!" };
                            }
                        }
                    },
                    {
                        id: "bird_flock",
                        description: "Una gran bandada de p√°jaros levanta el vuelo a tu paso, creando un espect√°culo en el cielo.",
                        characterDialog: "¬°Wow! ¬°Cu√°ntos p√°jaros!",
                        consequences: {
                            proceed: (data) => {
                                data.aburrimiento = Math.max(0, data.aburrimiento - 0.5);
                                return { description: "El movimiento coordinado de los p√°jaros es hipn√≥tico.", characterDialog: "¬°Ha sido impresionante!" };
                            }
                        }
                    },
                    {
                        id: "muddy_puddle",
                        description: "No ves un charco de barro y metes la pata hasta el fondo.",
                        characterDialog: "¬°Puaj! ¬°Qu√© asco, estoy todo sucio!",
                        consequences: {
                            proceed: (data) => {
                                data.higiene = Math.min(10, data.higiene + 2);
                                return { description: "Te has llenado de barro. Definitivamente necesitas una ducha.", characterDialog: "¬°Genial, ahora huelo a tierra mojada!" };
                            }
                        }
                    },
                    {
                        id: "starry_night",
                        description: "El cielo est√° despejado y se pueden ver miles de estrellas.",
                        characterDialog: "¬°Wow! ¬°Mira cu√°ntas estrellas! Es como un manto de diamantes.",
                        consequences: {
                            proceed: (data) => {
                                data.aburrimiento = Math.max(0, data.aburrimiento - 2);
                                return { description: "Os tumb√°is un rato en la hierba a contemplar la inmensidad del universo.", characterDialog: "Me siento tan peque√±o... y a la vez, tan afortunado." };
                            }
                        }
                    },
                    {
                        id: "strange_noise",
                        description: "Escuchas un ruido extra√±o proveniente de unos arbustos cercanos.",
                        characterDialog: "¬øHas o√≠do eso? Me ha dado un poco de miedo...",
                        consequences: {
                            proceed: (data) => {
                                data.aburrimiento = Math.min(10, data.aburrimiento + 0.5);
                                return { description: "Aceler√°is el paso, mirando de reojo hacia los arbustos. Probablemente no era nada.", characterDialog: "Mejor no tentar a la suerte. ¬°V√°monos!" };
                            }
                        }
                    },
                ]
            };

            function buyMercadilloObject(cost) {
                if (!tamagotchiData) return;

                let itemPool;
                if (cost === 75) {
                    itemPool = mercadilloObjects.common;
                } else if (cost === 300) {
                    // --- ¬°NUEVO! Comprobaci√≥n del truco secreto ---
                    const cheatActive = sessionStorage.getItem('secretMercadilloCheat') === 'true';

                    if (cheatActive) {
                        itemPool = mercadilloObjects.rare; // 100% de probabilidad si el truco est√° activo
                        sessionStorage.removeItem('secretMercadilloCheat'); // El truco se usa una vez
                    } else if (Math.random() < 0.01) {
                        // 1% de probabilidad normal de obtener un objeto raro
                        itemPool = mercadilloObjects.rare;
                    } else {
                        itemPool = mercadilloObjects.uncommon;
                    }
                } else {
                    return;
                }

                const randomItem = itemPool[Math.floor(Math.random() * itemPool.length)];

                walkMercadilloInventory.push(randomItem); // A√±ade al inventario temporal del paseo
                return randomItem;
            }

            // --- L√ìGICA DE INICIALIZACI√ìN ---
            function init() {
                try {
                    const data = localStorage.getItem('tamagotchiData');
                    if (!data) {
                        showError("No se encontraron datos del Tamagotchi.");
                        return;
                    }
                    tamagotchiData = JSON.parse(data);
                    if (!tamagotchiData.mercadilloInventory) {
                        tamagotchiData.mercadilloInventory = [];
                    }
                } catch (e) {
                    showError("Error al cargar los datos del Tamagotchi.");
                    return;
                }

                characterDisplay.innerHTML = `<pre>(\\_/)
( ^_^)
(>   <)</pre>`;
                walkCoinDisplay.classList.add('hidden');

                startWalkBtn.addEventListener("click", startWalk);
                exitBtn.addEventListener("click", () => endWalk());

                localStorage.removeItem('walkInProgress');
            }

            function updateWalkCoins(amount) {
                walkCoins += amount;
                const totalSign = walkCoins >= 0 ? '+' : '';
                walkCoinDisplay.textContent = `Paseo: ${totalSign}${walkCoins} ü™ô`;
            }

            function startWalk() {
                if (!tamagotchiData) return;

                localStorage.setItem('walkInProgress', 'true');
                walkInProgress = true;

                walkCoins = 0;
                walkMercadilloInventory = []; // Resetea el inventario temporal
                hasBoughtTombolaTicket = false; // Resetea el ticket de la t√≥mbola
                feriaAlreadyVisited = false; // Resetea la visita a la feria
                mercadoAlreadyVisited = false; // <-- ¬°NUEVO! Resetea visita al mercado
                updateWalkCoins(0);
                walkCoinDisplay.classList.remove('hidden');

                // --- ¬°NUEVO! A√±adir clases para animaciones ---
                // --- ¬°NUEVO! Reiniciar estado de la feria ---
                inFeria = false; // Reinicia el estado de la feria

                inMercado = false; // <-- ¬°NUEVO! Reinicia estado del mercado
                sceneContainer.classList.add("walking");
                characterDisplay.classList.add("walking");

                startWalkBtn.classList.add("hidden");
                exitBtn.classList.remove("hidden");
                eventDescription.textContent = "El paseo ha comenzado. A ver qu√© aventuras te esperan...";
                characterDialog.textContent = "";
                choicesContainer.innerHTML = '';

                scheduleNextEvent();
            }

            function scheduleNextEvent() {
                clearTimeout(eventTimeout);
                if (!walkInProgress) return;

                const delay = Math.random() * 5000 + 8000;
                eventTimeout = setTimeout(triggerRandomEvent, delay);
            }

            function triggerRandomEvent() {
                if (!walkInProgress) return;

                // --- ¬°NUEVO! Determinar el momento del d√≠a ---
                // --- MODIFICADO: Si estamos en la feria o mercado, la l√≥gica cambia ---
                const currentHour = new Date().getHours();
                let eventPool = [];

                // Si estamos en la feria o mercado, no se disparan eventos aleatorios de paseo.
                if (inFeria || inMercado) return;
                // Si estamos en la feria, no se disparan eventos aleatorios de paseo.
                if (inFeria) return;

                if (currentHour >= 6 && currentHour < 12) { // Ma√±ana
                    eventPool = [...timeBasedEvents.morning, ...timeBasedEvents.anytime];
                } else if (currentHour >= 12 && currentHour < 19) { // Tarde
                    eventPool = [...timeBasedEvents.afternoon, ...timeBasedEvents.anytime];
                } else { // Noche
                    eventPool = [...timeBasedEvents.night, ...timeBasedEvents.anytime];
                }


                // --- MODIFICADO: Filtrar eventos del pool actual seg√∫n las condiciones ---
                const availableEvents = eventPool.filter(event => {
                    // Si el evento no tiene condici√≥n, siempre est√° disponible.
                    // Si tiene condici√≥n, se eval√∫a.
                    return !event.condition || event.condition(tamagotchiData);
                });

                const event = availableEvents[Math.floor(Math.random() * availableEvents.length)];
                displayEvent(event);
            }

            function displayEvent(event) {
                currentEvent = event;

                eventDescription.textContent = event.description;
                characterDialog.textContent = event.characterDialog;
                // Se elimina el cambio de color de fondo para mantener el fondo din√°mico general.

                choicesContainer.innerHTML = '';

                if (event.choices) {
                    event.choices.forEach(choice => {
                        const btn = document.createElement('button');
                        btn.textContent = choice.text;
                        btn.className = 'choice-btn';
                        if (choice.action.includes('ignore') || choice.action.includes('refuse')) {
                            btn.classList.add('secondary');
                        }
                        btn.onclick = () => handleChoice(choice.action);
                        choicesContainer.appendChild(btn);
                    });
                } else {
                    // Para eventos no interactivos, simulamos una elecci√≥n autom√°tica para unificar la l√≥gica.
                    setTimeout(() => handleChoice('proceed'), 50);
                }
            }

            // --- ¬°NUEVA FUNCI√ìN! Muestra el men√∫ principal del Mercado de Agricultores ---
            function showMercadoHub(data) {
                clearInterval(mercadoHubInterval);
                mercadoHubInterval = setInterval(() => showMercadoHub(data), 10000); // AUMENTADO: De 8 a 10 segundos

                inMercado = true;

                const allMercadoChoices = [
                    { id: "mercado_frutas", text: "Ir al puesto de frutas" },
                    { id: "mercado_cafe", text: "Probar el caf√© artesanal" },
                    { id: "mercado_ayuda_granjero", text: "Ver al granjero de las cajas" },
                    { id: "mercado_musica", text: "Escuchar al m√∫sico" },
                    { id: "mercado_caja_sorpresa", text: "Ver las 'Cajas de la Cosecha'" },
                    { id: "mercado_concurso_calabaza", text: "Ir al Concurso de Calabazas" },
                    { id: "mercado_tomate_caido", text: "Acercarse al puesto de tomates" }
                ];

                let availableChoices = allMercadoChoices.filter(choice => !mercadoOneTimeEventsVisited.includes(choice.id));

                // Barajar y seleccionar hasta 3 opciones
                let selectedChoices = availableChoices.sort(() => 0.5 - Math.random()).slice(0, 2); // Seleccionamos 2 para dejar espacio a la fuente

                // --- ¬°NUEVA L√ìGICA! La fuente solo aparece si es el siguiente paso del Easter Egg ---
                if (data.mercadoEasterEggStep === 3 && !mercadoOneTimeEventsVisited.includes('mercado_fuente_pueblo')) {
                    selectedChoices.unshift({ id: "mercado_fuente_pueblo", text: "Ir a la fuente del pueblo" });
                }

                // A√±adir siempre la opci√≥n de salir
                selectedChoices.push({ text: "Seguir paseando", action: "exit_mercado" });

                const hubEvent = {
                    id: "mercado_hub",
                    description: "Est√°s en el mercado. Hay puestos con productos frescos y un ambiente muy animado.",
                    characterDialog: "¬øQu√© hacemos ahora? ¬°Todo parece interesante!",
                    choices: selectedChoices.map(c => ({ text: c.text, action: c.id || c.action })),
                    consequences: {
                        exit_mercado: (data) => {
                            inMercado = false;
                            clearInterval(mercadoHubInterval);
                            return { description: "El mercado ha sido agradable, pero es hora de continuar el paseo.", characterDialog: "¬°V√°monos! A ver qu√© m√°s nos depara la ma√±ana." };
                        }
                    }
                };

                // A√±adir consecuencias din√°micas
                selectedChoices.forEach(choice => {
                    const actionId = choice.id || choice.action;
                    if (actionId !== 'exit_mercado') {
                        hubEvent.consequences[actionId] = () => {
                            // Si es la fuente, la marcamos como visitada para que no vuelva a salir en este paseo.
                            if (actionId === 'mercado_fuente_pueblo') {
                                mercadoOneTimeEventsVisited.push('mercado_fuente_pueblo');
                            }
                            const eventToShow = mercadoEvents.find(e => e.id === actionId);
                            clearInterval(mercadoHubInterval); // ¬°CORRECCI√ìN! Detener el refresco al entrar a una atracci√≥n.
                            if (eventToShow) displayEvent(eventToShow);
                        };
                    }
                });

                displayEvent(hubEvent);
                return hubEvent;
            }

            // --- ¬°NUEVA FUNCI√ìN! Para manejar la l√≥gica de la apuesta de calabazas ---
            function handleBet(data, choice, checkOnly = false) {
                if (data.coins < 20) {
                    if (checkOnly) return false;
                    return { description: "No tienes 20 monedas para apostar.", characterDialog: "No me llega para la apuesta..." };
                }

                // --- MODIFICADO: El ganador depende de la pista ---
                let winner;
                // Si tenemos una pista (del Easter Egg) y estamos en el paso correcto, el ganador est√° fijado.
                if (pumpkinHint && data.mercadoEasterEggStep === 1) {
                    winner = pumpkinHint;
                    pumpkinHint = null; // La pista se usa una sola vez.
                } else {
                    winner = ['a', 'b'][Math.floor(Math.random() * 2)]; // Si no, el ganador es aleatorio.
                }

                if (choice === winner) {
                    if (checkOnly) return true;
                    data.coins -= 20; updateWalkCoins(-20);
                    mercadoOneTimeEventsVisited.push('mercado_concurso_calabaza');
                    data.coins += 50;
                    updateWalkCoins(50);
                    return { description: `El granjero pesa las calabazas y... ¬°la ganadora es la ${winner.toUpperCase()}! Has ganado 50 monedas.`, characterDialog: "¬°TOMA! ¬°Qu√© ojo tengo para las calabazas!" };
                } else {
                    if (checkOnly) return false;
                    data.coins -= 20; updateWalkCoins(-20);
                    mercadoOneTimeEventsVisited.push('mercado_concurso_calabaza');
                    return { description: `El granjero pesa las calabazas y... la ganadora es la ${winner.toUpperCase()}. Has perdido tu apuesta.`, characterDialog: "Vaya, por poco. La pr√≥xima vez habr√° m√°s suerte." };
                }
            }


            // --- ¬°NUEVA FUNCI√ìN! Muestra el men√∫ principal de la feria ---
            function showFeriaHub(data) {
                // --- ¬°NUEVO! L√≥gica del temporizador ---
                clearInterval(feriaHubInterval); // Limpia el temporizador anterior si existe
                feriaHubInterval = setInterval(() => showFeriaHub(data), 8000); // Refresca las opciones cada 8 segundos

                inFeria = true;

                const easterEggSequence = ['feria_mago', 'feria_carrusel', 'feria_adivino', 'feria_fuente_secreta'];
                const currentStep = data.feriaEasterEggStep || 0;

                const allFeriaChoices = [
                    { id: "feria_noria", text: "Ir a la Noria" },
                    { id: "feria_tiro_blanco", text: "Probar suerte en el Tiro al Blanco" },
                    { id: "feria_mystery_box", text: "Comprar una Caja Misteriosa" }, // ID corregido para que coincida con el evento
                    { id: "feria_adivino", text: "Visitar al Adivino" },
                    { id: "feria_carrusel", text: "Ver el Carrusel" },
                    { id: "feria_puesto_comida", text: "Ir al Puesto de Comida" },
                    { id: "feria_mago", text: "Acercarse al Mago" },
                    { id: "feria_globo_perdido", text: "Ayudar con el Globo Perdido" },
                    { id: "feria_fuente_secreta", text: "Ir a la fuente del centro" },
                    { id: "feria_tombola", text: "Jugar a la T√≥mbola" },
                    { id: "feria_algodon", text: "Comprar Algod√≥n de Az√∫car" },
                    { id: "feria_casa_terror", text: "Entrar a la Casa del Terror" }
                ];

                // Filtrar las atracciones que no se han visitado (si son de un solo uso)
                let availableChoices = allFeriaChoices.filter(choice => !oneTimeEventsVisited.includes(choice.id));
                let selectedChoices = [];

                // --- ¬°NUEVA L√ìGICA EASTER EGG! ---
                // Si estamos en medio de la secuencia del easter egg...
                if (currentStep > 0 && currentStep < easterEggSequence.length) {
                    const nextRequiredAttractionId = easterEggSequence[currentStep];
                    const nextRequiredAttraction = allFeriaChoices.find(c => c.id === nextRequiredAttractionId);

                    if (nextRequiredAttraction && availableChoices.some(c => c.id === nextRequiredAttractionId)) {
                        selectedChoices.push(nextRequiredAttraction);
                        availableChoices = availableChoices.filter(c => c.id !== nextRequiredAttractionId);
                    }
                }

                // Rellenar el resto de opciones aleatoriamente hasta tener 4
                const shuffledAvailable = availableChoices.sort(() => 0.5 - Math.random());
                while (selectedChoices.length < 4 && shuffledAvailable.length > 0) {
                    selectedChoices.push(shuffledAvailable.shift());
                }

                // Barajar la selecci√≥n final para que la opci√≥n del easter egg no est√© siempre en el mismo sitio
                selectedChoices.sort(() => 0.5 - Math.random());

                // A√±adir siempre la opci√≥n de salir
                selectedChoices.push({ text: "Salir de la feria", action: "exit_feria" });

                const hubEvent = {
                    id: "feria_hub",
                    description: "Est√°is en la plaza principal de la feria. Hay atracciones por todas partes.",
                    characterDialog: "¬øA d√≥nde vamos ahora? ¬°Hay tanto que hacer!",
                    choices: selectedChoices.map(c => ({ text: c.text, action: c.id || c.action })),
                    consequences: {
                        // Las acciones aqu√≠ simplemente disparan el evento correspondiente
                        exit_feria: (data) => { // <-- L√ìGICA MODIFICADA
                            inFeria = false;
                            clearInterval(feriaHubInterval); // Detener el refresco al salir
                            if (hasBoughtTombolaTicket) {
                                // Si se compr√≥ boleto, se revela el resultado ahora.
                                return revealTombolaResult(data);
                            } else {
                                // Si no, simplemente se contin√∫a el paseo.
                                return { description: "La feria ha sido divertida, pero es hora de seguir el paseo.", characterDialog: "¬°V√°monos! A ver qu√© m√°s nos depara la noche." };
                            }
                        }
                    }
                };

                // A√±adir las consecuencias din√°micamente para las atracciones seleccionadas
                selectedChoices.forEach(choice => {
                    const actionId = choice.id || choice.action;
                    if (actionId !== 'exit_feria') {
                        hubEvent.consequences[actionId] = () => {
                            const eventToShow = feriaEvents.find(e => e.id === actionId);
                            clearInterval(feriaHubInterval); // ¬°CORRECCI√ìN! Detener el refresco al entrar a una atracci√≥n.
                            if (eventToShow) displayEvent(eventToShow);
                        };
                    }
                });

                // Usamos displayEvent para mostrar el hub, pero devolvemos el objeto para que la funci√≥n que lo llam√≥ lo procese.
                displayEvent(hubEvent);
                return hubEvent; // Devolvemos el evento para que se muestre correctamente
            }

            function handleChoice(action) {
                if (!currentEvent || !walkInProgress) return;

                clearInterval(feriaHubInterval); // Detiene el refresco de la feria al tomar cualquier decisi√≥n

                choicesContainer.querySelectorAll('button').forEach(btn => btn.disabled = true);

                // --- ¬°NUEVO! L√≥gica para el Easter Egg "El Secreto del Granjero" ---
                const easterEggSequence = ['mercado_ayuda_granjero', 'mercado_concurso_calabaza', 'mercado_cafe', 'mercado_fuente_pueblo'];
                const currentStep = tamagotchiData.mercadoEasterEggStep || 0;
                const eventId = currentEvent.id;

                // Comprueba si la acci√≥n actual es la correcta en la secuencia
                if (eventId === easterEggSequence[currentStep]) {
                    // Caso especial para el concurso: solo avanza si se gana.
                    if (eventId === 'mercado_concurso_calabaza' && action.startsWith('bet_') && handleBet(tamagotchiData, action.slice(-1), true)) {
                        tamagotchiData.mercadoEasterEggStep = currentStep + 1;
                    } else if (eventId !== 'mercado_concurso_calabaza') {
                        tamagotchiData.mercadoEasterEggStep = currentStep + 1;
                    }
                } else if (eventId !== 'mercado_hub' && !eventId.startsWith('mercado_concurso_calabaza')) { // Si se hace otra acci√≥n, se rompe la cadena
                    tamagotchiData.mercadoEasterEggStep = 0;
                }

                // Si la acci√≥n es una atracci√≥n del mercado, la consecuencia es mostrar esa atracci√≥n.
                if (action.startsWith('mercado_') && currentEvent.id === 'mercado_hub') {
                    const consequenceFn = currentEvent.consequences[action];
                    if (consequenceFn) consequenceFn();
                    return;
                }

                let consequence = currentEvent.consequences[action];

                // Si la acci√≥n es una atracci√≥n de la feria, la consecuencia es mostrar esa atracci√≥n.
                if (action.startsWith('feria_') && currentEvent.id === 'feria_hub') {
                    // --- L√ìGICA DEL EASTER EGG (REUBICADA) ---
                    // Se ejecuta ANTES de mostrar la atracci√≥n para que el log aparezca.
                    const easterEggSequence = ['feria_mago', 'feria_carrusel', 'feria_adivino', 'feria_fuente_secreta'];
                    const currentStep = tamagotchiData.feriaEasterEggStep || 0;

                    if (action === easterEggSequence[currentStep]) {
                        tamagotchiData.feriaEasterEggStep = currentStep + 1;
                        console.log(`Progresi√≥n ${tamagotchiData.feriaEasterEggStep}/4`);
                    } else if (action !== 'exit_feria') {
                        if (tamagotchiData.feriaEasterEggStep > 0) {
                            console.log("Easter egg interrumpido.");
                        }
                        tamagotchiData.feriaEasterEggStep = 0;
                    }
                    if (action === 'feria_mystery_box') {
                        oneTimeEventsVisited.push('feria_mystery_box');
                    }

                    // La consecuencia es una funci√≥n que llama a displayEvent. La ejecutamos directamente.
                    consequence();
                    return; // Este return ahora es correcto, despu√©s de procesar el log.
                }

                // --- ¬°NUEVO! L√≥gica para mostrar cambios de stats ---
                // 1. Guardamos una copia del estado ANTES de la consecuencia
                const oldData = JSON.parse(JSON.stringify(tamagotchiData));

                if (consequence) {
                    const result = consequence(tamagotchiData);

                    // 2. Comparamos el estado nuevo con el viejo y mostramos los cambios
                    compareAndShowChanges(oldData, tamagotchiData);

                    // --- ¬°NUEVO! 3. Comprobamos si alguna estad√≠stica est√° en nivel cr√≠tico ---
                    checkCriticalStats();

                    if (walkInProgress) {
                        eventDescription.textContent = result.description;
                        characterDialog.textContent = result.characterDialog;
                        // Si el evento no termina el paseo, actualizamos el di√°logo
                        if (result) {
                            eventDescription.textContent = result.description;
                            characterDialog.textContent = result.characterDialog;
                        }

                        setTimeout(() => {
                            // --- MODIFICADO: Si est√°bamos en la feria, volvemos al hub ---
                            if (inMercado) {
                                showMercadoHub(tamagotchiData);
                            } else if (inFeria) {
                                showFeriaHub(tamagotchiData);
                            } else if (!inFeria) {
                                choicesContainer.innerHTML = '';
                                scheduleNextEvent();
                            }
                        }, 3500);
                    }

                }
            }

            // --- ¬°NUEVO! Variable para controlar la posici√≥n de los indicadores ---
            let statChangeYOffset = 0;

            // --- ¬°NUEVA FUNCI√ìN! Para mostrar el texto flotante ---
            function showStatChange(text, type) {
                const statElement = document.createElement('div');
                statElement.textContent = text;
                statElement.className = `stat-change ${type}`;

                // --- MODIFICADO: Posicionamiento para evitar solapamiento ---
                // Alterna la posici√≥n horizontal y aumenta la vertical para cada nuevo indicador
                const horizontalPosition = (statChangeYOffset % 2 === 0) ? '25%' : '55%';
                statElement.style.left = horizontalPosition;
                statElement.style.top = `${50 + statChangeYOffset * 10}%`;
                statChangeYOffset++;

                statChangesContainer.appendChild(statElement);

                // Eliminar el elemento despu√©s de la animaci√≥n
                setTimeout(() => {
                    statElement.remove();
                }, 2500);

                // Resetea el offset vertical despu√©s de un tiempo para que no se vayan muy abajo
                setTimeout(() => {
                    statChangeYOffset = 0;
                }, 1000);
            }

            // --- ¬°NUEVA FUNCI√ìN! Para comparar estados y llamar a showStatChange ---
            function compareAndShowChanges(oldData, newData) {
                const changes = {
                    hambre: newData.hambre - oldData.hambre,
                    aburrimiento: newData.aburrimiento - oldData.aburrimiento,
                    higiene: newData.higiene - oldData.higiene,
                    sueno: newData.sueno - oldData.sueno,
                    karma: (newData.karma || 0) - (oldData.karma || 0),
                    coins: newData.coins - oldData.coins
                };

                // Mapeo de nombres para mostrar
                const statNames = {
                    hambre: "Hambre",
                    aburrimiento: "Aburrimiento",
                    higiene: "Higiene",
                    sueno: "Sue√±o",
                    karma: "Karma",
                    coins: "Monedas"
                };

                for (const stat in changes) {
                    const diff = changes[stat];
                    if (Math.abs(diff) > 0.01) { // Usamos un umbral peque√±o para evitar errores de flotantes
                        const sign = diff > 0 ? '+' : '';
                        const type = (stat === 'hambre' || stat === 'aburrimiento' || stat === 'higiene' || stat === 'sueno')
                            ? (diff > 0 ? 'negative' : 'positive')
                            : (stat === 'coins')
                                ? 'neutral'
                                : (diff > 0 ? 'positive' : 'negative');
                        // Para monedas, no mostramos decimales
                        const valueString = (stat === 'coins') ? diff.toFixed(0) : diff.toFixed(1);
                        showStatChange(`${sign}${valueString} ${statNames[stat]}`, type);
                    }
                }
            }

            // --- ¬°NUEVA FUNCI√ìN! Para avisar de estados cr√≠ticos ---
            function checkCriticalStats() {
                const warningContainer = document.getElementById('critical-warning-container');
                if (!warningContainer || !tamagotchiData) return;

                const warnings = [];
                const threshold = 6; // MODIFICADO: Umbral bajado al 60% (6/10)

                if (tamagotchiData.hambre >= threshold) warnings.push(`${tamagotchiData.nombre} tiene much√≠sima hambre.`);
                if (tamagotchiData.aburrimiento >= threshold) warnings.push(`${tamagotchiData.nombre} est√° extremadamente aburrido.`);
                if (tamagotchiData.higiene >= threshold) warnings.push(`${tamagotchiData.nombre} necesita una ducha urgentemente.`);
                if (tamagotchiData.sueno >= threshold) warnings.push(`${tamagotchiData.nombre} est√° a punto de desmayarse de sue√±o.`);

                if (warnings.length > 0) {
                    // Mostramos el primer aviso cr√≠tico.
                    warningContainer.textContent = `${warnings[0]} ¬°Deber√≠as volver a casa!`;
                    warningContainer.style.display = 'block';
                    // Desactivamos la aparici√≥n de nuevos eventos para no empeorar la situaci√≥n
                    clearTimeout(eventTimeout);
                    choicesContainer.innerHTML = '<p style="text-align: center; font-weight: bold;">No puedes continuar el paseo en este estado.</p>';
                } else {
                    // Si no hay avisos, nos aseguramos de que el contenedor est√© oculto.
                    warningContainer.style.display = 'none';
                }
            }


            function endWalk() {
                localStorage.removeItem('walkInProgress');
                walkInProgress = false;
                clearTimeout(eventTimeout);
                clearInterval(feriaHubInterval); // Asegurarse de que el temporizador de la feria se detiene
                clearInterval(mercadoHubInterval); // <-- ¬°NUEVO! Detener tambi√©n el del mercado

                // --- ¬°NUEVO! Eliminar clases de animaci√≥n ---
                sceneContainer.classList.remove("walking");
                characterDisplay.classList.remove("walking");

                choicesContainer.innerHTML = '';
                walkCoinDisplay.classList.add('hidden');

                // --- ¬°NUEVA L√ìGICA DE KARMA AL FINALIZAR! ---
                if (tamagotchiData && tamagotchiData.karma < 0) {
                    // Evento de ladr√≥n por karma negativo
                    exitBtn.classList.add('hidden');
                    eventDescription.textContent = "De camino a casa, por una calle poco iluminada, un extra√±o te detiene...";
                    characterDialog.textContent = '"¬°Esto es un atraco! ¬°Dame todo lo que tienes!"';

                    // El ladr√≥n te roba las monedas que has conseguido durante el paseo.
                    // Simplemente revertimos las ganancias/p√©rdidas del paseo.
                    tamagotchiData.coins -= walkCoins;
                    // Los objetos del mercadillo (walkMercadilloInventory) no se a√±aden, as√≠ que se pierden.

                    setTimeout(() => {
                        localStorage.setItem('tamagotchiData', JSON.stringify(tamagotchiData));
                        localStorage.setItem('walkGameResult', 'finished');
                        window.location.href = "index.html";
                    }, 4000);

                } else {
                    // Final normal, con karma bueno o neutral
                    exitBtn.classList.add('hidden');
                    eventDescription.textContent = "Decides que es hora de volver. El camino de vuelta a casa es tranquilo.";
                    characterDialog.textContent = "¬°Qu√© buen paseo! Ya tengo ganas de descansar en casa.";
                    // A√±adir los objetos del mercadillo al inventario principal
                    tamagotchiData.mercadilloInventory.push(...walkMercadilloInventory);
                    localStorage.setItem('tamagotchiData', JSON.stringify(tamagotchiData));
                    localStorage.setItem('walkGameResult', 'finished');
                    setTimeout(() => { window.location.href = "index.html"; }, 4000);
                }
            }

            // --- ¬°NUEVA FUNCI√ìN! Para revelar el resultado de la t√≥mbola al salir de la feria ---
            function revealTombolaResult(data) {
                let resultDescription, resultDialog;
                hasBoughtTombolaTicket = false; // Se resetea el ticket una vez se revela el resultado.

                // El resultado final depende directamente del karma acumulado
                if (data.karma >= 13) {
                    const rareItem = mercadilloObjects.rare[Math.floor(Math.random() * mercadilloObjects.rare.length)];
                    walkMercadilloInventory.push(rareItem);
                    resultDescription = `Al salir de la feria, anuncian el n√∫mero de la t√≥mbola y... ¬°Tu n√∫mero es el ganador! ¬°Has ganado el premio gordo: un ${rareItem.name}!`;
                    resultDialog = "¬°NO ME LO PUEDO CREER! ¬°SOMOS RICOS!";
                } else if (data.karma > 0) { // Karma bueno
                    data.coins += 600;
                    updateWalkCoins(600);
                    resultDescription = "Al salir de la feria, anuncian el n√∫mero de la t√≥mbola y... ¬°Tu n√∫mero ha sido premiado! Ganas 600 monedas.";
                    resultDialog = "¬°Genial! ¬°Hemos salido ganando!";
                } else if (data.karma <= -5) { // Karma muy malo
                    const lostCoins = Math.min(walkCoins, 150); // Pierdes lo ganado en el paseo, hasta 150
                    data.coins -= lostCoins;
                    updateWalkCoins(-lostCoins);
                    resultDescription = "Al salir de la feria, anuncian el n√∫mero de la t√≥mbola y no es el tuyo. Adem√°s, en el barullo de la salida, te das cuenta de que has perdido parte del dinero que encontraste.";
                    resultDialog = "¬°Esto es un timo! ¬°Y encima pierdo dinero!";
                } else { // Karma malo o neutral
                    resultDescription = "Anuncian el n√∫mero de la t√≥mbola, pero no es el tuyo. La feria ha sido divertida, pero es hora de seguir el paseo.";
                    resultDialog = "Vaya, no ha habido suerte. Bueno, al menos nos hemos divertido.";
                }
                return { description: resultDescription, characterDialog: resultDialog };
            }

            function showError(message) {
                eventDescription.textContent = message;
                characterDialog.textContent = "Por favor, vuelve al men√∫ principal.";
                startWalkBtn.classList.add("hidden");
                exitBtn.classList.remove("hidden");
            }

            init();
        });
    </script>
</body>

</html>