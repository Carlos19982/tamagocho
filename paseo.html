<!DOCTYPE html>
<html lang="es">
<head>
    <link rel="stylesheet" type="text/css" href="style.css?v=1.8" />
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Paseo con Tamagotchi</title>
    <style>
        body {
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            overflow: hidden;
            font-family: 'Courier New', Courier, monospace;
            background-color: #f4f4f4; /* Fondo de la pÃ¡gina de paseo */
            user-select: none;
            -webkit-user-select: none;
        }

        #walk-container {
            width: 95%;
            max-width: 600px;
            background: white;
            border: 2px solid #555;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
            text-align: center;
            display: flex;
            flex-direction: column;
        }

        h1 {
            color: #333;
            border-bottom: 2px dashed #ccc;
            padding-bottom: 10px;
            margin-top: 0;
        }

        #scene-container {
            position: relative;
            width: 100%;
            height: 250px;
            background-color: #87CEEB; /* Cielo azul por defecto */
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 20px;
            display: flex;
            justify-content: center;
            align-items: flex-end;
            transition: background-color 1s ease;
        }
        
        /* --- Â¡NUEVO! AnimaciÃ³n de fondo en movimiento --- */
        #scene-container.walking {
            /* Imagen de nubes SVG repetible incrustada como data URI */
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='800' height='250'%3E%3Cdefs%3E%3Csymbol id='c'%3E%3Cpath fill='rgba(255,255,255,0.8)' d='M75 50 C85 50 95 40 95 30 C95 20 85 10 75 10 C70 10 65 12 60 15 C55 5 45 0 35 0 C20 0 10 10 10 25 C10 26 10 27 11 28 C5 30 0 35 0 40 C0 45 5 50 10 50 Z'/%3E%3C/symbol%3E%3C/defs%3E%3Cuse href='%23c' x='50' y='30' transform='scale(1.2)'/%3E%3Cuse href='%23c' x='250' y='50' transform='scale(1.5)'/%3E%3Cuse href='%23c' x='450' y='20' transform='scale(1)'/%3E%3Cuse href='%23c' x='650' y='60' transform='scale(1.3)'/%3E%3C/svg%3E");
            background-repeat: repeat-x;
            background-size: auto 100%;
            animation: scroll-background 30s linear infinite;
        }

        @keyframes scroll-background {
            from { background-position: 0 0; }
            to { background-position: -800px 0; } /* Coincide con el ancho del SVG */
        }

        /* --- Â¡NUEVO! AnimaciÃ³n de caminata para el personaje --- */
        #character-display.walking {
            animation: walk-bob 0.8s ease-in-out infinite;
        }

        #character-display {
            font-size: 2.5rem;
            white-space: pre;
            line-height: 1.2;
            z-index: 10;
            transition: transform 0.5s ease;
        }

        #dialog-box {
            border: 2px solid #333;
            background-color: #fdfdfd;
            border-radius: 8px;
            padding: 15px;
            min-height: 120px;
            text-align: left;
            font-size: 1.1rem;
            color: #444;
            margin-bottom: 20px;
        }

        #event-description {
            font-style: italic;
            color: #666;
        }

        #character-dialog {
            font-weight: bold;
        }

        #choices-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
            min-height: 50px; /* Espacio reservado para botones */
        }

        .choice-btn {
            padding: 12px 20px;
            font-family: 'Courier New', Courier, monospace;
            font-weight: bold;
            font-size: 1rem;
            color: white;
            background-color: #007bff;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .choice-btn:hover {
            background-color: #0056b3;
        }

        .choice-btn.secondary {
            background-color: #6c757d;
        }

        .choice-btn.secondary:hover {
            background-color: #5a6268;
        }

        .hidden {
            display: none;
        }

        /* --- Â¡NUEVO! Estilos para los indicadores de stats --- */
        #stat-changes-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none; /* Para que no interfiera con los clics */
            overflow: hidden;
            z-index: 20;
        }

        .stat-change {
            position: absolute;
            font-size: 1.3rem;
            font-weight: bold;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.6);
            animation: float-up 2.5s ease-out forwards;
        }

        .stat-change.positive { color: #4CAF50; } /* Verde para mejoras */
        .stat-change.negative { color: #F44336; } /* Rojo para empeoramientos */
        .stat-change.neutral { color: #2196F3; }  /* Azul para cambios neutrales como monedas */

        @keyframes float-up {
            0% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-60px); }
        }
        /* --- Fin de nuevos estilos --- */

        /* --- Â¡NUEVO! AnimaciÃ³n de balanceo al caminar --- */
        @keyframes walk-bob {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-8px); }
        }

        /* --- Â¡NUEVO! Estilos para la alerta de estado crÃ­tico --- */
        #critical-warning-container {
            background-color: #F44336; /* Rojo */
            color: white;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            font-weight: bold;
            text-align: center;
            animation: pulse-bg 1.5s infinite;
            display: none; /* Oculto por defecto */
        }

        @keyframes pulse-bg {
            0% { background-color: #F44336; }
            50% { background-color: #c62828; }
            100% { background-color: #F44336; }
        }
        /* --- Fin de nuevos estilos --- */

        @media (max-width: 600px) {
            #character-display {
                font-size: 2rem;
            }
            h1 {
                font-size: 1.5rem;
            }
            #dialog-box {
                font-size: 1rem;
            }
        }
    </style>
    <!-- Â¡NUEVO! Estructura para la escena de abandono -->
    <style>
        #abandonment-scene {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #111;
            color: white;
            display: none; /* Oculto por defecto */
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            z-index: 1000;
            padding: 20px;
            font-family: 'Courier New', Courier, monospace;
        }

        #abandonment-character {
            font-size: 3rem;
            white-space: pre;
            margin-bottom: 20px;
        }

        #abandonment-dialog {
            font-size: 1.5rem;
            min-height: 100px;
            max-width: 80%;
        }

        #abandonment-dialog::after {
            content: 'â–‹';
            animation: blink 1s step-end infinite;
        }

        @keyframes blink {
            50% { opacity: 0; }
        }
    </style>
</head>
<body>

    <!-- Â¡NUEVO! Contenedor para la escena de abandono -->
    <div id="abandonment-scene">
        <div id="abandonment-character">
            <!-- El personaje de la escena se cargarÃ¡ aquÃ­ -->
        </div>
        <div id="abandonment-dialog">
            <!-- El diÃ¡logo de la escena se cargarÃ¡ aquÃ­ -->
        </div>
    </div>

    <div id="walk-container">
        <h1>De Paseo</h1>
        <div id="critical-warning-container"></div>
        <div id="scene-container">
            <div id="stat-changes-container"></div>
            <div id="walk-coin-display" class="hidden" style="position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.5); color: white; padding: 5px 10px; border-radius: 5px; font-size: 0.9rem;">Paseo: 0 ðŸª™</div>
            <div id="character-display">
                <!-- El personaje se cargarÃ¡ aquÃ­ -->
            </div>
        </div>
        <div id="dialog-box">
            <p id="event-description">El dÃ­a es perfecto para un paseo.</p>
            <p id="character-dialog">"Â¡QuÃ© bien se estÃ¡ aquÃ­ fuera!"</p>
        </div>
        <div id="choices-container">
            <!-- Los botones de eventos aparecerÃ¡n aquÃ­ -->
        </div>
        <div id="action-buttons" style="margin-top: 10px; display: flex; flex-direction: column; gap: 10px;">
            <button id="start-walk-btn" class="choice-btn">Empezar Paseo</button>
            <button id="exit-btn" class="choice-btn secondary hidden">Terminar Paseo y Volver</button>
        </div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            // --- LÃ“GICA DE ABANDONO ---
            // Si el usuario recarga la pÃ¡gina mientras el paseo estÃ¡ activo, se considera abandono.
            if (localStorage.getItem('walkInProgress') === 'true') {
                showAbandonmentScene();
                return; // Detenemos la ejecuciÃ³n normal del paseo.
            }

            function typeWriter(element, text, onComplete) {
                let i = 0;
                element.innerHTML = ''; // Limpiar el contenido anterior
                function type() {
                    if (i < text.length) {
                        element.innerHTML += text.charAt(i);
                        i++;
                        setTimeout(type, 80); // Velocidad de escritura
                    } else {
                        if (onComplete) onComplete();
                    }
                }
                type();
            }

            function showAbandonmentScene() {
                document.getElementById('walk-container').style.display = 'none';
                const scene = document.getElementById('abandonment-scene');
                const charDisplay = document.getElementById('abandonment-character');
                const dialogDisplay = document.getElementById('abandonment-dialog');
                scene.style.display = 'flex';

                charDisplay.innerHTML = `<pre>(\\_/)\n( T_T )\n(>   <)</pre>`; // Cara triste
                const tamagotchiDialog = "Â¿Me has abandonado?... Amo tonto...";

                typeWriter(dialogDisplay, tamagotchiDialog, () => {
                    // Pausa de 2.5 segundos despuÃ©s del diÃ¡logo
                    setTimeout(() => {
                        // 60% de probabilidad de ser atracado
                        if (Math.random() < 0.60) {
                            showMuggingScene();
                        } else {
                            // 40% de volver a salvo
                            localStorage.setItem('walkGameResult', 'abandoned_safe');
                            localStorage.removeItem('walkInProgress');
                            window.location.href = 'index.html';
                        }
                    }, 2500);
                });
            }

            function showMuggingScene() {
                const charDisplay = document.getElementById('abandonment-character');
                const dialogDisplay = document.getElementById('abandonment-dialog');
                
                charDisplay.innerHTML = `<pre> >:( </pre>`; // Cara de atracador
                const muggerDialog = "Â¡Quieto ahÃ­! Dame todo lo que has conseguido en el paseo...";

                typeWriter(dialogDisplay, muggerDialog, () => {
                    // Pausa de 3 segundos para leer el mensaje del atracador
                    setTimeout(() => {
                        localStorage.setItem('walkGameResult', 'abandoned_mugged');
                        // No se guardan monedas ni objetos, se pierden.
                        localStorage.removeItem('walkInProgress');
                        window.location.href = 'index.html';
                    }, 3000);
                });
            }

            // --- ELEMENTOS DEL DOM ---
            const characterDisplay = document.getElementById("character-display");
            const eventDescription = document.getElementById("event-description");
            const characterDialog = document.getElementById("character-dialog");
            const choicesContainer = document.getElementById("choices-container");
            const startWalkBtn = document.getElementById("start-walk-btn");
            const statChangesContainer = document.getElementById("stat-changes-container");
            const exitBtn = document.getElementById("exit-btn");
            const sceneContainer = document.getElementById("scene-container");
            const walkCoinDisplay = document.getElementById("walk-coin-display");

            // --- DATOS DEL JUEGO ---
            let tamagotchiData = null;
            let walkInProgress = false;
            let eventTimeout = null; // Para controlar el temporizador de eventos
            let currentEvent = null; // Para guardar el evento activo
            let walkCoins = 0;
            let walkMercadilloInventory = []; // <-- Â¡NUEVO! Inventario temporal para el paseo

            const mercadilloObjects = {
              common: [
                { id: 'reloj_casio', name: 'Reloj Casio', value: [50, 100] },
                { id: 'taza_cafe', name: 'Taza de cafÃ©', value: [50, 100] },
                { id: 'libro_viejo', name: 'Libro viejo', value: [50, 100] },
                { id: 'poster_pelicula', name: 'PÃ³ster de pelÃ­cula', value: [50, 100] },
                { id: 'planta_plastico', name: 'Planta de plÃ¡stico', value: [50, 100] },
                { id: 'figura_accion', name: 'Figura de acciÃ³n', value: [50, 100] },
                { id: 'gorra', name: 'Gorra', value: [50, 100] },
                { id: 'gafas_sol', name: 'Gafas de sol', value: [50, 100] },
                { id: 'llavero', name: 'Llavero', value: [50, 100] },
                { id: 'comic', name: 'CÃ³mic', value: [50, 100] }
              ],
              uncommon: [
                { id: 'vinilo_antiguo', name: 'Vinilo antiguo', value: [200, 400] },
                { id: 'camara_fotos', name: 'CÃ¡mara de fotos', value: [200, 400] },
                { id: 'walkman', name: 'Walkman', value: [200, 400] },
                { id: 'consola_retro', name: 'Consola retro', value: [200, 400] },
                { id: 'maquina_escribir', name: 'MÃ¡quina de escribir', value: [200, 400] },
                { id: 'telefono_antiguo', name: 'TelÃ©fono antiguo', value: [200, 400] },
                { id: 'mapa_antiguo', name: 'Mapa antiguo', value: [200, 400] },
                { id: 'joya_plata', name: 'Joya de plata', value: [200, 400] }
              ],
              rare: [
                { id: 'pepita_oro', name: 'Pepita de oro', value: [4000, 6000] },
                { id: 'diamante', name: 'Diamante', value: [4000, 6000] }
              ]
            };

            // --- DEFINICIÃ“N DE EVENTOS ---
            const walkEvents = [
                {
                    id: "rain_event",
                    description: "De repente, el cielo se nubla y empieza a llover.",
                    condition: (data) => !data.hasUmbrella, // <-- Â¡NUEVO! Solo si NO tienes paraguas
                    characterDialog: "Â¡Oh no, lluvia! Â¡Odio mojarme! Cerca hay una tienda...",
                    sceneChange: { backgroundColor: '#708090' },
                    choices: [
                        { text: "Comprar paraguas (50 monedas)", action: "buy_umbrella" },
                        { text: "No importa, seguir andando", action: "ignore_rain" }
                    ],
                    consequences: {
                        buy_umbrella: (data) => {
                            if (data.coins >= 50) {
                                data.hasUmbrella = true; // <-- Â¡NUEVO! Marcamos que ya lo tiene
                                data.coins -= 50;
                                data.karma = Math.min(10, (data.karma || 0) + 1); // PequeÃ±a buena acciÃ³n (previsiÃ³n)
                                updateWalkCoins(-50);
                                data.aburrimiento = Math.max(0, data.aburrimiento - 1.5);
                                return { description: "Con el paraguas nuevo, la lluvia ya no es un problema.", characterDialog: "Â¡Menos mal! Ahora puedo seguir disfrutando." };
                            } else {
                                data.higiene = Math.min(10, data.higiene + 1.5);
                                data.aburrimiento = Math.min(10, data.aburrimiento + 1);
                                return { description: "No tienes suficiente dinero. Te estÃ¡s empapando.", characterDialog: "Â¡Buah, quÃ© mala suerte! Estoy calado hasta los huesos." };
                            }
                        },
                        ignore_rain: (data) => {
                            data.higiene = Math.min(10, data.higiene + 2);
                            data.aburrimiento = Math.min(10, data.aburrimiento + 0.5);
                            return { description: "Decides ignorar la lluvia y seguir tu camino.", characterDialog: "Brrr, Â¡quÃ© frÃ­o! Y quÃ© sucio me estoy poniendo." };
                        }
                    }
                },
                // --- Â¡NUEVO EVENTO! ---
                {
                    id: "rain_with_umbrella_event",
                    description: "Empieza a llover, pero por suerte llevas tu paraguas.",
                    condition: (data) => data.hasUmbrella, // <-- Â¡NUEVO! Solo si SÃ tienes paraguas
                    characterDialog: "Â¡Menos mal que fui previsor! Ahora puedo disfrutar del sonido de la lluvia.",
                    sceneChange: { backgroundColor: '#708090' },
                    consequences: {
                        proceed: (data) => {
                            data.aburrimiento = Math.max(0, data.aburrimiento - 1.5); // Baja el aburrimiento
                            return { description: "Abres tu paraguas y sigues el paseo tranquilamente, escuchando las gotas caer.", characterDialog: "Â¡Me encanta este sonido! Es muy relajante." };
                        }
                    }
                },
                {
                    id: "ice_cream_truck",
                    description: "Â¡Un camiÃ³n de helados! La mÃºsica suena alegremente y huele a dulce.",
                    characterDialog: "Â¡Helado! Â¡Quiero uno, porfa, porfa, porfa! Â¿Me compras uno?",
                    choices: [
                        { text: "Claro, elige uno (30 monedas)", action: "buy_ice_cream" },
                        { text: "No, es demasiado azÃºcar", action: "refuse_ice_cream" }
                    ],
                    consequences: {
                        buy_ice_cream: (data) => {
                            if (data.coins >= 30) {
                                data.coins -= 30;
                                // Comprar un helado no tiene un gran impacto kÃ¡rmico, es neutral.
                                updateWalkCoins(-30);
                                data.aburrimiento = Math.max(0, data.aburrimiento - 2);
                                data.hambre = Math.max(0, data.hambre - 0.5);
                                return { description: "DisfrutÃ¡is de un delicioso helado bajo el sol.", characterDialog: "Â¡Yummy! Â¡El mejor paseo de la historia!" };
                            } else {
                                data.aburrimiento = Math.min(10, data.aburrimiento + 0.5);
                                return { description: "Miras tu cartera... no hay suficiente dinero.", characterDialog: "Oh... bueno, no pasa nada. Otro dÃ­a serÃ¡." };
                            }
                        },
                        refuse_ice_cream: (data) => {
                            data.aburrimiento = Math.min(10, data.aburrimiento + 0.5);
                            return { description: "Le explicas que no es bueno tomar tanto dulce y seguÃ­s andando.", characterDialog: "Jo... pero es que apetecÃ­a mucho..." };
                        }
                    }
                },
                {
                    id: "lost_puppy",
                    description: "Ves un pequeÃ±o cachorro perdido, lloriqueando en una esquina.",
                    characterDialog: "Â¡Oh, pobrecito! Parece asustado. Â¿QuÃ© hacemos?",
                    choices: [
                        { text: "Intentar calmarlo y buscar a su dueÃ±o", action: "help_puppy" },
                        { text: "Ignorarlo y seguir andando", action: "ignore_puppy" }
                    ],
                    consequences: {
                        help_puppy: (data) => {
                            data.coins += 20;
                            data.karma = Math.min(10, (data.karma || 0) + 2); // Buena acciÃ³n
                            updateWalkCoins(20);
                            data.aburrimiento = Math.max(0, data.aburrimiento - 1.5);
                            return { description: "Tras un rato buscando, encuentras a su dueÃ±a, que te da una pequeÃ±a recompensa. Â¡QuÃ© buena acciÃ³n!", characterDialog: "Â¡Me alegro de haber ayudado! Y ademÃ¡s, Â¡monedas!" };
                        },
                        ignore_puppy: (data) => {
                            data.karma = Math.max(-10, (data.karma || 0) - 1); // PequeÃ±a mala acciÃ³n
                            data.aburrimiento = Math.min(10, data.aburrimiento + 1);
                            return { description: "Decides seguir tu camino, dejando al cachorro atrÃ¡s.", characterDialog: "Espero que alguien lo ayude... Me siento un poco mal." };
                        }
                    }
                },
                {
                    id: "lost_wallet",
                    description: "En el suelo, ves una cartera de cuero bastante abultada.",
                    characterDialog: "Â¡Mira! Â¡Alguien ha perdido su cartera! Â¿La cogemos?",
                    choices: [
                        { text: "Cogerla y llevarla a la policÃ­a", action: "return_wallet" },
                        { text: "Coger el dinero y dejar la cartera", action: "steal_money" },
                        { text: "Dejarla donde estÃ¡", action: "ignore_wallet" }
                    ],
                    consequences: {
                        return_wallet: (data) => {
                            data.coins += 50;
                            data.karma = Math.min(10, (data.karma || 0) + 3); // Gran buena acciÃ³n
                            updateWalkCoins(50);
                            data.aburrimiento = Math.max(0, data.aburrimiento - 0.5);
                            return { description: "LlevÃ¡is la cartera a la comisarÃ­a. El dueÃ±o aparece y os da una recompensa por vuestra honestidad.", characterDialog: "Â¡Hacer lo correcto tiene premio!" };
                        },
                        steal_money: (data) => {
                            data.coins += 200;
                            data.karma = Math.max(-10, (data.karma || 0) - 4); // Gran mala acciÃ³n
                            updateWalkCoins(200);
                            data.aburrimiento = Math.min(10, data.aburrimiento + 1.5);
                            return { description: "Miras a ambos lados, coges el dinero y dejas la cartera. No habÃ­a nadie.", characterDialog: "Â¡CuÃ¡ntas monedas! Pero... no me siento del todo bien." };
                        },
                        ignore_wallet: (data) => {
                            // Ignorar no es bueno ni malo en este caso.
                            return { description: "Decides que no es asunto tuyo y sigues caminando.", characterDialog: "Mejor no buscarse problemas. Sigamos." };
                        }
                    }
                },
                {
                    id: "street_performer",
                    description: "Un mÃºsico callejero toca una melodÃ­a preciosa con su guitarra.",
                    characterDialog: "Â¡QuÃ© bien suena! Â¿Nos quedamos un rato a escuchar?",
                    choices: [
                        { text: "SÃ­, y darle una propina (10 monedas)", action: "tip_musician" },
                        { text: "Escuchar un poco y seguir", action: "listen_briefly" },
                        { text: "No tenemos tiempo para esto", action: "ignore_musician" }
                    ],
                    consequences: {
                        tip_musician: (data) => {
                            if (data.coins >= 10) {
                                data.coins -= 10;
                                data.karma = Math.min(10, (data.karma || 0) + 1); // PequeÃ±a buena acciÃ³n
                                updateWalkCoins(-10);
                                data.aburrimiento = Math.max(0, data.aburrimiento - 2.5);
                                return { description: "DisfrutÃ¡is de la mÃºsica y le dejas una propina. El mÃºsico os sonrÃ­e agradecido.", characterDialog: "Â¡Ha sido mÃ¡gico! Â¡Me siento superrelajado!" };
                            } else {
                                data.aburrimiento = Math.max(0, data.aburrimiento - 1.5);
                                return { description: "Te gustarÃ­a darle propina, pero no tienes monedas. Aun asÃ­, disfrutÃ¡is de la canciÃ³n.", characterDialog: "Â¡QuÃ© bonito! LÃ¡stima no tener dinero para darle." };
                            }
                        },
                        listen_briefly: (data) => {
                            data.aburrimiento = Math.max(0, data.aburrimiento - 1.5);
                            return { description: "Os parÃ¡is un momento a disfrutar de la melodÃ­a antes de continuar vuestro paseo.", characterDialog: "Me ha gustado mucho. Â¡Continuemos!" };
                        },
                        ignore_musician: (data) => {
                            data.karma = Math.max(-10, (data.karma || 0) - 1); // PequeÃ±a mala acciÃ³n (ser un poco borde)
                            data.aburrimiento = Math.min(10, data.aburrimiento + 0.5);
                            return { description: "Decides que no es momento para conciertos y sigues de largo.", characterDialog: "Vaya... bueno, a lo nuestro." };
                        }
                    }
                },
                {
                    id: "puddle_splash",
                    description: "Un coche pasa a toda velocidad y os salpica con un charco.",
                    characterDialog: "Â¡Agggh! Â¡Estoy todo sucio y mojado! Â¡QuÃ© asco!",
                    choices: [
                        { text: "Volver a casa a limpiarse", action: "go_home" },
                        { text: "Secarse un poco y continuar", action: "continue_dirty" }
                    ],
                    consequences: {
                        go_home: (data, endWalkFn) => {
                            data.higiene = Math.min(10, data.higiene + 2.5);
                            endWalkFn(true);
                            return { description: "DecidÃ­s que es mejor volver a casa para una buena ducha.", characterDialog: "Â¡Se acabÃ³ el paseo por hoy! Necesito un baÃ±o." };
                        },
                        continue_dirty: (data) => {
                            data.higiene = Math.min(10, data.higiene + 1.5);
                            data.aburrimiento = Math.min(10, data.aburrimiento + 0.5);
                            return { description: "Usas un paÃ±uelo para secarlo un poco, pero sigue bastante sucio.", characterDialog: "Ugh, me siento pegajoso. Ya no disfruto tanto del paseo." };
                        }
                    }
                },
                {
                    id: "find_coin",
                    description: "Â¡Brilla algo en el suelo! Es una moneda.",
                    characterDialog: "Â¡Ooh, dinero gratis!",
                    consequences: {
                        proceed: (data) => {
                            data.coins += 5;
                            updateWalkCoins(5);
                            return { description: "La recoges y la guardas en tu bolsillo. No es mucho, pero todo suma.", characterDialog: "Â¡DÃ­a de suerte!" };
                        }
                    }
                },
                {
                    id: "beautiful_sunset",
                    description: "El sol comienza a ponerse, tiÃ±endo el cielo de colores naranjas y rosas.",
                    characterDialog: "Â¡Wow, mira quÃ© atardecer! Es precioso...",
                    sceneChange: { backgroundColor: '#FFB6C1' }, /* Rosa claro */
                    consequences: {
                        proceed: (data) => {
                            data.aburrimiento = Math.max(0, data.aburrimiento - 1);
                            return { description: "Os parÃ¡is un momento en silencio, simplemente admirando la vista.", characterDialog: "Momentos asÃ­ hacen que todo valga la pena." };
                        }
                    }
                },
                {
                    id: "friendly_cat",
                    description: "Un gato amigable se acerca y se frota contra tus piernas, ronroneando.",
                    characterDialog: "Â¡Hola, gatito! Â¡QuÃ© suave eres!",
                    consequences: {
                        proceed: (data) => {
                            data.aburrimiento = Math.max(0, data.aburrimiento - 1.5);
                            return { description: "Le das unas caricias al gato antes de que siga su camino.", characterDialog: "Â¡Me encantan los animales! Me ha alegrado el dÃ­a." };
                        }
                    }
                },
                {
                    id: "smell_bakery",
                    description: "PasÃ¡is por delante de una panaderÃ­a y un delicioso olor a pan reciÃ©n hecho inunda el aire.",
                    characterDialog: "Mmmm, Â¡quÃ© bien huele! De repente me ha entrado un poco de hambre.",
                    consequences: {
                        proceed: (data) => {
                            data.hambre = Math.min(10, data.hambre + 0.5);
                            return { description: "El olor es tentador, pero decidÃ­s seguir con vuestro paseo.", characterDialog: "Me comeria una barra entera ahora mismo." };
                        }
                    }
                },
                {
                    id: "kids_playing",
                    description: "Veis a un grupo de niÃ±os jugando alegremente en un parque.",
                    characterDialog: "Â¡Mira cÃ³mo se divierten! Me recuerdan a cuando yo era pequeÃ±o.",
                    consequences: {
                        proceed: (data) => {
                            data.aburrimiento = Math.max(0, data.aburrimiento - 0.5);
                            return { description: "La risa de los niÃ±os es contagiosa y os saca una sonrisa.", characterDialog: "La vida es para jugar y ser feliz." };
                        }
                    }
                },
                {
                    id: "nice_breeze",
                    description: "Una suave y fresca brisa sopla, aliviando el calor del dÃ­a.",
                    characterDialog: "Ahhh, quÃ© maravilla de brisa. Se estÃ¡ genial.",
                    consequences: {
                        proceed: (data) => {
                            data.aburrimiento = Math.max(0, data.aburrimiento - 0.5);
                            return { description: "Cierras los ojos un instante para disfrutar del momento.", characterDialog: "Â¡Esto es vida!" };
                        }
                    }
                },
                {
                    id: "airplane_sky",
                    description: "Un aviÃ³n surca el cielo, dejando una estela blanca a su paso.",
                    characterDialog: "Â¿A dÃ³nde irÃ¡? Me pregunto quÃ© se sentirÃ¡ al volar tan alto.",
                    consequences: {
                        proceed: (data) => {
                            return { description: "SeguÃ­s al aviÃ³n con la mirada hasta que desaparece en la distancia.", characterDialog: "AlgÃºn dÃ­a me gustarÃ­a viajar por todo el mundo." };
                        }
                    }
                },
                {
                    id: "flower_garden",
                    description: "PasÃ¡is junto a un jardÃ­n lleno de flores de todos los colores. El aroma es embriagador.",
                    characterDialog: "Â¡CuÃ¡ntas flores! Â¡Y quÃ© bien huelen!",
                    consequences: {
                        proceed: (data) => {
                            data.aburrimiento = Math.max(0, data.aburrimiento - 0.5);
                            return { description: "Os detenÃ©is un momento para admirar la belleza y el perfume de las flores.", characterDialog: "La naturaleza es increÃ­ble." };
                        }
                    }
                },
                {
                    id: "sudden_trip",
                    description: "Â¡Cuidado! Tropiezas con una baldosa suelta, pero consigues mantener el equilibrio.",
                    characterDialog: "Â¡Uf, por los pelos! Casi me caigo de bruces.",
                    consequences: {
                        proceed: (data) => {
                            data.higiene = Math.min(10, data.higiene + 0.5);
                            return { description: "Te sacudes el polvo de las manos y sigues con mÃ¡s cuidado.", characterDialog: "Hay que mirar por dÃ³nde se pisa." };
                        }
                    }
                },
                // --- EVENTOS NUEVOS ---
                {
                    id: "bully_event",
                    description: "Ves a un Tamagotchi grande molestando a uno mÃ¡s pequeÃ±o.",
                    characterDialog: "Â¡DÃ©jale en paz! O... Â¿quizÃ¡s deberÃ­a unirme a Ã©l?",
                    choices: [
                        { text: "Intervenir y defender", action: "intervene" },
                        { text: "Unirte al matÃ³n", action: "join_bully" },
                        { text: "Ignorar la situaciÃ³n", action: "ignore_bully" }
                    ],
                    consequences: {
                        intervene: (data) => {
                            data.karma = Math.min(10, (data.karma || 0) + 3);
                            if (Math.random() < 0.25) { // 25% de probabilidad de perder dinero
                                const lostCoins = Math.min(data.coins, 50);
                                data.coins -= lostCoins;
                                updateWalkCoins(-lostCoins);
                                return { description: "Intervienes y el matÃ³n se enfada. Tras un forcejeo, se va, pero te ha quitado algo de dinero.", characterDialog: "Â¡Al menos el pequeÃ±o estÃ¡ bien! Aunque mi cartera no tanto..." };
                            }
                            return { description: "Te enfrentas al matÃ³n y, sorprendentemente, se disculpa y se va. El pequeÃ±o te lo agradece.", characterDialog: "Â¡Nadie se mete con los dÃ©biles cuando yo estoy cerca!" };
                        },
                        join_bully: (data) => {
                            data.karma = Math.max(-10, (data.karma || 0) - 5);
                            data.coins += 30;
                            updateWalkCoins(30);
                            return { description: "Te unes al matÃ³n para reÃ­rte del pequeÃ±o. El matÃ³n te da unas monedas por tu 'lealtad'.", characterDialog: "Jeje... bueno, unas monedas son unas monedas." };
                        },
                        ignore_bully: (data) => {
                            data.karma = Math.max(-10, (data.karma || 0) - 2);
                            return { description: "Miras para otro lado y aceleras el paso. No es tu problema.", characterDialog: "Mejor no meterse en lÃ­os. Espero que no le pase nada grave." };
                        }
                    }
                },
                {
                    id: "charity_donation",
                    description: "Un puesto de caridad pide donaciones para el refugio de Tamagotchis.",
                    characterDialog: "Parece una buena causa. Â¿DeberÃ­amos ayudar?",
                    choices: [
                        { text: "Donar generosamente (100)", action: "donate_generous" },
                        { text: "Donar un poco (20)", action: "donate_small" },
                        { text: "Decir que no tienes dinero", action: "no_donate" }
                    ],
                    consequences: {
                        donate_generous: (data) => {
                            if (data.coins >= 100) {
                                data.coins -= 100;
                                updateWalkCoins(-100);
                                data.karma = Math.min(10, (data.karma || 0) + 4);
                                return { description: "Donas 100 monedas. El voluntario te lo agradece enormemente.", characterDialog: "Â¡Me siento genial por haber ayudado tanto!" };
                            }
                            return { description: "Quieres donar, pero no tienes 100 monedas.", characterDialog: "Â¡Oh! QuerÃ­a ser mÃ¡s generoso..." };
                        },
                        donate_small: (data) => {
                            if (data.coins >= 20) {
                                data.coins -= 20;
                                updateWalkCoins(-20);
                                data.karma = Math.min(10, (data.karma || 0) + 2);
                                return { description: "Donas 20 monedas. Todo ayuda.", characterDialog: "Â¡Espero que sirva de algo!" };
                            }
                            return { description: "Ni siquiera tienes 20 monedas para donar.", characterDialog: "QuÃ© vergÃ¼enza... no tengo nada." };
                        },
                        no_donate: (data) => {
                            return { description: "Pasas de largo del puesto de caridad.", characterDialog: "Hoy no me siento generoso." };
                        }
                    }
                },
                {
                    id: "dark_alley",
                    description: "Ves un callejÃ³n oscuro que parece un atajo.",
                    characterDialog: "PodrÃ­amos ahorrar tiempo por ahÃ­... pero da un poco de miedo.",
                    choices: [
                        { text: "Tomar el atajo", action: "take_shortcut" },
                        { text: "Seguir por el camino principal", action: "main_road" }
                    ],
                    consequences: {
                        take_shortcut: (data) => {
                            if (Math.random() < 0.5) {
                                data.coins += 50;
                                updateWalkCoins(50);
                                return { description: "Â¡QuÃ© suerte! Encuentras 50 monedas en el suelo del callejÃ³n.", characterDialog: "Â¡Quien no arriesga, no gana!" };
                            }
                            data.aburrimiento = Math.min(10, data.aburrimiento + 1);
                            return { description: "Un ruido fuerte te asusta y sales corriendo del callejÃ³n. No has ahorrado tiempo.", characterDialog: "Â¡Ay, quÃ© susto! Â¡Nunca mÃ¡s!" };
                        },
                        main_road: (data) => {
                            return { description: "Decides que es mejor ir por lo seguro y sigues el camino iluminado.", characterDialog: "MÃ¡s vale prevenir que curar." };
                        }
                    }
                },
                {
                    id: "verbal_fight",
                    description: "Alguien te empuja sin querer y te grita como si fuera tu culpa.",
                    characterDialog: "Â¡Pero bueno! Â¡QuÃ© modales! Â¿Le digo algo?",
                    choices: [
                        { text: "Disculparse para evitar problemas", action: "apologize" },
                        { text: "Responderle enfadado", action: "argue" },
                        { text: "Ignorarlo y seguir", action: "ignore_fight" }
                    ],
                    consequences: {
                        apologize: (data) => {
                            data.karma = Math.min(10, (data.karma || 0) + 1);
                            return { description: "Aunque no ha sido tu culpa, te disculpas. El otro Tamagotchi se calma y sigue su camino.", characterDialog: "No vale la pena discutir por estas cosas." };
                        },
                        argue: (data) => {
                            data.karma = Math.max(-10, (data.karma || 0) - 1);
                            data.aburrimiento = Math.min(10, data.aburrimiento + 1);
                            return { description: "Le respondes enfadado y empezÃ¡is una discusiÃ³n a gritos que no lleva a ninguna parte.", characterDialog: "Â¡QuÃ© rabia! Â¡Me ha fastidiado el paseo!" };
                        },
                        ignore_fight: (data) => {
                            return { description: "Respiras hondo, lo ignoras y sigues tu camino.", characterDialog: "No voy a dejar que un maleducado me arruine el dÃ­a." };
                        }
                    }
                },
                {
                    id: "surprise_parade",
                    description: "De repente, un desfile lleno de mÃºsica y color aparece en la calle.",
                    characterDialog: "Â¡QuÃ© divertido! Â¡Me encanta la mÃºsica!",
                    consequences: {
                        proceed: (data) => {
                            data.aburrimiento = Math.max(0, data.aburrimiento - 2);
                            return { description: "Os quedÃ¡is un rato viendo el desfile. Â¡QuÃ© sorpresa tan agradable!", characterDialog: "Â¡Esto sÃ­ que es un buen paseo!" };
                        }
                    }
                },
                {
                    id: "bakery_smell",
                    description: "El delicioso olor de una pastelerÃ­a cercana inunda el aire.",
                    characterDialog: "Mmmm... Â¡quÃ© bien huele! Me ha entrado hambre.",
                    consequences: {
                        proceed: (data) => {
                            data.hambre = Math.min(10, data.hambre + 1);
                            return { description: "El olor es tan intenso que te ruge el estÃ³mago.", characterDialog: "Â¡Necesito comer algo, ya!" };
                        }
                    }
                },
                {
                    id: "bird_flock",
                    description: "Una gran bandada de pÃ¡jaros levanta el vuelo a tu paso, creando un espectÃ¡culo en el cielo.",
                    characterDialog: "Â¡Wow! Â¡CuÃ¡ntos pÃ¡jaros!",
                    consequences: {
                        proceed: (data) => {
                            data.aburrimiento = Math.max(0, data.aburrimiento - 0.5);
                            return { description: "El movimiento coordinado de los pÃ¡jaros es hipnÃ³tico.", characterDialog: "Â¡Ha sido impresionante!" };
                        }
                    }
                },
                {
                    id: "muddy_puddle",
                    description: "No ves un charco de barro y metes la pata hasta el fondo.",
                    characterDialog: "Â¡Puaj! Â¡QuÃ© asco, estoy todo sucio!",
                    consequences: {
                        proceed: (data) => {
                            data.higiene = Math.min(10, data.higiene + 2);
                            return { description: "Te has llenado de barro. Definitivamente necesitas una ducha.", characterDialog: "Â¡Genial, ahora huelo a tierra mojada!" };
                        }
                    }
                },
                {
                    id: "street_market",
                    description: "Os topÃ¡is con un mercadillo lleno de puestos con antigÃ¼edades y curiosidades.",
                    characterDialog: "Â¡CuÃ¡ntas cosas! Hay de todo... Â¿compramos algo de recuerdo?",
                    choices: [
                        { text: "Comprar objeto misterioso (75)", action: "buy_common" },
                        { text: "Comprar objeto raro (300)", action: "buy_uncommon" },
                        { text: "Solo mirar y seguir", action: "just_look" }
                    ],
                    consequences: {
                        buy_common: (data) => {
                            if (data.coins >= 75) {
                                data.coins -= 75;
                                updateWalkCoins(-75);
                                const item = buyMercadilloObject(75);
                                return { description: `Compras un ${item.name} por 75 monedas.`, characterDialog: "Â¡QuÃ© chulo! Lo guardarÃ© en mi inventario." };
                            }
                            return { description: "Te encanta el objeto, pero no tienes 75 monedas.", characterDialog: "LÃ¡stima, era muy bonito..." };
                        },
                        buy_uncommon: (data) => {
                            if (data.coins >= 300) {
                                data.coins -= 300;
                                updateWalkCoins(-300);
                                const item = buyMercadilloObject(300);
                                return { description: `Pagas 300 monedas por un ${item.name}.`, characterDialog: "Â¡Espero que sea autÃ©ntico!" };
                            }
                            return { description: "El objeto es demasiado caro. No puedes permitÃ­rtelo.", characterDialog: "300 monedas... Â¡se han pasado un poco!" };
                        },
                        just_look: (data) => {
                            data.aburrimiento = Math.max(0, data.aburrimiento - 0.5);
                            return { description: "Dais una vuelta por el mercadillo sin comprar nada y continuÃ¡is el paseo.", characterDialog: "HabÃ­a cosas interesantes, pero mejor ahorrar." };
                        }
                    }
                }
            ];

            function buyMercadilloObject(cost) {
              if (!tamagotchiData) return;

              let itemPool;
              if (cost === 75) {
                itemPool = mercadilloObjects.common;
              } else if (cost === 300) {
                // --- Â¡NUEVO! ComprobaciÃ³n del truco secreto ---
                const cheatActive = sessionStorage.getItem('secretMercadilloCheat') === 'true';

                if (cheatActive) {
                  itemPool = mercadilloObjects.rare; // 100% de probabilidad si el truco estÃ¡ activo
                  sessionStorage.removeItem('secretMercadilloCheat'); // El truco se usa una vez
                } else if (Math.random() < 0.01) {
                  // 1% de probabilidad normal de obtener un objeto raro
                  itemPool = mercadilloObjects.rare;
                } else {
                  itemPool = mercadilloObjects.uncommon;
                }
              } else {
                return;
              }

              const randomItem = itemPool[Math.floor(Math.random() * itemPool.length)];

              walkMercadilloInventory.push(randomItem); // AÃ±ade al inventario temporal del paseo
              return randomItem;
            }

            // --- LÃ“GICA DE INICIALIZACIÃ“N ---
            function init() {
                try {
                    const data = localStorage.getItem('tamagotchiData');
                    if (!data) {
                        showError("No se encontraron datos del Tamagotchi.");
                        return;
                    }
                    tamagotchiData = JSON.parse(data);
                    if (!tamagotchiData.mercadilloInventory) {
                        tamagotchiData.mercadilloInventory = [];
                    }
                } catch (e) {
                    showError("Error al cargar los datos del Tamagotchi.");
                    return;
                }

                characterDisplay.innerHTML = `<pre>(\_/)
( ^_^ )
(>   <)</pre>`;
                walkCoinDisplay.classList.add('hidden');

                startWalkBtn.addEventListener("click", startWalk);
                exitBtn.addEventListener("click", () => endWalk(false));

                localStorage.removeItem('walkInProgress');
            }

            function updateWalkCoins(amount) {
                walkCoins += amount;
                const totalSign = walkCoins >= 0 ? '+' : '';
                walkCoinDisplay.textContent = `Paseo: ${totalSign}${walkCoins} ðŸª™`;
            }

            function startWalk() {
                if (!tamagotchiData) return;
                
                localStorage.setItem('walkInProgress', 'true');
                walkInProgress = true;

                walkCoins = 0;
                walkMercadilloInventory = []; // Resetea el inventario temporal
                updateWalkCoins(0);
                walkCoinDisplay.classList.remove('hidden');

                // --- Â¡NUEVO! AÃ±adir clases para animaciones ---
                sceneContainer.classList.add("walking");
                characterDisplay.classList.add("walking");

                startWalkBtn.classList.add("hidden");
                exitBtn.classList.remove("hidden");
                eventDescription.textContent = "El paseo ha comenzado. A ver quÃ© aventuras te esperan...";
                characterDialog.textContent = "";
                choicesContainer.innerHTML = '';

                scheduleNextEvent();
            }

            function scheduleNextEvent() {
                clearTimeout(eventTimeout);
                if (!walkInProgress) return;

                // --- Â¡NUEVO! Solo cambia el color si no estÃ¡ caminando (para no cortar la animaciÃ³n de nubes) ---
                if (!sceneContainer.classList.contains('walking')) {
                }
                sceneContainer.style.backgroundColor = '#87CEEB';
                const delay = Math.random() * 5000 + 8000;
                eventTimeout = setTimeout(triggerRandomEvent, delay);
            }

            function triggerRandomEvent() {
                if (!walkInProgress) return;

                // --- MODIFICADO: Filtrar eventos segÃºn las condiciones ---
                const availableEvents = walkEvents.filter(event => {
                    // Si el evento no tiene condiciÃ³n, siempre estÃ¡ disponible.
                    // Si tiene condiciÃ³n, se evalÃºa.
                    return !event.condition || event.condition(tamagotchiData);
                });

                const event = availableEvents[Math.floor(Math.random() * availableEvents.length)];
                currentEvent = event;

                eventDescription.textContent = event.description;
                characterDialog.textContent = event.characterDialog;
                if (event.sceneChange) {
                    sceneContainer.style.backgroundColor = event.sceneChange.backgroundColor;
                }

                choicesContainer.innerHTML = '';

                if (event.choices) {
                    event.choices.forEach(choice => {
                        const btn = document.createElement('button');
                        btn.textContent = choice.text;
                        btn.className = 'choice-btn';
                        if (choice.action.includes('ignore') || choice.action.includes('refuse')) {
                            btn.classList.add('secondary');
                        }
                        btn.onclick = () => handleChoice(choice.action);
                        choicesContainer.appendChild(btn);
                    });
                } else {
                    // --- MODIFICADO: LÃ³gica para eventos no interactivos ---
                    // 1. Guardamos una copia del estado ANTES de la consecuencia
                    const oldData = JSON.parse(JSON.stringify(tamagotchiData));

                    // 2. Ejecutamos la consecuencia del evento
                    const result = event.consequences.proceed(tamagotchiData);

                    // 3. Comparamos estados y mostramos los cambios en pantalla
                    compareAndShowChanges(oldData, tamagotchiData);

                    // 4. Comprobamos si alguna estadÃ­stica ha llegado a un nivel crÃ­tico
                    checkCriticalStats();

                    // 5. Actualizamos el diÃ¡logo
                    eventDescription.textContent = result.description;
                    characterDialog.textContent = result.characterDialog;

                    // 6. Programamos el siguiente evento
                    setTimeout(scheduleNextEvent, 3500);
                }
            }

            function handleChoice(action) {
                if (!currentEvent || !walkInProgress) return;

                choicesContainer.querySelectorAll('button').forEach(btn => btn.disabled = true);

                const consequence = currentEvent.consequences[action];

                // --- Â¡NUEVO! LÃ³gica para mostrar cambios de stats ---
                // 1. Guardamos una copia del estado ANTES de la consecuencia
                const oldData = JSON.parse(JSON.stringify(tamagotchiData));

                if (consequence) {
                    const result = consequence(tamagotchiData, endWalk);
                    
                    // 2. Comparamos el estado nuevo con el viejo y mostramos los cambios
                    compareAndShowChanges(oldData, tamagotchiData);

                    // --- Â¡NUEVO! 3. Comprobamos si alguna estadÃ­stica estÃ¡ en nivel crÃ­tico ---
                    checkCriticalStats();

                    if (walkInProgress) {
                        eventDescription.textContent = result.description;
                        characterDialog.textContent = result.characterDialog;
                        
                        setTimeout(() => {
                            choicesContainer.innerHTML = '';
                            scheduleNextEvent();
                        }, 3500);
                    }
                }
            }

            // --- Â¡NUEVO! Variable para controlar la posiciÃ³n de los indicadores ---
            let statChangeYOffset = 0;

            // --- Â¡NUEVA FUNCIÃ“N! Para mostrar el texto flotante ---
            function showStatChange(text, type) {
                const statElement = document.createElement('div');
                statElement.textContent = text;
                statElement.className = `stat-change ${type}`;

                // --- MODIFICADO: Posicionamiento para evitar solapamiento ---
                // Alterna la posiciÃ³n horizontal y aumenta la vertical para cada nuevo indicador
                const horizontalPosition = (statChangeYOffset % 2 === 0) ? '25%' : '55%';
                statElement.style.left = horizontalPosition;
                statElement.style.top = `${50 + statChangeYOffset * 10}%`;
                statChangeYOffset++;

                statChangesContainer.appendChild(statElement);

                // Eliminar el elemento despuÃ©s de la animaciÃ³n
                setTimeout(() => {
                    statElement.remove();
                }, 2500);

                // Resetea el offset vertical despuÃ©s de un tiempo para que no se vayan muy abajo
                setTimeout(() => {
                    statChangeYOffset = 0;
                }, 1000);
            }

            // --- Â¡NUEVA FUNCIÃ“N! Para comparar estados y llamar a showStatChange ---
            function compareAndShowChanges(oldData, newData) {
                const changes = {
                    hambre: newData.hambre - oldData.hambre,
                    aburrimiento: newData.aburrimiento - oldData.aburrimiento,
                    higiene: newData.higiene - oldData.higiene,
                    sueno: newData.sueno - oldData.sueno,
                    karma: (newData.karma || 0) - (oldData.karma || 0),
                    coins: newData.coins - oldData.coins
                };

                // Mapeo de nombres para mostrar
                const statNames = {
                    hambre: "Hambre",
                    aburrimiento: "Aburrimiento",
                    higiene: "Higiene",
                    sueno: "SueÃ±o",
                    karma: "Karma",
                    coins: "Monedas"
                };

                for (const stat in changes) {
                    const diff = changes[stat];
                    if (Math.abs(diff) > 0.01) { // Usamos un umbral pequeÃ±o para evitar errores de flotantes
                        const sign = diff > 0 ? '+' : '';
                        const type = (stat === 'hambre' || stat === 'aburrimiento' || stat === 'higiene' || stat === 'sueno') 
                                     ? (diff > 0 ? 'negative' : 'positive')
                                     : (stat === 'coins')
                                     ? 'neutral'
                                     : (diff > 0 ? 'positive' : 'negative');
                        // Para monedas, no mostramos decimales
                        const valueString = (stat === 'coins') ? diff.toFixed(0) : diff.toFixed(1);
                        showStatChange(`${sign}${valueString} ${statNames[stat]}`, type);
                    }
                }
            }

            // --- Â¡NUEVA FUNCIÃ“N! Para avisar de estados crÃ­ticos ---
            function checkCriticalStats() {
                const warningContainer = document.getElementById('critical-warning-container');
                if (!warningContainer || !tamagotchiData) return;

                const warnings = [];
                const threshold = 8.5;

                if (tamagotchiData.hambre >= threshold) warnings.push(`${tamagotchiData.nombre} tiene muchÃ­sima hambre.`);
                if (tamagotchiData.aburrimiento >= threshold) warnings.push(`${tamagotchiData.nombre} estÃ¡ extremadamente aburrido.`);
                if (tamagotchiData.higiene >= threshold) warnings.push(`${tamagotchiData.nombre} necesita una ducha urgentemente.`);
                if (tamagotchiData.sueno >= threshold) warnings.push(`${tamagotchiData.nombre} estÃ¡ a punto de desmayarse de sueÃ±o.`);

                if (warnings.length > 0) {
                    // Mostramos el primer aviso crÃ­tico.
                    warningContainer.textContent = `${warnings[0]} Â¡DeberÃ­as volver a casa!`;
                    warningContainer.style.display = 'block';
                    // Desactivamos la apariciÃ³n de nuevos eventos para no empeorar la situaciÃ³n
                    clearTimeout(eventTimeout);
                    choicesContainer.innerHTML = '<p style="text-align: center; font-weight: bold;">No puedes continuar el paseo en este estado.</p>';
                } else {
                    // Si no hay avisos, nos aseguramos de que el contenedor estÃ© oculto.
                    warningContainer.style.display = 'none';
                }
            }


            function endWalk(forced = false) {
                localStorage.removeItem('walkInProgress');
                walkInProgress = false;
                clearTimeout(eventTimeout);

                // --- Â¡NUEVO! Eliminar clases de animaciÃ³n ---
                sceneContainer.classList.remove("walking");
                characterDisplay.classList.remove("walking");

                choicesContainer.innerHTML = '';
                walkCoinDisplay.classList.add('hidden');

                if (forced) {
                    localStorage.setItem('tamagotchiData', JSON.stringify(tamagotchiData));
                    localStorage.setItem('walkGameResult', 'finished');
                    window.location.href = "index.html";
                    return;
                }

                // --- Â¡NUEVA LÃ“GICA DE KARMA AL FINALIZAR! ---
                if (tamagotchiData && tamagotchiData.karma < 0) {
                    // Evento de ladrÃ³n por karma negativo
                    exitBtn.classList.add('hidden');
                    eventDescription.textContent = "De camino a casa, por una calle poco iluminada, un extraÃ±o te detiene...";
                    characterDialog.textContent = '"Â¡Esto es un atraco! Â¡Dame todo lo que tienes!"';
                    
                    // El ladrÃ³n te roba las monedas que has conseguido durante el paseo.
                    // Simplemente revertimos las ganancias/pÃ©rdidas del paseo.
                    tamagotchiData.coins -= walkCoins;
                    // Los objetos del mercadillo (walkMercadilloInventory) no se aÃ±aden, asÃ­ que se pierden.

                    setTimeout(() => {
                        localStorage.setItem('tamagotchiData', JSON.stringify(tamagotchiData));
                        localStorage.setItem('walkGameResult', 'finished');
                        window.location.href = "index.html";
                    }, 4000);

                } else {
                    // Final normal, con karma bueno o neutral
                    exitBtn.classList.add('hidden');
                    eventDescription.textContent = "Decides que es hora de volver. El camino de vuelta a casa es tranquilo.";
                    characterDialog.textContent = "Â¡QuÃ© buen paseo! Ya tengo ganas de descansar en casa.";
                    // AÃ±adir los objetos del mercadillo al inventario principal
                    tamagotchiData.mercadilloInventory.push(...walkMercadilloInventory);
                    localStorage.setItem('tamagotchiData', JSON.stringify(tamagotchiData));
                    localStorage.setItem('walkGameResult', 'finished');
                    setTimeout(() => { window.location.href = "index.html"; }, 4000);
                }
            }

            function showError(message) {
                eventDescription.textContent = message;
                characterDialog.textContent = "Por favor, vuelve al menÃº principal.";
                startWalkBtn.classList.add("hidden");
                exitBtn.classList.remove("hidden");
            }

            init();
        });
    </script>
</body>
</html>