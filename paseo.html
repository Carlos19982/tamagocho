<!DOCTYPE html>
<html lang="es">
<head>
    <link rel="stylesheet" type="text/css" href="style.css?v=1.8" />
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Paseo con Tamagotchi</title>
    <style>
        body {
            margin: 0;
            display: grid;
            grid-template-rows: auto auto 1fr; /* T√≠tulo, Panel de Texto, Escena */
            justify-content: center;
            align-items: center;
            height: 100vh;
            overflow: hidden;
            font-family: 'Courier New', Courier, monospace;
            user-select: none;
            -webkit-user-select: none;
            padding: 20px;
            box-sizing: border-box;
        }

        /* --- MODIFICADO: El contenedor principal se elimina, los estilos se aplican a los elementos directamente --- */
        #walk-container {
            display: contents; /* Este elemento ya no act√∫a como contenedor visual */
        }

        /* --- MODIFICADO: El panel ahora est√° en la parte superior --- */
        #top-panel {
            grid-row: 2; /* El panel de texto va en la segunda fila */
            width: 95%;
            max-width: 600px;
            margin: 0 auto; /* Centrar el panel inferior */
            background: rgba(0, 0, 0, 0.3); /* FONDO SEMITRANSPARENTE */
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            padding: 15px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.5);
            text-align: center;
            display: flex;
            flex-direction: column;
            margin-bottom: 20px; /* Espacio entre el panel y la escena */
        }

        h1 {
            grid-row: 1; /* El t√≠tulo va en la primera fila del grid del body */
            color: #fff; /* TEXTO BLANCO */
            text-shadow: 2px 2px 4px rgba(0,0,0,0.7); /* SOMBRA PARA LEGIBILIDAD */
            border-bottom: 1px solid rgba(255, 255, 255, 0.3);
            padding-bottom: 10px;
            margin-top: 0;
            margin-bottom: 20px;
            text-align: center;
        }

        #scene-container {
            grid-row: 3; /* La escena ahora ocupa la tercera fila (inferior) */
            position: relative;
            width: 100%;
            background-color: transparent; /* SIN FONDO DE COLOR */
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: flex-end; /* ALINEA EL PERSONAJE ABAJO */
        }
        
        /* --- MODIFICADO: Se elimina la animaci√≥n de nubes redundante --- */
      

        @keyframes scroll-background {
            from { background-position: 0 0; }
            to { background-position: -800px 0; } /* Coincide con el ancho del SVG */
        }

        /* Animaci√≥n de caminata para el personaje */
        #character-display.walking {
            animation: walk-bob 0.8s ease-in-out infinite;
        }

        #character-display {
            font-size: 2.5rem;
            white-space: pre;
            line-height: 1.2;
            z-index: 10;
            padding-bottom: 20px; /* Un poco de espacio desde el borde inferior */
            transition: transform 0.5s ease;
            color: rgba(255, 255, 255, 0.85); /* Personaje siempre blanco */
            text-shadow: 1px 1px 4px rgba(0, 0, 0, 0.7); /* Sombra para mejorar legibilidad */
        }

        #dialog-box {
            width: 100%; /* Ocupa todo el ancho del panel inferior */
            border: 1px solid rgba(255, 255, 255, 0.2);
            background-color: rgba(0, 0, 0, 0.4); /* FONDO SEMITRANSPARENTE */
            border-radius: 8px;
            padding: 15px;
            min-height: 120px;
            font-size: 1.1rem;
            margin-bottom: 20px;
        }

        #event-description {
            font-style: italic;
            color: #ccc; /* TEXTO M√ÅS CLARO */
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
        }

        #character-dialog {
            font-weight: bold;
            color: #fff; /* TEXTO BLANCO */
            text-shadow: 1px 1px 3px rgba(0,0,0,0.8);
        }

        #choices-container {
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 10px;
            min-height: 50px; /* Espacio reservado para botones */
        }

        .choice-btn {
            padding: 12px 20px;
            font-family: 'Courier New', Courier, monospace;
            font-weight: bold;
            font-size: 1rem;
            color: white;
            background-color: #007bff;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .choice-btn:hover {
            background-color: #0056b3;
        }

        .choice-btn.secondary {
            background-color: #6c757d;
        }

        .choice-btn.secondary:hover {
            background-color: #5a6268;
        }

        .hidden {
            display: none;
        }

        /* --- ¬°NUEVO! Estilos para los indicadores de stats --- */
        #stat-changes-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none; /* Para que no interfiera con los clics */
            overflow: hidden;
            z-index: 20;
        }

        .stat-change {
            position: absolute;
            font-size: 1.3rem;
            font-weight: bold;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.6);
            animation: float-up 2.5s ease-out forwards;
        }

        .stat-change.positive { color: #4CAF50; } /* Verde para mejoras */
        .stat-change.negative { color: #F44336; } /* Rojo para empeoramientos */
        .stat-change.neutral { color: #2196F3; }  /* Azul para cambios neutrales como monedas */

        @keyframes float-up {
            0% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-60px); }
        }
        /* --- Fin de nuevos estilos --- */

        /* --- ¬°NUEVO! Animaci√≥n de balanceo al caminar --- */
        @keyframes walk-bob {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-8px); }
        }

        /* --- ¬°NUEVO! Estilos para la alerta de estado cr√≠tico --- */
        #critical-warning-container {
            background-color: #F44336; /* Rojo */
            color: white;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            font-weight: bold;
            text-align: center;
            animation: pulse-bg 1.5s infinite;
            display: none; /* Oculto por defecto */
        }

        @keyframes pulse-bg {
            0% { background-color: #F44336; }
            50% { background-color: #c62828; }
            100% { background-color: #F44336; }
        }
        /* --- Fin de nuevos estilos --- */



        @media (max-width: 600px) {
            #character-display {
                font-size: 2rem;
            }
            h1 {
                font-size: 1.5rem;
            }
            #dialog-box {
                font-size: 1rem;
            }
        }
    </style>
    <!-- ¬°NUEVO! Estructura para la escena de abandono -->
    <style>
        #abandonment-scene {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #111;
            color: white;
            display: none; /* Oculto por defecto */
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            z-index: 1000;
            padding: 20px;
            font-family: 'Courier New', Courier, monospace;
        }

        #abandonment-character {
            font-size: 3rem;
            white-space: pre;
            margin-bottom: 20px;
        }

        #abandonment-dialog {
            font-size: 1.5rem;
            min-height: 100px;
            max-width: 80%;
        }

        #abandonment-dialog::after {
            content: '‚ñã';
            animation: blink 1s step-end infinite;
        }

        @keyframes blink {
            50% { opacity: 0; }
        }
    </style>
</head>
<body>

    <!-- ¬°NUEVO! Lienzo para el fondo din√°mico -->
    <canvas id="background-canvas"></canvas>

    <!-- ¬°NUEVO! Contenedor para la escena de abandono -->
    <div id="abandonment-scene">
        <div id="abandonment-character">
            <!-- El personaje de la escena se cargar√° aqu√≠ -->
        </div>
        <div id="abandonment-dialog">
            <!-- El di√°logo de la escena se cargar√° aqu√≠ -->
        </div>
    </div>

    <!-- T√≠tulo principal -->
    <h1>De Paseo</h1>

    <!-- Escena principal (personaje) -->
    <div id="scene-container">
        <div id="stat-changes-container"></div>
        <div id="walk-coin-display" class="hidden" style="position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.5); color: white; padding: 5px 10px; border-radius: 5px; font-size: 0.9rem;">Paseo: 0 ü™ô</div>
        <div id="character-display">
            <!-- El personaje se cargar√° aqu√≠ -->
        </div>
    </div>

    <!-- Panel inferior con di√°logos y botones -->
    <div id="top-panel">
        <div id="critical-warning-container"></div>
        <div id="dialog-box">
            <p id="event-description">El d√≠a es perfecto para un paseo.</p>
            <p id="character-dialog">"¬°Qu√© bien se est√° aqu√≠ fuera!"</p>
        </div>
        <div id="choices-container">
            <!-- Los botones de eventos aparecer√°n aqu√≠ -->
        </div>
        <div id="action-buttons" style="margin-top: 10px; display: flex; flex-direction: column; gap: 10px;">
            <button id="start-walk-btn" class="choice-btn">Empezar Paseo</button>
            <button id="exit-btn" class="choice-btn secondary hidden">Terminar Paseo y Volver</button>
        </div>
    </div>    

    <script defer src="background.js?v=1.8"></script>
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            initBackgroundCanvas('character-display'); // Inicia el fondo con el ID del personaje del paseo

            // --- L√ìGICA DE ABANDONO ---
            // Si el usuario recarga la p√°gina mientras el paseo est√° activo, se considera abandono.
            if (localStorage.getItem('walkInProgress') === 'true') {
                showAbandonmentScene();
                return; // Detenemos la ejecuci√≥n normal del paseo.
            }

            function typeWriter(element, text, onComplete) {
                let i = 0;
                element.innerHTML = ''; // Limpiar el contenido anterior
                function type() {
                    if (i < text.length) {
                        element.innerHTML += text.charAt(i);
                        i++;
                        setTimeout(type, 80); // Velocidad de escritura
                    } else {
                        if (onComplete) onComplete();
                    }
                }
                type();
            }

            function showAbandonmentScene() {
                // --- CORRECCI√ìN: Ocultar los elementos de la interfaz principal en lugar del contenedor que ya no existe ---
                document.querySelector('h1').style.display = 'none';
                document.getElementById('scene-container').style.display = 'none';
                document.getElementById('top-panel').style.display = 'none';

                const scene = document.getElementById('abandonment-scene');
                const charDisplay = document.getElementById('abandonment-character');
                const dialogDisplay = document.getElementById('abandonment-dialog');
                scene.style.display = 'flex';

                charDisplay.innerHTML = `<pre>(\\_/)\n( T_T )\n(>   <)</pre>`; // Cara triste
                const tamagotchiDialog = "¬øMe has abandonado?... Amo tonto...";

                typeWriter(dialogDisplay, tamagotchiDialog, () => {
                    // Pausa de 2.5 segundos despu√©s del di√°logo
                    setTimeout(() => {
                        // 60% de probabilidad de ser atracado
                        if (Math.random() < 0.60) {
                            showMuggingScene();
                        } else {
                            // 40% de volver a salvo
                            localStorage.setItem('walkGameResult', 'abandoned_safe');
                            localStorage.removeItem('walkInProgress');
                            window.location.href = 'index.html';
                        }
                    }, 2500);
                });
            }

            function showMuggingScene() {
                const charDisplay = document.getElementById('abandonment-character');
                const dialogDisplay = document.getElementById('abandonment-dialog');
                
                charDisplay.innerHTML = `<pre> >:( </pre>`; // Cara de atracador
                const muggerDialog = "¬°Quieto ah√≠! Dame todo lo que has conseguido en el paseo...";

                typeWriter(dialogDisplay, muggerDialog, () => {
                    // Pausa de 3 segundos para leer el mensaje del atracador
                    setTimeout(() => {
                        localStorage.setItem('walkGameResult', 'abandoned_mugged');
                        // No se guardan monedas ni objetos, se pierden.
                        localStorage.removeItem('walkInProgress');
                        window.location.href = 'index.html';
                    }, 3000);
                });
            }

            // --- ELEMENTOS DEL DOM ---
            const characterDisplay = document.getElementById("character-display");
            const eventDescription = document.getElementById("event-description");
            const characterDialog = document.getElementById("character-dialog");
            const choicesContainer = document.getElementById("choices-container");
            const startWalkBtn = document.getElementById("start-walk-btn");
            const statChangesContainer = document.getElementById("stat-changes-container");
            const exitBtn = document.getElementById("exit-btn");
            const sceneContainer = document.getElementById("scene-container");
            const walkCoinDisplay = document.getElementById("walk-coin-display");

            // --- DATOS DEL JUEGO ---
            let tamagotchiData = null;
            let walkInProgress = false;
            let eventTimeout = null; // Para controlar el temporizador de eventos
            let currentEvent = null; // Para guardar el evento activo
            let walkCoins = 0;
            let walkMercadilloInventory = []; // <-- ¬°NUEVO! Inventario temporal para el paseo

            const mercadilloObjects = {
              common: [
                { id: 'reloj_casio', name: 'Reloj Casio', value: [50, 100] },
                { id: 'taza_cafe', name: 'Taza de caf√©', value: [50, 100] },
                { id: 'libro_viejo', name: 'Libro viejo', value: [50, 100] },
                { id: 'poster_pelicula', name: 'P√≥ster de pel√≠cula', value: [50, 100] },
                { id: 'planta_plastico', name: 'Planta de pl√°stico', value: [50, 100] },
                { id: 'figura_accion', name: 'Figura de acci√≥n', value: [50, 100] },
                { id: 'gorra', name: 'Gorra', value: [50, 100] },
                { id: 'gafas_sol', name: 'Gafas de sol', value: [50, 100] },
                { id: 'llavero', name: 'Llavero', value: [50, 100] },
                { id: 'comic', name: 'C√≥mic', value: [50, 100] }
              ],
              uncommon: [
                { id: 'vinilo_antiguo', name: 'Vinilo antiguo', value: [200, 400] },
                { id: 'camara_fotos', name: 'C√°mara de fotos', value: [200, 400] },
                { id: 'walkman', name: 'Walkman', value: [200, 400] },
                { id: 'consola_retro', name: 'Consola retro', value: [200, 400] },
                { id: 'maquina_escribir', name: 'M√°quina de escribir', value: [200, 400] },
                { id: 'telefono_antiguo', name: 'Tel√©fono antiguo', value: [200, 400] },
                { id: 'mapa_antiguo', name: 'Mapa antiguo', value: [200, 400] },
                { id: 'joya_plata', name: 'Joya de plata', value: [200, 400] }
              ],
              rare: [
                { id: 'pepita_oro', name: 'Pepita de oro', value: [4000, 6000] },
                { id: 'diamante', name: 'Diamante', value: [4000, 6000] }
              ]
            };

            // --- DEFINICI√ìN DE EVENTOS ---
            const walkEvents = [
                {
                    id: "rain_event",
                    description: "De repente, el cielo se nubla y empieza a llover.",
                    condition: (data) => !data.hasUmbrella, // <-- ¬°NUEVO! Solo si NO tienes paraguas
                    characterDialog: "¬°Oh no, lluvia! ¬°Odio mojarme! Cerca hay una tienda...",
                    sceneChange: { backgroundColor: '#708090' },
                    choices: [
                        { text: "Comprar paraguas (50 monedas)", action: "buy_umbrella" },
                        { text: "No importa, seguir andando", action: "ignore_rain" }
                    ],
                    consequences: {
                        buy_umbrella: (data) => {
                            if (data.coins >= 50) {
                                data.hasUmbrella = true; // <-- ¬°NUEVO! Marcamos que ya lo tiene
                                data.coins -= 50;
                                data.karma = Math.min(10, (data.karma || 0) + 1); // Peque√±a buena acci√≥n (previsi√≥n)
                                updateWalkCoins(-50);
                                data.aburrimiento = Math.max(0, data.aburrimiento - 1.5);
                                return { description: "Con el paraguas nuevo, la lluvia ya no es un problema.", characterDialog: "¬°Menos mal! Ahora puedo seguir disfrutando." };
                            } else {
                                data.higiene = Math.min(10, data.higiene + 1.5);
                                data.aburrimiento = Math.min(10, data.aburrimiento + 1);
                                return { description: "No tienes suficiente dinero. Te est√°s empapando.", characterDialog: "¬°Buah, qu√© mala suerte! Estoy calado hasta los huesos." };
                            }
                        },
                        ignore_rain: (data) => {
                            data.higiene = Math.min(10, data.higiene + 2);
                            data.aburrimiento = Math.min(10, data.aburrimiento + 0.5);
                            return { description: "Decides ignorar la lluvia y seguir tu camino.", characterDialog: "Brrr, ¬°qu√© fr√≠o! Y qu√© sucio me estoy poniendo." };
                        }
                    }
                },
                // --- ¬°NUEVO EVENTO! ---
                {
                    id: "rain_with_umbrella_event",
                    description: "Empieza a llover, pero por suerte llevas tu paraguas.",
                    condition: (data) => data.hasUmbrella, // <-- ¬°NUEVO! Solo si S√ç tienes paraguas
                    characterDialog: "¬°Menos mal que fui previsor! Ahora puedo disfrutar del sonido de la lluvia.",
                    sceneChange: { backgroundColor: '#708090' },
                    consequences: {
                        proceed: (data) => {
                            data.aburrimiento = Math.max(0, data.aburrimiento - 1.5); // Baja el aburrimiento
                            return { description: "Abres tu paraguas y sigues el paseo tranquilamente, escuchando las gotas caer.", characterDialog: "¬°Me encanta este sonido! Es muy relajante." };
                        }
                    }
                },
                {
                    id: "ice_cream_truck",
                    description: "¬°Un cami√≥n de helados! La m√∫sica suena alegremente y huele a dulce.",
                    characterDialog: "¬°Helado! ¬°Quiero uno, porfa, porfa, porfa! ¬øMe compras uno?",
                    choices: [
                        { text: "Claro, elige uno (30 monedas)", action: "buy_ice_cream" },
                        { text: "No, es demasiado az√∫car", action: "refuse_ice_cream" }
                    ],
                    consequences: {
                        buy_ice_cream: (data) => {
                            if (data.coins >= 30) {
                                data.coins -= 30;
                                // Comprar un helado no tiene un gran impacto k√°rmico, es neutral.
                                updateWalkCoins(-30);
                                data.aburrimiento = Math.max(0, data.aburrimiento - 2);
                                data.hambre = Math.max(0, data.hambre - 0.5);
                                return { description: "Disfrut√°is de un delicioso helado bajo el sol.", characterDialog: "¬°Yummy! ¬°El mejor paseo de la historia!" };
                            } else {
                                data.aburrimiento = Math.min(10, data.aburrimiento + 0.5);
                                return { description: "Miras tu cartera... no hay suficiente dinero.", characterDialog: "Oh... bueno, no pasa nada. Otro d√≠a ser√°." };
                            }
                        },
                        refuse_ice_cream: (data) => {
                            data.aburrimiento = Math.min(10, data.aburrimiento + 0.5);
                            return { description: "Le explicas que no es bueno tomar tanto dulce y segu√≠s andando.", characterDialog: "Jo... pero es que apetec√≠a mucho..." };
                        }
                    }
                },
                {
                    id: "lost_puppy",
                    description: "Ves un peque√±o cachorro perdido, lloriqueando en una esquina.",
                    characterDialog: "¬°Oh, pobrecito! Parece asustado. ¬øQu√© hacemos?",
                    choices: [
                        { text: "Intentar calmarlo y buscar a su due√±o", action: "help_puppy" },
                        { text: "Ignorarlo y seguir andando", action: "ignore_puppy" }
                    ],
                    consequences: {
                        help_puppy: (data) => {
                            data.coins += 20;
                            data.karma = Math.min(10, (data.karma || 0) + 2); // Buena acci√≥n
                            updateWalkCoins(20);
                            data.aburrimiento = Math.max(0, data.aburrimiento - 1.5);
                            return { description: "Tras un rato buscando, encuentras a su due√±a, que te da una peque√±a recompensa. ¬°Qu√© buena acci√≥n!", characterDialog: "¬°Me alegro de haber ayudado! Y adem√°s, ¬°monedas!" };
                        },
                        ignore_puppy: (data) => {
                            data.karma = Math.max(-10, (data.karma || 0) - 1); // Peque√±a mala acci√≥n
                            data.aburrimiento = Math.min(10, data.aburrimiento + 1);
                            return { description: "Decides seguir tu camino, dejando al cachorro atr√°s.", characterDialog: "Espero que alguien lo ayude... Me siento un poco mal." };
                        }
                    }
                },
                {
                    id: "lost_wallet",
                    description: "En el suelo, ves una cartera de cuero bastante abultada.",
                    characterDialog: "¬°Mira! ¬°Alguien ha perdido su cartera! ¬øLa cogemos?",
                    choices: [
                        { text: "Cogerla y llevarla a la polic√≠a", action: "return_wallet" },
                        { text: "Coger el dinero y dejar la cartera", action: "steal_money" },
                        { text: "Dejarla donde est√°", action: "ignore_wallet" }
                    ],
                    consequences: {
                        return_wallet: (data) => {
                            data.coins += 50;
                            data.karma = Math.min(10, (data.karma || 0) + 3); // Gran buena acci√≥n
                            updateWalkCoins(50);
                            data.aburrimiento = Math.max(0, data.aburrimiento - 0.5);
                            return { description: "Llev√°is la cartera a la comisar√≠a. El due√±o aparece y os da una recompensa por vuestra honestidad.", characterDialog: "¬°Hacer lo correcto tiene premio!" };
                        },
                        steal_money: (data) => {
                            data.coins += 200;
                            data.karma = Math.max(-10, (data.karma || 0) - 4); // Gran mala acci√≥n
                            updateWalkCoins(200);
                            data.aburrimiento = Math.min(10, data.aburrimiento + 1.5);
                            return { description: "Miras a ambos lados, coges el dinero y dejas la cartera. No hab√≠a nadie.", characterDialog: "¬°Cu√°ntas monedas! Pero... no me siento del todo bien." };
                        },
                        ignore_wallet: (data) => {
                            // Ignorar no es bueno ni malo en este caso.
                            return { description: "Decides que no es asunto tuyo y sigues caminando.", characterDialog: "Mejor no buscarse problemas. Sigamos." };
                        }
                    }
                },
                {
                    id: "street_performer",
                    description: "Un m√∫sico callejero toca una melod√≠a preciosa con su guitarra.",
                    characterDialog: "¬°Qu√© bien suena! ¬øNos quedamos un rato a escuchar?",
                    choices: [
                        { text: "S√≠, y darle una propina (10 monedas)", action: "tip_musician" },
                        { text: "Escuchar un poco y seguir", action: "listen_briefly" },
                        { text: "No tenemos tiempo para esto", action: "ignore_musician" }
                    ],
                    consequences: {
                        tip_musician: (data) => {
                            if (data.coins >= 10) {
                                data.coins -= 10;
                                data.karma = Math.min(10, (data.karma || 0) + 1); // Peque√±a buena acci√≥n
                                updateWalkCoins(-10);
                                data.aburrimiento = Math.max(0, data.aburrimiento - 2.5);
                                return { description: "Disfrut√°is de la m√∫sica y le dejas una propina. El m√∫sico os sonr√≠e agradecido.", characterDialog: "¬°Ha sido m√°gico! ¬°Me siento superrelajado!" };
                            } else {
                                data.aburrimiento = Math.max(0, data.aburrimiento - 1.5);
                                return { description: "Te gustar√≠a darle propina, pero no tienes monedas. Aun as√≠, disfrut√°is de la canci√≥n.", characterDialog: "¬°Qu√© bonito! L√°stima no tener dinero para darle." };
                            }
                        },
                        listen_briefly: (data) => {
                            data.aburrimiento = Math.max(0, data.aburrimiento - 1.5);
                            return { description: "Os par√°is un momento a disfrutar de la melod√≠a antes de continuar vuestro paseo.", characterDialog: "Me ha gustado mucho. ¬°Continuemos!" };
                        },
                        ignore_musician: (data) => {
                            data.karma = Math.max(-10, (data.karma || 0) - 1); // Peque√±a mala acci√≥n (ser un poco borde)
                            data.aburrimiento = Math.min(10, data.aburrimiento + 0.5);
                            return { description: "Decides que no es momento para conciertos y sigues de largo.", characterDialog: "Vaya... bueno, a lo nuestro." };
                        }
                    }
                },
                {
                    id: "puddle_splash",
                    description: "Un coche pasa a toda velocidad y os salpica con un charco.",
                    characterDialog: "¬°Agggh! ¬°Estoy todo sucio y mojado! ¬°Qu√© asco!",
                    choices: [
                        { text: "Volver a casa a limpiarse", action: "go_home" },
                        { text: "Secarse un poco y continuar", action: "continue_dirty" }
                    ],
                    consequences: {
                        go_home: (data, endWalkFn) => {
                            data.higiene = Math.min(10, data.higiene + 2.5);
                            endWalkFn(true);
                            return { description: "Decid√≠s que es mejor volver a casa para una buena ducha.", characterDialog: "¬°Se acab√≥ el paseo por hoy! Necesito un ba√±o." };
                        },
                        continue_dirty: (data) => {
                            data.higiene = Math.min(10, data.higiene + 1.5);
                            data.aburrimiento = Math.min(10, data.aburrimiento + 0.5);
                            return { description: "Usas un pa√±uelo para secarlo un poco, pero sigue bastante sucio.", characterDialog: "Ugh, me siento pegajoso. Ya no disfruto tanto del paseo." };
                        }
                    }
                },
                {
                    id: "find_coin",
                    description: "¬°Brilla algo en el suelo! Es una moneda.",
                    characterDialog: "¬°Ooh, dinero gratis!",
                    consequences: {
                        proceed: (data) => {
                            data.coins += 5;
                            updateWalkCoins(5);
                            return { description: "La recoges y la guardas en tu bolsillo. No es mucho, pero todo suma.", characterDialog: "¬°D√≠a de suerte!" };
                        }
                    }
                },
                {
                    id: "beautiful_sunset",
                    description: "El sol comienza a ponerse, ti√±endo el cielo de colores naranjas y rosas.",
                    characterDialog: "¬°Wow, mira qu√© atardecer! Es precioso...",
                    sceneChange: { backgroundColor: '#FFB6C1' }, /* Rosa claro */
                    consequences: {
                        proceed: (data) => {
                            data.aburrimiento = Math.max(0, data.aburrimiento - 1);
                            return { description: "Os par√°is un momento en silencio, simplemente admirando la vista.", characterDialog: "Momentos as√≠ hacen que todo valga la pena." };
                        }
                    }
                },
                {
                    id: "friendly_cat",
                    description: "Un gato amigable se acerca y se frota contra tus piernas, ronroneando.",
                    characterDialog: "¬°Hola, gatito! ¬°Qu√© suave eres!",
                    consequences: {
                        proceed: (data) => {
                            data.aburrimiento = Math.max(0, data.aburrimiento - 1.5);
                            return { description: "Le das unas caricias al gato antes de que siga su camino.", characterDialog: "¬°Me encantan los animales! Me ha alegrado el d√≠a." };
                        }
                    }
                },
                {
                    id: "smell_bakery",
                    description: "Pas√°is por delante de una panader√≠a y un delicioso olor a pan reci√©n hecho inunda el aire.",
                    characterDialog: "Mmmm, ¬°qu√© bien huele! De repente me ha entrado un poco de hambre.",
                    consequences: {
                        proceed: (data) => {
                            data.hambre = Math.min(10, data.hambre + 0.5);
                            return { description: "El olor es tentador, pero decid√≠s seguir con vuestro paseo.", characterDialog: "Me comeria una barra entera ahora mismo." };
                        }
                    }
                },
                {
                    id: "kids_playing",
                    description: "Veis a un grupo de ni√±os jugando alegremente en un parque.",
                    characterDialog: "¬°Mira c√≥mo se divierten! Me recuerdan a cuando yo era peque√±o.",
                    consequences: {
                        proceed: (data) => {
                            data.aburrimiento = Math.max(0, data.aburrimiento - 0.5);
                            return { description: "La risa de los ni√±os es contagiosa y os saca una sonrisa.", characterDialog: "La vida es para jugar y ser feliz." };
                        }
                    }
                },
                {
                    id: "nice_breeze",
                    description: "Una suave y fresca brisa sopla, aliviando el calor del d√≠a.",
                    characterDialog: "Ahhh, qu√© maravilla de brisa. Se est√° genial.",
                    consequences: {
                        proceed: (data) => {
                            data.aburrimiento = Math.max(0, data.aburrimiento - 0.5);
                            return { description: "Cierras los ojos un instante para disfrutar del momento.", characterDialog: "¬°Esto es vida!" };
                        }
                    }
                },
                {
                    id: "airplane_sky",
                    description: "Un avi√≥n surca el cielo, dejando una estela blanca a su paso.",
                    characterDialog: "¬øA d√≥nde ir√°? Me pregunto qu√© se sentir√° al volar tan alto.",
                    consequences: {
                        proceed: (data) => {
                            return { description: "Segu√≠s al avi√≥n con la mirada hasta que desaparece en la distancia.", characterDialog: "Alg√∫n d√≠a me gustar√≠a viajar por todo el mundo." };
                        }
                    }
                },
                {
                    id: "flower_garden",
                    description: "Pas√°is junto a un jard√≠n lleno de flores de todos los colores. El aroma es embriagador.",
                    characterDialog: "¬°Cu√°ntas flores! ¬°Y qu√© bien huelen!",
                    consequences: {
                        proceed: (data) => {
                            data.aburrimiento = Math.max(0, data.aburrimiento - 0.5);
                            return { description: "Os deten√©is un momento para admirar la belleza y el perfume de las flores.", characterDialog: "La naturaleza es incre√≠ble." };
                        }
                    }
                },
                {
                    id: "sudden_trip",
                    description: "¬°Cuidado! Tropiezas con una baldosa suelta, pero consigues mantener el equilibrio.",
                    characterDialog: "¬°Uf, por los pelos! Casi me caigo de bruces.",
                    consequences: {
                        proceed: (data) => {
                            data.higiene = Math.min(10, data.higiene + 0.5);
                            return { description: "Te sacudes el polvo de las manos y sigues con m√°s cuidado.", characterDialog: "Hay que mirar por d√≥nde se pisa." };
                        }
                    }
                },
                // --- EVENTOS NUEVOS ---
                {
                    id: "bully_event",
                    description: "Ves a un Tamagotchi grande molestando a uno m√°s peque√±o.",
                    characterDialog: "¬°D√©jale en paz! O... ¬øquiz√°s deber√≠a unirme a √©l?",
                    choices: [
                        { text: "Intervenir y defender", action: "intervene" },
                        { text: "Unirte al mat√≥n", action: "join_bully" },
                        { text: "Ignorar la situaci√≥n", action: "ignore_bully" }
                    ],
                    consequences: {
                        intervene: (data) => {
                            data.karma = Math.min(10, (data.karma || 0) + 3);
                            if (Math.random() < 0.25) { // 25% de probabilidad de perder dinero
                                const lostCoins = Math.min(data.coins, 50);
                                data.coins -= lostCoins;
                                updateWalkCoins(-lostCoins);
                                return { description: "Intervienes y el mat√≥n se enfada. Tras un forcejeo, se va, pero te ha quitado algo de dinero.", characterDialog: "¬°Al menos el peque√±o est√° bien! Aunque mi cartera no tanto..." };
                            }
                            return { description: "Te enfrentas al mat√≥n y, sorprendentemente, se disculpa y se va. El peque√±o te lo agradece.", characterDialog: "¬°Nadie se mete con los d√©biles cuando yo estoy cerca!" };
                        },
                        join_bully: (data) => {
                            data.karma = Math.max(-10, (data.karma || 0) - 5);
                            data.coins += 30;
                            updateWalkCoins(30);
                            return { description: "Te unes al mat√≥n para re√≠rte del peque√±o. El mat√≥n te da unas monedas por tu 'lealtad'.", characterDialog: "Jeje... bueno, unas monedas son unas monedas." };
                        },
                        ignore_bully: (data) => {
                            data.karma = Math.max(-10, (data.karma || 0) - 2);
                            return { description: "Miras para otro lado y aceleras el paso. No es tu problema.", characterDialog: "Mejor no meterse en l√≠os. Espero que no le pase nada grave." };
                        }
                    }
                },
                {
                    id: "charity_donation",
                    description: "Un puesto de caridad pide donaciones para el refugio de Tamagotchis.",
                    characterDialog: "Parece una buena causa. ¬øDeber√≠amos ayudar?",
                    choices: [
                        { text: "Donar generosamente (100)", action: "donate_generous" },
                        { text: "Donar un poco (20)", action: "donate_small" },
                        { text: "Decir que no tienes dinero", action: "no_donate" }
                    ],
                    consequences: {
                        donate_generous: (data) => {
                            if (data.coins >= 100) {
                                data.coins -= 100;
                                updateWalkCoins(-100);
                                data.karma = Math.min(10, (data.karma || 0) + 4);
                                return { description: "Donas 100 monedas. El voluntario te lo agradece enormemente.", characterDialog: "¬°Me siento genial por haber ayudado tanto!" };
                            }
                            return { description: "Quieres donar, pero no tienes 100 monedas.", characterDialog: "¬°Oh! Quer√≠a ser m√°s generoso..." };
                        },
                        donate_small: (data) => {
                            if (data.coins >= 20) {
                                data.coins -= 20;
                                updateWalkCoins(-20);
                                data.karma = Math.min(10, (data.karma || 0) + 2);
                                return { description: "Donas 20 monedas. Todo ayuda.", characterDialog: "¬°Espero que sirva de algo!" };
                            }
                            return { description: "Ni siquiera tienes 20 monedas para donar.", characterDialog: "Qu√© verg√ºenza... no tengo nada." };
                        },
                        no_donate: (data) => {
                            return { description: "Pasas de largo del puesto de caridad.", characterDialog: "Hoy no me siento generoso." };
                        }
                    }
                },
                {
                    id: "dark_alley",
                    description: "Ves un callej√≥n oscuro que parece un atajo.",
                    characterDialog: "Podr√≠amos ahorrar tiempo por ah√≠... pero da un poco de miedo.",
                    choices: [
                        { text: "Tomar el atajo", action: "take_shortcut" },
                        { text: "Seguir por el camino principal", action: "main_road" }
                    ],
                    consequences: {
                        take_shortcut: (data) => {
                            if (Math.random() < 0.5) {
                                data.coins += 50;
                                updateWalkCoins(50);
                                return { description: "¬°Qu√© suerte! Encuentras 50 monedas en el suelo del callej√≥n.", characterDialog: "¬°Quien no arriesga, no gana!" };
                            }
                            data.aburrimiento = Math.min(10, data.aburrimiento + 1);
                            return { description: "Un ruido fuerte te asusta y sales corriendo del callej√≥n. No has ahorrado tiempo.", characterDialog: "¬°Ay, qu√© susto! ¬°Nunca m√°s!" };
                        },
                        main_road: (data) => {
                            return { description: "Decides que es mejor ir por lo seguro y sigues el camino iluminado.", characterDialog: "M√°s vale prevenir que curar." };
                        }
                    }
                },
                {
                    id: "verbal_fight",
                    description: "Alguien te empuja sin querer y te grita como si fuera tu culpa.",
                    characterDialog: "¬°Pero bueno! ¬°Qu√© modales! ¬øLe digo algo?",
                    choices: [
                        { text: "Disculparse para evitar problemas", action: "apologize" },
                        { text: "Responderle enfadado", action: "argue" },
                        { text: "Ignorarlo y seguir", action: "ignore_fight" }
                    ],
                    consequences: {
                        apologize: (data) => {
                            data.karma = Math.min(10, (data.karma || 0) + 1);
                            return { description: "Aunque no ha sido tu culpa, te disculpas. El otro Tamagotchi se calma y sigue su camino.", characterDialog: "No vale la pena discutir por estas cosas." };
                        },
                        argue: (data) => {
                            data.karma = Math.max(-10, (data.karma || 0) - 1);
                            data.aburrimiento = Math.min(10, data.aburrimiento + 1);
                            return { description: "Le respondes enfadado y empez√°is una discusi√≥n a gritos que no lleva a ninguna parte.", characterDialog: "¬°Qu√© rabia! ¬°Me ha fastidiado el paseo!" };
                        },
                        ignore_fight: (data) => {
                            return { description: "Respiras hondo, lo ignoras y sigues tu camino.", characterDialog: "No voy a dejar que un maleducado me arruine el d√≠a." };
                        }
                    }
                },
                {
                    id: "surprise_parade",
                    description: "De repente, un desfile lleno de m√∫sica y color aparece en la calle.",
                    characterDialog: "¬°Qu√© divertido! ¬°Me encanta la m√∫sica!",
                    consequences: {
                        proceed: (data) => {
                            data.aburrimiento = Math.max(0, data.aburrimiento - 2);
                            return { description: "Os qued√°is un rato viendo el desfile. ¬°Qu√© sorpresa tan agradable!", characterDialog: "¬°Esto s√≠ que es un buen paseo!" };
                        }
                    }
                },
                {
                    id: "bakery_smell",
                    description: "El delicioso olor de una pasteler√≠a cercana inunda el aire.",
                    characterDialog: "Mmmm... ¬°qu√© bien huele! Me ha entrado hambre.",
                    consequences: {
                        proceed: (data) => {
                            data.hambre = Math.min(10, data.hambre + 1);
                            return { description: "El olor es tan intenso que te ruge el est√≥mago.", characterDialog: "¬°Necesito comer algo, ya!" };
                        }
                    }
                },
                {
                    id: "bird_flock",
                    description: "Una gran bandada de p√°jaros levanta el vuelo a tu paso, creando un espect√°culo en el cielo.",
                    characterDialog: "¬°Wow! ¬°Cu√°ntos p√°jaros!",
                    consequences: {
                        proceed: (data) => {
                            data.aburrimiento = Math.max(0, data.aburrimiento - 0.5);
                            return { description: "El movimiento coordinado de los p√°jaros es hipn√≥tico.", characterDialog: "¬°Ha sido impresionante!" };
                        }
                    }
                },
                {
                    id: "muddy_puddle",
                    description: "No ves un charco de barro y metes la pata hasta el fondo.",
                    characterDialog: "¬°Puaj! ¬°Qu√© asco, estoy todo sucio!",
                    consequences: {
                        proceed: (data) => {
                            data.higiene = Math.min(10, data.higiene + 2);
                            return { description: "Te has llenado de barro. Definitivamente necesitas una ducha.", characterDialog: "¬°Genial, ahora huelo a tierra mojada!" };
                        }
                    }
                },
                {
                    id: "street_market",
                    description: "Os top√°is con un mercadillo lleno de puestos con antig√ºedades y curiosidades.",
                    characterDialog: "¬°Cu√°ntas cosas! Hay de todo... ¬øcompramos algo de recuerdo?",
                    choices: [
                        { text: "Comprar objeto misterioso (75)", action: "buy_common" },
                        { text: "Comprar objeto raro (300)", action: "buy_uncommon" },
                        { text: "Solo mirar y seguir", action: "just_look" }
                    ],
                    consequences: {
                        buy_common: (data) => {
                            if (data.coins >= 75) {
                                data.coins -= 75;
                                updateWalkCoins(-75);
                                const item = buyMercadilloObject(75);
                                return { description: `Compras un ${item.name} por 75 monedas.`, characterDialog: "¬°Qu√© chulo! Lo guardar√© en mi inventario." };
                            }
                            return { description: "Te encanta el objeto, pero no tienes 75 monedas.", characterDialog: "L√°stima, era muy bonito..." };
                        },
                        buy_uncommon: (data) => {
                            if (data.coins >= 300) {
                                data.coins -= 300;
                                updateWalkCoins(-300);
                                const item = buyMercadilloObject(300);
                                return { description: `Pagas 300 monedas por un ${item.name}.`, characterDialog: "¬°Espero que sea aut√©ntico!" };
                            }
                            return { description: "El objeto es demasiado caro. No puedes permit√≠rtelo.", characterDialog: "300 monedas... ¬°se han pasado un poco!" };
                        },
                        just_look: (data) => {
                            data.aburrimiento = Math.max(0, data.aburrimiento - 0.5);
                            return { description: "Dais una vuelta por el mercadillo sin comprar nada y continu√°is el paseo.", characterDialog: "Hab√≠a cosas interesantes, pero mejor ahorrar." };
                        }
                    }
                }
            ];

            function buyMercadilloObject(cost) {
              if (!tamagotchiData) return;

              let itemPool;
              if (cost === 75) {
                itemPool = mercadilloObjects.common;
              } else if (cost === 300) {
                // --- ¬°NUEVO! Comprobaci√≥n del truco secreto ---
                const cheatActive = sessionStorage.getItem('secretMercadilloCheat') === 'true';

                if (cheatActive) {
                  itemPool = mercadilloObjects.rare; // 100% de probabilidad si el truco est√° activo
                  sessionStorage.removeItem('secretMercadilloCheat'); // El truco se usa una vez
                } else if (Math.random() < 0.01) {
                  // 1% de probabilidad normal de obtener un objeto raro
                  itemPool = mercadilloObjects.rare;
                } else {
                  itemPool = mercadilloObjects.uncommon;
                }
              } else {
                return;
              }

              const randomItem = itemPool[Math.floor(Math.random() * itemPool.length)];

              walkMercadilloInventory.push(randomItem); // A√±ade al inventario temporal del paseo
              return randomItem;
            }

            // --- L√ìGICA DE INICIALIZACI√ìN ---
            function init() {
                try {
                    const data = localStorage.getItem('tamagotchiData');
                    if (!data) {
                        showError("No se encontraron datos del Tamagotchi.");
                        return;
                    }
                    tamagotchiData = JSON.parse(data);
                    if (!tamagotchiData.mercadilloInventory) {
                        tamagotchiData.mercadilloInventory = [];
                    }
                } catch (e) {
                    showError("Error al cargar los datos del Tamagotchi.");
                    return;
                }

                characterDisplay.innerHTML = `<pre>(\\_/)
( ^_^)
(>   <)</pre>`;
                walkCoinDisplay.classList.add('hidden');

                startWalkBtn.addEventListener("click", startWalk);
                exitBtn.addEventListener("click", () => endWalk(false));

                localStorage.removeItem('walkInProgress');
            }

            function updateWalkCoins(amount) {
                walkCoins += amount;
                const totalSign = walkCoins >= 0 ? '+' : '';
                walkCoinDisplay.textContent = `Paseo: ${totalSign}${walkCoins} ü™ô`;
            }

            function startWalk() {
                if (!tamagotchiData) return;
                
                localStorage.setItem('walkInProgress', 'true');
                walkInProgress = true;

                walkCoins = 0;
                walkMercadilloInventory = []; // Resetea el inventario temporal
                updateWalkCoins(0);
                walkCoinDisplay.classList.remove('hidden');

                // --- ¬°NUEVO! A√±adir clases para animaciones ---
                sceneContainer.classList.add("walking");
                characterDisplay.classList.add("walking");

                startWalkBtn.classList.add("hidden");
                exitBtn.classList.remove("hidden");
                eventDescription.textContent = "El paseo ha comenzado. A ver qu√© aventuras te esperan...";
                characterDialog.textContent = "";
                choicesContainer.innerHTML = '';

                scheduleNextEvent();
            }

            function scheduleNextEvent() {
                clearTimeout(eventTimeout);
                if (!walkInProgress) return;

                const delay = Math.random() * 5000 + 8000;
                eventTimeout = setTimeout(triggerRandomEvent, delay);
            }

            function triggerRandomEvent() {
                if (!walkInProgress) return;

                // --- MODIFICADO: Filtrar eventos seg√∫n las condiciones ---
                const availableEvents = walkEvents.filter(event => {
                    // Si el evento no tiene condici√≥n, siempre est√° disponible.
                    // Si tiene condici√≥n, se eval√∫a.
                    return !event.condition || event.condition(tamagotchiData);
                });

                const event = availableEvents[Math.floor(Math.random() * availableEvents.length)];
                currentEvent = event;

                eventDescription.textContent = event.description;
                characterDialog.textContent = event.characterDialog;
                // Se elimina el cambio de color de fondo para mantener el fondo din√°mico general.

                choicesContainer.innerHTML = '';

                if (event.choices) {
                    event.choices.forEach(choice => {
                        const btn = document.createElement('button');
                        btn.textContent = choice.text;
                        btn.className = 'choice-btn';
                        if (choice.action.includes('ignore') || choice.action.includes('refuse')) {
                            btn.classList.add('secondary');
                        }
                        btn.onclick = () => handleChoice(choice.action);
                        choicesContainer.appendChild(btn);
                    });
                } else {
                    // --- MODIFICADO: L√≥gica para eventos no interactivos ---
                    // 1. Guardamos una copia del estado ANTES de la consecuencia
                    const oldData = JSON.parse(JSON.stringify(tamagotchiData));

                    // 2. Ejecutamos la consecuencia del evento
                    const result = event.consequences.proceed(tamagotchiData);

                    // 3. Comparamos estados y mostramos los cambios en pantalla
                    compareAndShowChanges(oldData, tamagotchiData);

                    // 4. Comprobamos si alguna estad√≠stica ha llegado a un nivel cr√≠tico
                    checkCriticalStats();

                    // 5. Actualizamos el di√°logo
                    eventDescription.textContent = result.description;
                    characterDialog.textContent = result.characterDialog;

                    // 6. Programamos el siguiente evento
                    setTimeout(scheduleNextEvent, 3500);
                }
            }

            function handleChoice(action) {
                if (!currentEvent || !walkInProgress) return;

                choicesContainer.querySelectorAll('button').forEach(btn => btn.disabled = true);

                const consequence = currentEvent.consequences[action];

                // --- ¬°NUEVO! L√≥gica para mostrar cambios de stats ---
                // 1. Guardamos una copia del estado ANTES de la consecuencia
                const oldData = JSON.parse(JSON.stringify(tamagotchiData));

                if (consequence) {
                    const result = consequence(tamagotchiData, endWalk);
                    
                    // 2. Comparamos el estado nuevo con el viejo y mostramos los cambios
                    compareAndShowChanges(oldData, tamagotchiData);

                    // --- ¬°NUEVO! 3. Comprobamos si alguna estad√≠stica est√° en nivel cr√≠tico ---
                    checkCriticalStats();

                    if (walkInProgress) {
                        eventDescription.textContent = result.description;
                        characterDialog.textContent = result.characterDialog;
                        
                        setTimeout(() => {
                            choicesContainer.innerHTML = '';
                            scheduleNextEvent();
                        }, 3500);
                    }
                }
            }

            // --- ¬°NUEVO! Variable para controlar la posici√≥n de los indicadores ---
            let statChangeYOffset = 0;

            // --- ¬°NUEVA FUNCI√ìN! Para mostrar el texto flotante ---
            function showStatChange(text, type) {
                const statElement = document.createElement('div');
                statElement.textContent = text;
                statElement.className = `stat-change ${type}`;

                // --- MODIFICADO: Posicionamiento para evitar solapamiento ---
                // Alterna la posici√≥n horizontal y aumenta la vertical para cada nuevo indicador
                const horizontalPosition = (statChangeYOffset % 2 === 0) ? '25%' : '55%';
                statElement.style.left = horizontalPosition;
                statElement.style.top = `${50 + statChangeYOffset * 10}%`;
                statChangeYOffset++;

                statChangesContainer.appendChild(statElement);

                // Eliminar el elemento despu√©s de la animaci√≥n
                setTimeout(() => {
                    statElement.remove();
                }, 2500);

                // Resetea el offset vertical despu√©s de un tiempo para que no se vayan muy abajo
                setTimeout(() => {
                    statChangeYOffset = 0;
                }, 1000);
            }

            // --- ¬°NUEVA FUNCI√ìN! Para comparar estados y llamar a showStatChange ---
            function compareAndShowChanges(oldData, newData) {
                const changes = {
                    hambre: newData.hambre - oldData.hambre,
                    aburrimiento: newData.aburrimiento - oldData.aburrimiento,
                    higiene: newData.higiene - oldData.higiene,
                    sueno: newData.sueno - oldData.sueno,
                    karma: (newData.karma || 0) - (oldData.karma || 0),
                    coins: newData.coins - oldData.coins
                };

                // Mapeo de nombres para mostrar
                const statNames = {
                    hambre: "Hambre",
                    aburrimiento: "Aburrimiento",
                    higiene: "Higiene",
                    sueno: "Sue√±o",
                    karma: "Karma",
                    coins: "Monedas"
                };

                for (const stat in changes) {
                    const diff = changes[stat];
                    if (Math.abs(diff) > 0.01) { // Usamos un umbral peque√±o para evitar errores de flotantes
                        const sign = diff > 0 ? '+' : '';
                        const type = (stat === 'hambre' || stat === 'aburrimiento' || stat === 'higiene' || stat === 'sueno') 
                                     ? (diff > 0 ? 'negative' : 'positive')
                                     : (stat === 'coins')
                                     ? 'neutral'
                                     : (diff > 0 ? 'positive' : 'negative');
                        // Para monedas, no mostramos decimales
                        const valueString = (stat === 'coins') ? diff.toFixed(0) : diff.toFixed(1);
                        showStatChange(`${sign}${valueString} ${statNames[stat]}`, type);
                    }
                }
            }

            // --- ¬°NUEVA FUNCI√ìN! Para avisar de estados cr√≠ticos ---
            function checkCriticalStats() {
                const warningContainer = document.getElementById('critical-warning-container');
                if (!warningContainer || !tamagotchiData) return;

                const warnings = [];
                const threshold = 8.5;

                if (tamagotchiData.hambre >= threshold) warnings.push(`${tamagotchiData.nombre} tiene much√≠sima hambre.`);
                if (tamagotchiData.aburrimiento >= threshold) warnings.push(`${tamagotchiData.nombre} est√° extremadamente aburrido.`);
                if (tamagotchiData.higiene >= threshold) warnings.push(`${tamagotchiData.nombre} necesita una ducha urgentemente.`);
                if (tamagotchiData.sueno >= threshold) warnings.push(`${tamagotchiData.nombre} est√° a punto de desmayarse de sue√±o.`);

                if (warnings.length > 0) {
                    // Mostramos el primer aviso cr√≠tico.
                    warningContainer.textContent = `${warnings[0]} ¬°Deber√≠as volver a casa!`;
                    warningContainer.style.display = 'block';
                    // Desactivamos la aparici√≥n de nuevos eventos para no empeorar la situaci√≥n
                    clearTimeout(eventTimeout);
                    choicesContainer.innerHTML = '<p style="text-align: center; font-weight: bold;">No puedes continuar el paseo en este estado.</p>';
                } else {
                    // Si no hay avisos, nos aseguramos de que el contenedor est√© oculto.
                    warningContainer.style.display = 'none';
                }
            }


            function endWalk(forced = false) {
                localStorage.removeItem('walkInProgress');
                walkInProgress = false;
                clearTimeout(eventTimeout);

                // --- ¬°NUEVO! Eliminar clases de animaci√≥n ---
                sceneContainer.classList.remove("walking");
                characterDisplay.classList.remove("walking");

                choicesContainer.innerHTML = '';
                walkCoinDisplay.classList.add('hidden');

                if (forced) {
                    localStorage.setItem('tamagotchiData', JSON.stringify(tamagotchiData));
                    localStorage.setItem('walkGameResult', 'finished');
                    window.location.href = "index.html";
                    return;
                }

                // --- ¬°NUEVA L√ìGICA DE KARMA AL FINALIZAR! ---
                if (tamagotchiData && tamagotchiData.karma < 0) {
                    // Evento de ladr√≥n por karma negativo
                    exitBtn.classList.add('hidden');
                    eventDescription.textContent = "De camino a casa, por una calle poco iluminada, un extra√±o te detiene...";
                    characterDialog.textContent = '"¬°Esto es un atraco! ¬°Dame todo lo que tienes!"';
                    
                    // El ladr√≥n te roba las monedas que has conseguido durante el paseo.
                    // Simplemente revertimos las ganancias/p√©rdidas del paseo.
                    tamagotchiData.coins -= walkCoins;
                    // Los objetos del mercadillo (walkMercadilloInventory) no se a√±aden, as√≠ que se pierden.

                    setTimeout(() => {
                        localStorage.setItem('tamagotchiData', JSON.stringify(tamagotchiData));
                        localStorage.setItem('walkGameResult', 'finished');
                        window.location.href = "index.html";
                    }, 4000);

                } else {
                    // Final normal, con karma bueno o neutral
                    exitBtn.classList.add('hidden');
                    eventDescription.textContent = "Decides que es hora de volver. El camino de vuelta a casa es tranquilo.";
                    characterDialog.textContent = "¬°Qu√© buen paseo! Ya tengo ganas de descansar en casa.";
                    // A√±adir los objetos del mercadillo al inventario principal
                    tamagotchiData.mercadilloInventory.push(...walkMercadilloInventory);
                    localStorage.setItem('tamagotchiData', JSON.stringify(tamagotchiData));
                    localStorage.setItem('walkGameResult', 'finished');
                    setTimeout(() => { window.location.href = "index.html"; }, 4000);
                }
            }

            function showError(message) {
                eventDescription.textContent = message;
                characterDialog.textContent = "Por favor, vuelve al men√∫ principal.";
                startWalkBtn.classList.add("hidden");
                exitBtn.classList.remove("hidden");
            }

            init();
        });
    </script>
</body>
</html>